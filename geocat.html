<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatZone v3.1 - NATCAT Risk Intelligence Platform</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            min-height: 100vh;
            color: var(--dark);
        }

        .header {
            background: rgba(255,255,255,0.98);
            padding: 1rem 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-menu {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            background: var(--light);
            color: var(--primary);
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .nav-link:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
        }

        .logo {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            max-width: 1800px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
        }

        .input-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .results-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 60, 114, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 2px solid #e5e7eb;
        }

        .risk-score-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            padding: 2rem;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
        }

        .risk-score {
            font-size: 4rem;
            font-weight: 900;
            margin: 1rem 0;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .data-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .data-card h3 {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .data-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }

        .data-card .label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .hazard-layers {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .hazard-layers h4 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--secondary);
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .layer-toggle:hover {
            background: #e5e7eb;
        }

        .layer-toggle input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        .layer-toggle label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .peril-analysis {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .peril-analysis h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--secondary);
        }

        .peril-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--light);
            border-radius: 6px;
        }

        .peril-item.component {
            background: #f0f9ff;
            border-left: 3px solid #0284c7;
            opacity: 0.9;
        }

        .peril-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .peril-score {
            font-weight: 700;
            font-size: 1.1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            color: white;
        }

        .score-low { background: #10b981; }
        .score-moderate { background: #f59e0b; }
        .score-high { background: #ef4444; }
        .score-extreme { background: #7c3aed; }

        .scs-composite {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .recommendations {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .recommendations h3 {
            color: #92400e;
            margin-bottom: 1rem;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .recommendations li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            font-weight: 700;
            color: #92400e;
        }

        .enhancement-section {
            background: #f0fdf4;
            border: 2px solid #10b981;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .enhancement-section h3 {
            color: #065f46;
            margin-bottom: 1rem;
        }

        .deductible-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .deductible-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #10b981;
        }

        .data-source-indicator {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-style: italic;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="logo">CatZone <span style="font-size: 0.5em; opacity: 0.7;">v3.1 FINAL</span></div>
            <div style="color: var(--secondary); font-weight: 600;">NATCAT Risk Intelligence Platform</div>
        </div>
        <div class="nav-menu">
            <a href="#" class="nav-link active" onclick="return false;">üè† Main Analysis</a>
            <a href="javascript:void(0)" class="nav-link" onclick="alert('Karst Map: Open karst_map.html separately')">üï≥Ô∏è Karst Map</a>
        </div>
    </div>

    <div class="container">
        <div class="input-panel">
            <h2 style="margin-bottom: 1.5rem;">Project Analysis</h2>
            
            <!-- API/Manual Mode Toggle -->
            <div style="background: #f0f9ff; border: 2px solid #0284c7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <h4 style="color: #0369a1; margin-bottom: 0.5rem; font-size: 0.9rem;">‚ö° Athenium Integration Mode</h4>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button class="mode-btn" id="manualMode" onclick="setDataMode('manual')" style="flex: 1; padding: 0.5rem; border: 2px solid var(--primary); background: white; color: var(--primary); border-radius: 6px; font-weight: 600; cursor: pointer;">Manual JSON</button>
                    <button class="mode-btn active" id="apiMode" onclick="setDataMode('api')" style="flex: 1; padding: 0.5rem; border: 2px solid var(--primary); background: var(--primary); color: white; border-radius: 6px; font-weight: 600; cursor: pointer;">API Ready</button>
                </div>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;" id="apiStatus">
                    API Mode: Ready for integration
                </div>
            </div>
            
            <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="projectName" placeholder="Enter project name">
            </div>

            <div class="form-group">
                <label>Address</label>
                <input type="text" id="address" placeholder="Enter full address">
                <button class="btn btn-secondary" onclick="geocodeAddress()" style="margin-top: 0.5rem;">Find Coordinates</button>
            </div>

            <div class="form-group">
                <label>Latitude</label>
                <input type="number" id="latitude" step="0.000001" placeholder="e.g., 34.9224">
            </div>

            <div class="form-group">
                <label>Longitude</label>
                <input type="number" id="longitude" step="0.000001" placeholder="e.g., -82.2425">
            </div>

            <div class="form-group">
                <label>Project Type</label>
                <select id="projectType">
                    <option value="commercial">Commercial Construction</option>
                    <option value="residential">Residential Construction</option>
                    <option value="infrastructure">Infrastructure</option>
                    <option value="bridge">Bridge Construction</option>
                    <option value="marine">Marine/Port Facility</option>
                    <option value="water">Water/Wastewater</option>
                    <option value="healthcare">Healthcare Facility</option>
                    <option value="industrial">Industrial Facility</option>
                </select>
            </div>

            <div class="form-group">
                <label>Construction Type</label>
                <select id="constructionType" onchange="toggleRenovationOptions()">
                    <option value="new">New Construction</option>
                    <option value="renovation">Renovation/Rehab</option>
                </select>
            </div>

            <div class="form-group" id="structuralComplexityGroup">
                <label>Structural Complexity</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="structuralWork" id="nonStructural" value="non-structural" checked style="width: auto; margin-right: 0.5rem;">
                        Non-Structural
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="structuralWork" id="structural" value="structural" style="width: auto; margin-right: 0.5rem;">
                        Structural Work
                    </label>
                </div>
                <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem;">
                    Structural: foundation, framing, load-bearing modifications, shoring
                </div>
            </div>

            <div class="form-group" id="activeOpsGroup">
                <label>Active Operations On-Site</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="activeOps" id="activeOpsNo" value="no" checked style="width: auto; margin-right: 0.5rem;">
                        No Active Operations
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; font-weight: normal;">
                        <input type="radio" name="activeOps" id="activeOpsYes" value="yes" style="width: auto; margin-right: 0.5rem;">
                        Active Operations
                    </label>
                </div>
                <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem;">
                    Does project involve construction within/adjacent to operating facility?
                </div>
            </div>

            <div class="form-group">
                <label>Project Value ($)</label>
                <input type="number" id="projectValue" placeholder="Enter total insured value">
            </div>

            <div class="form-group">
                <label>Construction Start Date</label>
                <input type="date" id="constructionStart">
            </div>

            <div class="form-group">
                <label>Construction End Date (Substantial Completion)</label>
                <input type="date" id="constructionEnd">
            </div>

            <div class="hazard-layers">
                <h4>Analysis Layers</h4>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerElevation" checked>
                    <label for="layerElevation">Elevation Analysis</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerFlood" checked>
                    <label for="layerFlood">Flood Risk</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerWeather" checked>
                    <label for="layerWeather">Weather Perils</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerEarthquake">
                    <label for="layerEarthquake">Earthquake (USGS)</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerWildfire">
                    <label for="layerWildfire">Wildfire Risk</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerKarst" checked>
                    <label for="layerKarst">Karst/Sinkhole Risk</label>
                </div>
            </div>

            <div class="form-group">
                <label>Athenium Data (Manual JSON)</label>
                <textarea id="atheniumData" placeholder="Paste JSON data from Claude/Athenium analysis"></textarea>
            </div>

            <button class="btn btn-primary" onclick="analyzeRisk()">Analyze Risk</button>
            <button class="btn btn-success" onclick="generateReport()">Generate Report</button>
            <button class="btn btn-secondary" onclick="resetForm()">Clear Form</button>
        </div>

        <div class="results-panel">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Analyzing risk factors across multiple data sources...</p>
            </div>

            <div id="results" style="display: none;">
                <div id="map"></div>
                
                <div class="risk-score-container">
                    <div style="font-size: 1.2rem; opacity: 0.9;">Composite Risk Score</div>
                    <div class="risk-score" id="riskScore">--</div>
                    <div id="riskCategory" style="font-size: 1rem;">--</div>
                    <div class="data-source-indicator" id="dataSource">Data sources loading...</div>
                </div>

                <div class="data-grid">
                    <div class="data-card">
                        <h3>ELEVATION</h3>
                        <div class="value" id="elevation">--</div>
                        <div class="label">feet above sea level</div>
                    </div>
                    
                    <div class="data-card">
                        <h3>FLOOD RISK</h3>
                        <div class="value" id="floodRisk">--</div>
                        <div class="label">Composite Score</div>
                    </div>
                    
                    <div class="data-card">
                        <h3>WIND RISK</h3>
                        <div class="value" id="windRisk">--</div>
                        <div class="label">Non-Hurricane</div>
                    </div>
                    
                    <div class="data-card">
                        <h3>HURRICANE</h3>
                        <div class="value" id="hurricaneRisk">--</div>
                        <div class="label">Risk Score</div>
                    </div>

                    <div class="data-card">
                        <h3>SCS COMPOSITE</h3>
                        <div class="value" id="scsRisk">--</div>
                        <div class="label">Severe Convective Storms</div>
                    </div>

                    <div class="data-card">
                        <h3>EARTHQUAKE</h3>
                        <div class="value" id="earthquakeRisk">--</div>
                        <div class="label">PGA Risk Level</div>
                    </div>

                    <div class="data-card">
                        <h3>WILDFIRE</h3>
                        <div class="value" id="wildfireRisk">--</div>
                        <div class="label">Risk Score</div>
                    </div>

                    <div class="data-card">
                        <h3>KARST/SINKHOLE</h3>
                        <div class="value" id="karstRisk">--</div>
                        <div class="label">Risk Score</div>
                    </div>
                </div>

                <div class="peril-analysis" id="perilAnalysis">
                    <h3>Detailed Peril Assessment</h3>
                </div>

                <div id="timelineAnalysis" class="enhancement-section" style="display: none;">
                    <h3>üìÖ Construction Timeline Analysis</h3>
                    <div id="timelineContent"></div>
                </div>

                <div id="deductibleRecommendations" class="enhancement-section" style="display: none;">
                    <h3>üí∞ Deductible Recommendations</h3>
                    <div id="deductibleContent" class="deductible-grid"></div>
                </div>

                <div id="premiumIndication" class="enhancement-section" style="display: none;">
                    <h3>üìä Premium Indication</h3>
                    <div id="premiumContent"></div>
                </div>

                <div id="lossControl" class="enhancement-section" style="display: none;">
                    <h3>üõ°Ô∏è Loss Control Recommendations</h3>
                    <ul id="lossControlContent"></ul>
                </div>

                <div class="recommendations">
                    <h3>Underwriting Recommendations</h3>
                    <ul id="recommendations">
                        <li>Loading recommendations...</li>
                    </ul>
                </div>

                <div style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openPrintView()" style="margin: 0; flex: 1; min-width: 200px;">Print Report (Best Quality)</button>
                    <button class="btn btn-secondary" onclick="exportJSON()" style="margin: 0; flex: 1; min-width: 200px;">Export JSON</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        let map = null;
        let marker = null;
        let globalRiskData = {};
        let dataMode = 'api';
        
        window.addEventListener('DOMContentLoaded', function() {
            console.log('CatZone v3.1 FINAL initialized');
            toggleRenovationOptions();
            setDataMode('api');
        });

        // ==================== API MODE MANAGEMENT ====================
        function setDataMode(mode) {
            dataMode = mode;
            
            const manualBtn = document.getElementById('manualMode');
            const apiBtn = document.getElementById('apiMode');
            const statusEl = document.getElementById('apiStatus');
            
            manualBtn.style.background = mode === 'manual' ? 'var(--primary)' : 'white';
            manualBtn.style.color = mode === 'manual' ? 'white' : 'var(--primary)';
            apiBtn.style.background = mode === 'api' ? 'var(--primary)' : 'white';
            apiBtn.style.color = mode === 'api' ? 'white' : 'var(--primary)';
            
            if (mode === 'manual') {
                statusEl.textContent = 'Manual JSON Mode Active';
            } else {
                statusEl.textContent = 'API Mode: Ready for integration';
            }
        }

        // ==================== FORM MANAGEMENT ====================
        function toggleRenovationOptions() {
            const constructionType = document.getElementById('constructionType').value;
            const isRenovation = constructionType === 'renovation';
            
            const structuralRadios = document.querySelectorAll('input[name="structuralWork"]');
            const activeOpsRadios = document.querySelectorAll('input[name="activeOps"]');
            
            const structuralGroup = document.getElementById('structuralComplexityGroup');
            const activeOpsGroup = document.getElementById('activeOpsGroup');
            
            if (isRenovation) {
                structuralRadios.forEach(radio => radio.disabled = false);
                activeOpsRadios.forEach(radio => radio.disabled = false);
                structuralGroup.style.opacity = '1';
                activeOpsGroup.style.opacity = '1';
            } else {
                structuralRadios.forEach(radio => {
                    radio.disabled = true;
                    if (radio.value === 'non-structural') radio.checked = true;
                });
                activeOpsRadios.forEach(radio => {
                    radio.disabled = true;
                    if (radio.value === 'no') radio.checked = true;
                });
                structuralGroup.style.opacity = '0.5';
                activeOpsGroup.style.opacity = '0.5';
            }
        }

        async function geocodeAddress() {
            const address = document.getElementById('address').value;
            if (!address) {
                alert('Please enter an address');
                return;
            }

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    document.getElementById('latitude').value = parseFloat(data[0].lat).toFixed(6);
                    document.getElementById('longitude').value = parseFloat(data[0].lon).toFixed(6);
                    alert('Coordinates found!');
                } else {
                    alert('Address not found. Please try a different format.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error finding coordinates. Please enter manually.');
            }
        }

        // ==================== MAIN ANALYSIS FUNCTION ====================
        async function analyzeRisk() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.classList.add('active');
            results.style.display = 'none';
            
            try {
                const lat = parseFloat(document.getElementById('latitude').value);
                const lon = parseFloat(document.getElementById('longitude').value);
                
                if (!lat || !lon) {
                    throw new Error('Please provide valid coordinates');
                }
                
                // Initialize map
                if (!map) {
                    map = L.map('map').setView([lat, lon], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map);
                } else {
                    map.setView([lat, lon], 13);
                    if (marker) map.removeLayer(marker);
                }
                
                marker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>${document.getElementById('projectName').value || 'Project Location'}</b><br>Lat: ${lat}<br>Lon: ${lon}`)
                    .openPopup();

                const dataSources = [];
                let elevationData = null;
                let atheniumData = null;
                let earthquakeData = null;
                let wildfireData = null;
                let karstData = null;

                // Gather data from selected layers
                if (document.getElementById('layerElevation').checked) {
                    elevationData = await getElevation(lat, lon);
                    if (elevationData !== null) dataSources.push('USGS Elevation');
                }

                const manualData = document.getElementById('atheniumData').value;
                if (manualData) {
                    try {
                        atheniumData = JSON.parse(manualData);
                        if (elevationData !== null) {
                            atheniumData.elevation = elevationData;
                        }
                        dataSources.push('Athenium NATCAT');
                    } catch (e) {
                        console.warn('Invalid Athenium JSON data:', e);
                    }
                }

                if (document.getElementById('layerEarthquake').checked) {
                    earthquakeData = await getEarthquakeRisk(lat, lon);
                    if (earthquakeData) dataSources.push('USGS Earthquake');
                }

                if (document.getElementById('layerWildfire').checked) {
                    wildfireData = estimateWildfireRisk(lat, lon, atheniumData);
                    if (wildfireData) dataSources.push('Athenium Wildfire');
                }

                if (document.getElementById('layerKarst').checked) {
                    karstData = assessKarstRisk(lat, lon);
                    if (karstData) dataSources.push('USGS Karst/Sinkhole');
                }
                
                // Calculate comprehensive risk
                const riskScore = calculateComprehensiveRisk(
                    elevationData, 
                    atheniumData, 
                    earthquakeData,
                    wildfireData,
                    karstData
                );
                globalRiskData = riskScore;
                
                document.getElementById('dataSource').textContent = 
                    `Data sources: ${dataSources.join(', ') || 'Manual input only'}`;
                
                updateResults(riskScore);
                
                loading.classList.remove('active');
                results.style.display = 'block';
                
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error('Analysis error:', error);
                alert(error.message);
                loading.classList.remove('active');
            }
        }

        // ==================== DATA FETCHING FUNCTIONS ====================
        async function getElevation(lat, lon) {
            try {
                const url = `https://epqs.nationalmap.gov/v1/json?x=${lon}&y=${lat}&units=Feet&output=json`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.value !== undefined && data.value !== null) {
                    return parseFloat(data.value);
                }
                return null;
            } catch (error) {
                console.error('Elevation fetch error:', error);
                return null;
            }
        }

        async function getEarthquakeRisk(lat, lon) {
            try {
                const url = `https://earthquake.usgs.gov/ws/designmaps/asce7-16.json?latitude=${lat}&longitude=${lon}&riskCategory=III&siteClass=D&title=CatZone`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.response && data.response.data) {
                    const pga = data.response.data.pga;
                    
                    let score, riskLevel;
                    if (pga >= 0.8) {
                        score = 10;
                        riskLevel = 'Extreme';
                    } else if (pga >= 0.6) {
                        score = 8;
                        riskLevel = 'High';
                    } else if (pga >= 0.5) {
                        score = 7;
                        riskLevel = 'High';
                    } else if (pga >= 0.4) {
                        score = 6;
                        riskLevel = 'Moderate-High';
                    } else if (pga >= 0.3) {
                        score = 5;
                        riskLevel = 'Moderate';
                    } else if (pga >= 0.2) {
                        score = 4;
                        riskLevel = 'Moderate-Low';
                    } else if (pga >= 0.1) {
                        score = 2;
                        riskLevel = 'Low';
                    } else {
                        score = 1;
                        riskLevel = 'Very Low';
                    }
                    
                    return {
                        pga: pga,
                        riskLevel: riskLevel,
                        score: score
                    };
                }
                return null;
            } catch (error) {
                console.error('Earthquake data fetch error:', error);
                return null;
            }
        }

        function estimateWildfireRisk(lat, lon, atheniumData) {
            if (atheniumData && atheniumData.wildfireScore !== undefined) {
                return {
                    score: atheniumData.wildfireScore,
                    riskLevel: atheniumData.wildfireScore >= 7 ? 'High' : 
                              atheniumData.wildfireScore >= 4 ? 'Moderate' : 'Low'
                };
            }
            return null;
        }

        function assessKarstRisk(lat, lon) {
            let score = 0;
            let riskLevel = 'Very Low';
            let details = [];
            
            const karstRegions = [
                { state: 'FL', name: 'Florida', baseScore: 8, lat: [24, 31], lon: [-87, -80], note: 'Extensive limestone, cover collapse sinkholes common statewide' },
                { state: 'TN', name: 'Tennessee', baseScore: 8, lat: [35, 37], lon: [-90, -82], note: 'Central basin karst - Nashville, Murfreesboro. Eastern Highland Rim active sinkhole development' },
                { state: 'KY', name: 'Kentucky', baseScore: 7, lat: [36.5, 39.1], lon: [-89.5, -82], note: 'Mammoth Cave region, extensive karst terrain in central/south-central KY' },
                { state: 'MO', name: 'Missouri', baseScore: 6, lat: [36, 38.5], lon: [-94.5, -90], note: 'Ozark Plateau karst - Springfield, Branson area' },
                { state: 'PA', name: 'Pennsylvania', baseScore: 6, lat: [39.7, 41.2], lon: [-80, -76], note: 'Appalachian karst belt - central/south-central PA' },
                { state: 'TX', name: 'Texas', baseScore: 5, lat: [29.5, 31.5], lon: [-101, -97.5], note: 'Edwards Plateau only - Austin, San Antonio area' },
                { state: 'IN', name: 'Indiana', baseScore: 5, lat: [37.8, 39.5], lon: [-87.5, -85.5], note: 'Southern Indiana karst belt - Mitchell plain' },
                { state: 'AL', name: 'Alabama', baseScore: 5, lat: [33, 35], lon: [-88, -85.5], note: 'Northern Alabama karst - Huntsville region' },
                { state: 'VA', name: 'Virginia', baseScore: 5, lat: [36.5, 39.5], lon: [-81.5, -78], note: 'Shenandoah Valley/Great Valley karst' },
                { state: 'WV', name: 'West Virginia', baseScore: 5, lat: [37.2, 40.6], lon: [-82, -78], note: 'Greenbrier Valley karst - eastern panhandle region' }
            ];
            
            for (const region of karstRegions) {
                if (lat >= region.lat[0] && lat <= region.lat[1] && 
                    lon >= region.lon[0] && lon <= region.lon[1]) {
                    score = region.baseScore;
                    details.push(`Located in ${region.name} karst region`);
                    details.push(region.note);
                    break;
                }
            }
            
            if (score > 0) {
                score += 1;
                details.push('Urban development may increase sinkhole risk');
            }
            
            if (score >= 8) {
                riskLevel = 'Extreme';
            } else if (score >= 6) {
                riskLevel = 'High';
            } else if (score >= 4) {
                riskLevel = 'Moderate';
            } else if (score >= 2) {
                riskLevel = 'Low';
            }
            
            return {
                score: Math.min(10, score),
                riskLevel: riskLevel,
                details: details,
                mapLink: score > 0
            };
        }

        // ==================== RISK CALCULATION ENGINE (FIXED) ====================
        function calculateComprehensiveRisk(elevation, atheniumData, earthquakeData, wildfireData, karstData) {
            let baseRisk = 30;
            const perils = {};
            
            // ELEVATION ADJUSTMENT
            if (elevation !== null) {
                if (elevation < 5) baseRisk += 15;
                else if (elevation < 10) baseRisk += 10;
                else if (elevation < 15) baseRisk += 5;
                else if (elevation > 50) baseRisk -= 5;
            }
            
            let maxPerilScore = 0;
            let perilCount = 0;
            let perilSum = 0;
            
            // ATHENIUM DATA PROCESSING - FIXED FIELD NAMES
            if (atheniumData) {
                // FLOOD - FLUVIAL
                if (atheniumData.fluvialRisk !== undefined || atheniumData.fluvial_risk !== undefined) {
                    const fluvial = atheniumData.fluvialRisk || atheniumData.fluvial_risk || 5;
                    const fluvialProb = atheniumData.fluvialProbability || atheniumData.fluvial_probability || fluvial * 10;
                    perils.fluvialFlood = { score: fluvial, probability: fluvialProb };
                    if (fluvial >= 8) baseRisk += 12;
                    else if (fluvial >= 6) baseRisk += 8;
                    else if (fluvial >= 4) baseRisk += 4;
                    maxPerilScore = Math.max(maxPerilScore, fluvial);
                    perilSum += fluvial;
                    perilCount++;
                }
                
                // FLOOD - PLUVIAL
                if (atheniumData.pluvialRisk !== undefined || atheniumData.pluvial_risk !== undefined) {
                    const pluvial = atheniumData.pluvialRisk || atheniumData.pluvial_risk || 5;
                    const pluvialProb = atheniumData.pluvialProbability || atheniumData.pluvial_probability || pluvial * 10;
                    perils.pluvialFlood = { score: pluvial, probability: pluvialProb };
                    if (pluvial >= 8) baseRisk += 12;
                    else if (pluvial >= 6) baseRisk += 8;
                    else if (pluvial >= 4) baseRisk += 4;
                    maxPerilScore = Math.max(maxPerilScore, pluvial);
                    perilSum += pluvial;
                    perilCount++;
                }
                
                // HURRICANE
                if (atheniumData.hurricaneWind !== undefined || atheniumData.hurricane_wind !== undefined || atheniumData.hurricane !== undefined) {
                    const hurricane = atheniumData.hurricaneWind || atheniumData.hurricane_wind || atheniumData.hurricane || 0;
                    const hurricaneProb = atheniumData.hurricaneProbability || atheniumData.hurricane_probability || hurricane * 10;
                    perils.hurricane = { score: hurricane, probability: hurricaneProb };
                    if (hurricane >= 8) baseRisk += 12;
                    else if (hurricane >= 6) baseRisk += 8;
                    else if (hurricane >= 4) baseRisk += 4;
                    maxPerilScore = Math.max(maxPerilScore, hurricane);
                    perilSum += hurricane;
                    perilCount++;
                }
                
                // RAINFALL
                if (atheniumData.rainfall !== undefined) {
                    const rainfall = atheniumData.rainfall;
                    const rainfallProb = atheniumData.rainfallProbability || atheniumData.rainfall_probability || rainfall * 10;
                    perils.rainfall = { score: rainfall, probability: rainfallProb };
                    if (rainfall >= 8) baseRisk += 8;
                    else if (rainfall >= 6) baseRisk += 5;
                    else if (rainfall >= 4) baseRisk += 2;
                    maxPerilScore = Math.max(maxPerilScore, rainfall);
                    perilSum += rainfall;
                    perilCount++;
                }
                
                // SCS COMPONENTS - Store but DON'T add to baseRisk yet
                let scsComponents = [];
                
                // TORNADO
                if (atheniumData.tornado !== undefined) {
                    const tornado = atheniumData.tornado;
                    const tornadoProb = atheniumData.tornadoProbability || atheniumData.tornado_probability || tornado * 10;
                    perils.tornado = { score: tornado, probability: tornadoProb };
                    scsComponents.push(tornado);
                }
                
                // HAIL
                if (atheniumData.hail !== undefined) {
                    const hail = atheniumData.hail;
                    const hailProb = atheniumData.hailProbability || atheniumData.hail_probability || hail * 10;
                    perils.hail = { score: hail, probability: hailProb };
                    scsComponents.push(hail);
                }
                
                // WIND (NON-HURRICANE)
                if (atheniumData.wind !== undefined) {
                    const wind = atheniumData.wind;
                    const windProb = atheniumData.windProbability || atheniumData.wind_probability || wind * 10;
                    perils.wind = { score: wind, probability: windProb };
                    scsComponents.push(wind);
                }
                
                // CALCULATE SCS COMPOSITE - Add to baseRisk ONCE
                if (scsComponents.length > 0) {
                    const scsComposite = scsComponents.reduce((sum, val) => sum + val, 0) / scsComponents.length;
                    perils.scs = { 
                        score: parseFloat(scsComposite.toFixed(2)), 
                        components: scsComponents.length,
                        detail: `Composite of ${scsComponents.length} SCS perils`
                    };
                    
                    // Add SCS composite to base risk ONCE (not individual components)
                    if (scsComposite >= 7) baseRisk += 8;
                    else if (scsComposite >= 5) baseRisk += 5;
                    else if (scsComposite >= 3) baseRisk += 2;
                    
                    maxPerilScore = Math.max(maxPerilScore, scsComposite);
                    perilSum += scsComposite;
                    perilCount++;
                }
            }
            
            // EARTHQUAKE
            let earthquakeScore = 0;
            if (earthquakeData) {
                earthquakeScore = earthquakeData.score;
                perils.earthquake = { 
                    score: earthquakeScore, 
                    pga: earthquakeData.pga,
                    level: earthquakeData.riskLevel
                };
                if (earthquakeScore >= 7) baseRisk += 8;
                else if (earthquakeScore >= 5) baseRisk += 4;
                maxPerilScore = Math.max(maxPerilScore, earthquakeScore);
                perilSum += earthquakeScore;
                perilCount++;
            }
            
            // WILDFIRE
            let wildfireScore = 0;
            if (wildfireData) {
                wildfireScore = wildfireData.score;
                perils.wildfire = { 
                    score: wildfireScore, 
                    level: wildfireData.riskLevel 
                };
                if (wildfireScore >= 7) baseRisk += 6;
                else if (wildfireScore >= 5) baseRisk += 3;
                maxPerilScore = Math.max(maxPerilScore, wildfireScore);
                perilSum += wildfireScore;
                perilCount++;
            }
            
            // KARST/SINKHOLE - CRITICAL FIX
            let karstScore = 0;
            if (karstData) {
                karstScore = karstData.score;
                perils.karst = {
                    score: karstScore,
                    level: karstData.riskLevel,
                    details: karstData.details || [],
                    mapLink: karstData.mapLink || false
                };
                if (karstScore >= 7) baseRisk += 8;
                else if (karstScore >= 5) baseRisk += 5;
                else if (karstScore >= 3) baseRisk += 2;
                maxPerilScore = Math.max(maxPerilScore, karstScore);
                perilSum += karstScore;
                perilCount++;
            }
            
            const avgPerilScore = perilCount > 0 ? perilSum / perilCount : 5;
            
            // PROJECT TYPE MULTIPLIERS
            const projectType = document.getElementById('projectType').value;
            const typeMultipliers = {
                'marine': 1.15,
                'bridge': 1.12,
                'water': 1.10,
                'infrastructure': 1.08,
                'healthcare': 1.05,
                'industrial': 1.03,
                'commercial': 1.0,
                'residential': 0.98
            };
            
            // CONSTRUCTION TYPE
            const constructionType = document.getElementById('constructionType').value;
            const constructionMultiplier = constructionType === 'new' ? 1.08 : 1.0;
            
            // STRUCTURAL WORK (Renovation only)
            const structuralWork = document.querySelector('input[name="structuralWork"]:checked').value === 'structural';
            const structuralMultiplier = structuralWork ? 1.15 : 1.0;
            
            // ACTIVE OPERATIONS (Renovation only)
            const activeOps = document.querySelector('input[name="activeOps"]:checked').value === 'yes';
            const activeOpsMultiplier = activeOps ? 1.25 : 1.0;
            
            // FINAL CALCULATION
            let finalScore = baseRisk * 
                (typeMultipliers[projectType] || 1.0) * 
                constructionMultiplier * 
                structuralMultiplier * 
                activeOpsMultiplier;
            
            // SCORE CAPS based on actual peril severity
            if (avgPerilScore < 4 && finalScore > 60) finalScore = 60;
            if (avgPerilScore < 5 && finalScore > 70) finalScore = 70;
            if (maxPerilScore < 7 && finalScore > 75) finalScore = 75;
            
            finalScore = Math.min(95, Math.max(5, finalScore));
            
            return {
                score: Math.round(finalScore),
                elevation: elevation,
                floodScore: Math.max(
                    perils.fluvialFlood?.score || 0, 
                    perils.pluvialFlood?.score || 0
                ) * 10,
                windRisk: perils.wind?.score || 0,
                hurricaneRisk: perils.hurricane?.score || 0,
                earthquakeRisk: earthquakeData?.riskLevel || 'N/A',
                earthquakeScore: earthquakeScore,
                wildfireScore: wildfireScore,
                karstScore: karstScore,
                scsScore: perils.scs?.score || 0,
                perils: perils,
                recommendations: generateRecommendations(finalScore, perils, atheniumData, constructionType, structuralWork, activeOps),
                timeline: analyzeConstructionTimeline(),
                deductibles: recommendDeductibles(finalScore, perils, parseInt(document.getElementById('projectValue').value) || 0),
                premium: calculatePremiumIndication(finalScore, parseInt(document.getElementById('projectValue').value) || 0, perils),
                lossControl: generateLossControlRecommendations(projectType, perils, constructionType, structuralWork, activeOps)
            };
        }

        // ==================== BUILDER'S RISK ENHANCEMENTS ====================
        function analyzeConstructionTimeline() {
            const startDate = document.getElementById('constructionStart').value;
            const endDate = document.getElementById('constructionEnd').value;
            
            if (!startDate || !endDate) return null;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const durationMonths = Math.round((end - start) / (1000 * 60 * 60 * 24 * 30));
            
            const seasons = {
                hurricane: { months: [6, 7, 8, 9, 10, 11], label: 'Hurricane Season' },
                tornado: { months: [3, 4, 5, 6], label: 'Tornado Season' },
                winter: { months: [12, 1, 2], label: 'Winter Storm Season' },
                wildfire: { months: [6, 7, 8, 9], label: 'Wildfire Season' }
            };
            
            const exposures = [];
            for (let d = new Date(start); d <= end; d.setMonth(d.getMonth() + 1)) {
                const month = d.getMonth() + 1;
                for (const [key, season] of Object.entries(seasons)) {
                    if (season.months.includes(month) && !exposures.includes(season.label)) {
                        exposures.push(season.label);
                    }
                }
            }
            
            return {
                durationMonths: durationMonths,
                seasonalExposures: exposures,
                criticalPeriods: exposures.length > 2 ? 'HIGH' : exposures.length > 0 ? 'MODERATE' : 'LOW'
            };
        }

        function recommendDeductibles(riskScore, perils, projectValue) {
            const recommendations = {};
            
            // FLOOD
            const floodMax = Math.max(perils.fluvialFlood?.score || 0, perils.pluvialFlood?.score || 0);
            if (floodMax >= 8) {
                recommendations.flood = {
                    amount: Math.max(250000, projectValue * 0.05),
                    percentage: '5-10%',
                    reasoning: 'EXTREME flood exposure requires significant deductible'
                };
            } else if (floodMax >= 6) {
                recommendations.flood = {
                    amount: Math.max(100000, projectValue * 0.03),
                    percentage: '3-5%',
                    reasoning: 'HIGH flood exposure warrants elevated deductible'
                };
            } else if (floodMax >= 4) {
                recommendations.flood = {
                    amount: 50000,
                    percentage: '1-2%',
                    reasoning: 'MODERATE flood exposure - standard deductible appropriate'
                };
            }
            
            // EARTHQUAKE
            if (perils.earthquake && perils.earthquake.score >= 7) {
                recommendations.earthquake = {
                    amount: Math.max(500000, projectValue * 0.05),
                    percentage: '5-10%',
                    reasoning: 'HIGH seismic risk requires substantial deductible'
                };
            } else if (perils.earthquake && perils.earthquake.score >= 5) {
                recommendations.earthquake = {
                    amount: Math.max(250000, projectValue * 0.03),
                    percentage: '3-5%',
                    reasoning: 'MODERATE seismic risk warrants earthquake deductible'
                };
            }
            
            // WIND/HURRICANE
            if (perils.hurricane && perils.hurricane.score >= 7) {
                recommendations.wind = {
                    amount: 'Percentage-based',
                    percentage: '5%',
                    reasoning: 'EXTREME hurricane exposure - 5% windstorm deductible mandatory'
                };
            } else if (perils.scs && perils.scs.score >= 6) {
                recommendations.wind = {
                    amount: 'Percentage-based',
                    percentage: '2-3%',
                    reasoning: 'HIGH SCS exposure - wind deductible appropriate'
                };
            }
            
            // KARST
            if (perils.karst && perils.karst.score >= 8) {
                recommendations.karst = {
                    amount: 'EXCLUSION RECOMMENDED',
                    percentage: 'N/A',
                    reasoning: 'EXTREME sinkhole risk - consider excluding or separate policy'
                };
            } else if (perils.karst && perils.karst.score >= 6) {
                recommendations.karst = {
                    amount: 250000,
                    percentage: 'N/A',
                    reasoning: 'HIGH karst risk - substantial sinkhole deductible required'
                };
            }
            
            return recommendations;
        }

        function calculatePremiumIndication(riskScore, projectValue, perils) {
            if (!projectValue) return null;
            
            let baseRate = 0.15;
            
            if (riskScore >= 75) baseRate *= 2.5;
            else if (riskScore >= 60) baseRate *= 1.8;
            else if (riskScore >= 45) baseRate *= 1.3;
            else if (riskScore < 30) baseRate *= 0.7;
            
            if (perils.hurricane && perils.hurricane.score >= 7) baseRate *= 1.4;
            if (perils.fluvialFlood && perils.fluvialFlood.score >= 8) baseRate *= 1.3;
            if (perils.karst && perils.karst.score >= 7) baseRate *= 1.25;
            if (perils.earthquake && perils.earthquake.score >= 7) baseRate *= 1.35;
            
            const basePremium = (projectValue / 100) * baseRate;
            const estimatedPremium = Math.round(basePremium / 100) * 100;
            
            return {
                indication: estimatedPremium,
                ratePerHundred: baseRate.toFixed(3),
                confidence: riskScore > 60 ? 'ROUGH ESTIMATE - Refer to underwriter' : 'INDICATIVE ONLY',
                components: {
                    base: (projectValue / 100) * 0.15,
                    riskAdjustment: basePremium - ((projectValue / 100) * 0.15)
                }
            };
        }

        function generateLossControlRecommendations(projectType, perils, constructionType, structuralWork, activeOps) {
            const lossControl = [];
            
            // PROJECT TYPE SPECIFIC
            if (projectType === 'marine') {
                lossControl.push('‚öì Marine Operations: 24/7 tide monitoring during construction');
                lossControl.push('‚öì Floating equipment: Comprehensive mooring/anchoring plan required');
                lossControl.push('‚öì Storm preparation: 48-hour advance mobilization protocol');
            }
            
            if (projectType === 'healthcare') {
                lossControl.push('üè• Healthcare: Hot work permits mandatory - oxygen/gas line proximity');
                lossControl.push('üè• Infection control: ICRA barriers and negative pressure zones');
                lossControl.push('üè• Life safety: Fire alarm system monitoring during construction');
            }
            
            if (projectType === 'water') {
                lossControl.push('üíß Water/Wastewater: Bypass pumping plan for service continuity');
                lossControl.push('üíß Confined space: Entry permits and atmospheric monitoring');
                lossControl.push('üíß Chemical storage: Secondary containment for treatment chemicals');
            }
            
            // RENOVATION SPECIFIC
            if (constructionType === 'renovation') {
                lossControl.push('üî® Renovation: Asbestos/lead survey before demolition');
                lossControl.push('üî® Existing structure protection: Dust barriers and HVAC isolation');
                
                if (structuralWork) {
                    lossControl.push('üèóÔ∏è STRUCTURAL WORK: PE-stamped shoring plans mandatory');
                    lossControl.push('üèóÔ∏è Daily monitoring during excavation/demo - collapse exposure elevated');
                    lossControl.push('üèóÔ∏è Temporary bracing inspection before load transfer');
                }
                
                if (activeOps) {
                    lossControl.push('‚ö†Ô∏è ACTIVE OPERATIONS: After-hours work preferred to minimize exposure');
                    lossControl.push('‚ö†Ô∏è Fire watch: Continuous during hot work within 35 feet of operations');
                    lossControl.push('‚ö†Ô∏è Contamination control: Sensitive areas require enhanced protocols');
                }
            }
            
            // PERIL-SPECIFIC
            if (perils.fluvialFlood && perils.fluvialFlood.score >= 6) {
                lossControl.push('üåä FLOOD: LAIIER water detection system - 24/7 monitoring');
                lossControl.push('üåä Flood barriers: Pre-positioned sandbags or HESCO barriers');
                lossControl.push('üåä Elevation: Critical materials/equipment storage above BFE');
            }
            
            if (perils.hurricane && perils.hurricane.score >= 6) {
                lossControl.push('üåÄ HURRICANE: 72-hour advance preparation protocol');
                lossControl.push('üåÄ Equipment tie-down: All cranes/lifts secured or de-mobilized');
                lossControl.push('üåÄ Temporary enclosures: Wind-rated or removable before landfall');
            }
            
            if (perils.karst && perils.karst.score >= 7) {
                lossControl.push('üï≥Ô∏è KARST: MANDATORY geotechnical survey with GPR');
                lossControl.push('üï≥Ô∏è Dewatering: Continuous monitoring - pumping can trigger collapse');
                lossControl.push('üï≥Ô∏è Subsidence monitoring: Quarterly inspections during/after construction');
            }
            
            if (perils.scs && perils.scs.score >= 6) {
                lossControl.push('‚ö° SCS: Severe weather monitoring service (e.g., WeatherOps)');
                lossControl.push('‚ö° Tornado protocol: Shelter-in-place plan with designated safe areas');
                lossControl.push('‚ö° Material securement: Loose items stored daily before shift end');
            }
            
            return lossControl;
        }

        function generateRecommendations(score, perils, atheniumData, constructionType, structuralWork, activeOps) {
            const recs = [];
            
            // BASE RECOMMENDATIONS BY SCORE
            if (score > 75) {
                recs.push('üî¥ HIGH RISK: Level 1-2 authority required. Enhanced coverage structure mandatory.');
                recs.push('üìä Weekly site inspections during high-exposure periods');
                recs.push('üí∞ Deductibles: 5-10% for CAT perils, $100K minimum for flood/earthquake');
            } else if (score > 50) {
                recs.push('üü° MODERATE RISK: Level 3-4 authority appropriate');
                recs.push('üìä Monthly inspections with quarterly risk reviews');
                recs.push('üí∞ Deductibles: 2-5% for CAT perils, standard for other perils');
            } else {
                recs.push('üü¢ LOW RISK: Competitive pricing available - Level 4-5 authority');
                recs.push('üìä Quarterly inspections sufficient');
                recs.push('üí∞ Deductibles: 1-2% for CAT perils');
            }
            
            // CONSTRUCTION TYPE WARNINGS
            if (structuralWork) {
                recs.push('üèóÔ∏è STRUCTURAL WORK: PE-stamped plans + daily monitoring mandatory');
                recs.push('‚ö†Ô∏è Collapse exposure elevated - verify contractor structural experience');
            }
            
            if (activeOps) {
                recs.push('‚ö†Ô∏è ACTIVE OPERATIONS: Consider excluding existing structure');
                recs.push('üî• Business interruption exposure - hot work permits + fire watch required');
            }
            
            // PERIL-SPECIFIC
            if (perils.hurricane && perils.hurricane.score >= 7) {
                recs.push('üåÄ HURRICANE EXTREME: 5% windstorm deductible + preparedness plan required');
            }
            
            if (perils.fluvialFlood && perils.fluvialFlood.score >= 8) {
                recs.push('üåä FLOOD EXTREME: 25-50% TIV sublimit, $100K minimum deductible');
                recs.push('üåä LAIIER water detection + flood mitigation plan MANDATORY');
            }
            
            if (perils.karst && perils.karst.score >= 8) {
                recs.push('üï≥Ô∏è KARST EXTREME: MANDATORY geotechnical survey with GPR');
                recs.push('üï≥Ô∏è RECOMMENDATION: Sinkhole exclusion OR separate ground stability policy');
                recs.push('üï≥Ô∏è If covered: $500K minimum deductible + annual monitoring');
                recs.push('üï≥Ô∏è ROI: $15K survey prevents $1.8M loss (Jenkins & Stiles UT case)');
            } else if (perils.karst && perils.karst.score >= 6) {
                recs.push('üï≥Ô∏è KARST HIGH: Geotechnical survey strongly recommended');
                recs.push('üï≥Ô∏è Sinkhole sublimit: 25-50% TIV with $250K deductible');
            }
            
            if (perils.scs && perils.scs.score >= 7) {
                recs.push('‚ö° SCS HIGH: Severe weather monitoring service required');
            }
            
            if (perils.earthquake && perils.earthquake.score >= 7) {
                recs.push('üìä EARTHQUAKE HIGH: 50% TIV sublimit with appropriate deductible');
            }
            
            if (atheniumData && atheniumData.elevation < 15) {
                recs.push('‚¨áÔ∏è LOW ELEVATION: Site within flood zone - FEMA map verification required');
            }
            
            return recs;
        }

        // ==================== RESULTS DISPLAY ====================
        function updateResults(riskData) {
            document.getElementById('riskScore').textContent = riskData.score;
            
            let category = 'LOW RISK';
            let color = '#10b981';
            
            if (riskData.score > 75) {
                category = 'HIGH RISK';
                color = '#ef4444';
            } else if (riskData.score > 60) {
                category = 'ELEVATED RISK';
                color = '#f59e0b';
            } else if (riskData.score > 45) {
                category = 'MODERATE RISK';
                color = '#3b82f6';
            }
            
            document.getElementById('riskCategory').textContent = category;
            document.querySelector('.risk-score-container').style.background = `linear-gradient(135deg, ${color}, ${color}dd)`;
            
            // Update data cards
            document.getElementById('elevation').textContent = riskData.elevation ? Math.round(riskData.elevation) : 'N/A';
            document.getElementById('floodRisk').textContent = Math.round(riskData.floodScore) + '%';
            document.getElementById('windRisk').textContent = riskData.windRisk ? riskData.windRisk.toFixed(1) + '/10' : 'N/A';
            document.getElementById('hurricaneRisk').textContent = riskData.hurricaneRisk ? riskData.hurricaneRisk.toFixed(1) + '/10' : 'N/A';
            document.getElementById('scsRisk').textContent = riskData.scsScore ? riskData.scsScore.toFixed(1) + '/10' : 'N/A';
            document.getElementById('earthquakeRisk').textContent = riskData.earthquakeRisk;
            document.getElementById('wildfireRisk').textContent = riskData.wildfireScore ? riskData.wildfireScore + '/10' : 'N/A';
            document.getElementById('karstRisk').textContent = riskData.karstScore ? riskData.karstScore + '/10' : 'N/A';
            
            // Detailed peril analysis
            const perilAnalysis = document.getElementById('perilAnalysis');
            perilAnalysis.innerHTML = '<h3>Detailed Peril Assessment</h3>';
            
            const perilDisplayOrder = [
                { key: 'hurricane', display: 'HURRICANE WIND', icon: 'üåÄ', type: 'individual' },
                { key: 'fluvialFlood', display: 'FLOOD - RIVER (FLUVIAL)', icon: 'üåä', type: 'individual' },
                { key: 'pluvialFlood', display: 'FLOOD - RAINFALL (PLUVIAL)', icon: 'üíß', type: 'individual' },
                { key: 'rainfall', display: 'RAINFALL ACCUMULATION', icon: 'üåßÔ∏è', type: 'individual' },
                { key: 'scs', display: 'SCS COMPOSITE (Tornado + Hail + Wind)', icon: '‚ö°', type: 'composite' },
                { key: 'tornado', display: 'Tornado (SCS Component)', icon: 'üå™Ô∏è', type: 'component' },
                { key: 'hail', display: 'Hail (SCS Component)', icon: 'üßä', type: 'component' },
                { key: 'wind', display: 'Wind - Non-Hurricane (SCS Component)', icon: 'üí®', type: 'component' },
                { key: 'earthquake', display: 'EARTHQUAKE', icon: 'üìä', type: 'individual' },
                { key: 'wildfire', display: 'WILDFIRE', icon: 'üî•', type: 'individual' },
                { key: 'karst', display: 'KARST / SINKHOLE', icon: 'üï≥Ô∏è', type: 'individual' }
            ];
            
            if (riskData.perils && Object.keys(riskData.perils).length > 0) {
                perilDisplayOrder.forEach(perilDef => {
                    const perilData = riskData.perils[perilDef.key];
                    if (perilData && perilData.score !== undefined) {
                        const perilItem = document.createElement('div');
                        perilItem.className = 'peril-item';
                        if (perilDef.type === 'component') {
                            perilItem.classList.add('component');
                        } else if (perilDef.type === 'composite') {
                            perilItem.style.cssText = 'background: #f0f9ff; border: 2px solid #0284c7; border-radius: 8px;';
                        }
                        
                        const score = perilData.score;
                        let scoreClass = 'score-low';
                        if (score >= 8) scoreClass = 'score-extreme';
                        else if (score >= 6) scoreClass = 'score-high';
                        else if (score >= 4) scoreClass = 'score-moderate';
                        
                        let detailText = '';
                        if (perilData.probability) {
                            detailText += `${perilData.probability.toFixed(1)}% annual probability`;
                        }
                        if (perilData.pga) {
                            detailText += detailText ? ' | ' : '';
                            detailText += `PGA: ${perilData.pga.toFixed(2)}g`;
                        }
                        if (perilData.level) {
                            detailText += detailText ? ' | ' : '';
                            detailText += `Level: ${perilData.level}`;
                        }
                        if (perilData.detail) {
                            detailText = perilData.detail;
                        }
                        if (perilDef.key === 'karst' && perilData.details && perilData.details.length > 0) {
                            detailText = perilData.details.join(' | ');
                        }
                        
                        perilItem.innerHTML = `
                            <div>
                                <div class="peril-name">${perilDef.icon} ${perilDef.display}</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">
                                    ${detailText || 'Score based on analysis'}
                                </div>
                            </div>
                            <div class="peril-score ${scoreClass}">${typeof score === 'number' ? score.toFixed(1) : score}/10</div>
                        `;
                        
                        perilAnalysis.appendChild(perilItem);
                    }
                });
            }
            
            // Timeline analysis
            if (riskData.timeline) {
                const timelineDiv = document.getElementById('timelineAnalysis');
                timelineDiv.style.display = 'block';
                document.getElementById('timelineContent').innerHTML = `
                    <p><strong>Duration:</strong> ${riskData.timeline.durationMonths} months</p>
                    <p><strong>Seasonal Exposures:</strong> ${riskData.timeline.seasonalExposures.join(', ') || 'None identified'}</p>
                    <p><strong>Risk Level:</strong> ${riskData.timeline.criticalPeriods}</p>
                `;
            }
            
            // Deductible recommendations
            if (riskData.deductibles && Object.keys(riskData.deductibles).length > 0) {
                const dedDiv = document.getElementById('deductibleRecommendations');
                dedDiv.style.display = 'block';
                const dedContent = document.getElementById('deductibleContent');
                dedContent.innerHTML = '';
                
                for (const [peril, rec] of Object.entries(riskData.deductibles)) {
                    const card = document.createElement('div');
                    card.className = 'deductible-card';
                    card.innerHTML = `
                        <h4 style="color: #065f46; margin-bottom: 0.5rem;">${peril.toUpperCase()}</h4>
                        <p><strong>Amount:</strong> ${typeof rec.amount === 'number' ? '$' + rec.amount.toLocaleString() : rec.amount}</p>
                        <p><strong>Percentage:</strong> ${rec.percentage}</p>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem;">${rec.reasoning}</p>
                    `;
                    dedContent.appendChild(card);
                }
            }
            
            // Premium indication
            if (riskData.premium) {
                const premDiv = document.getElementById('premiumIndication');
                premDiv.style.display = 'block';
                document.getElementById('premiumContent').innerHTML = `
                    <p><strong>Estimated Premium:</strong> $${riskData.premium.indication.toLocaleString()}</p>
                    <p><strong>Rate per $100:</strong> $${riskData.premium.ratePerHundred}</p>
                    <p><strong>Confidence:</strong> ${riskData.premium.confidence}</p>
                    <p style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem;">Base component: $${Math.round(riskData.premium.components.base).toLocaleString()} | Risk adjustment: $${Math.round(riskData.premium.components.riskAdjustment).toLocaleString()}</p>
                `;
            }
            
            // Loss control
            if (riskData.lossControl && riskData.lossControl.length > 0) {
                const lcDiv = document.getElementById('lossControl');
                lcDiv.style.display = 'block';
                const lcContent = document.getElementById('lossControlContent');
                lcContent.innerHTML = '';
                riskData.lossControl.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.style.cssText = 'padding: 0.5rem 0; padding-left: 1.5rem; position: relative;';
                    const arrow = document.createElement('span');
                    arrow.textContent = '‚Üí';
                    arrow.style.cssText = 'position: absolute; left: 0; font-weight: 700; color: #065f46;';
                    li.insertBefore(arrow, li.firstChild);
                    lcContent.appendChild(li);
                });
            }
            
            // Recommendations
            const recList = document.getElementById('recommendations');
            recList.innerHTML = '';
            riskData.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recList.appendChild(li);
            });
        }

        // ==================== EXPORT FUNCTIONS ====================
        function generateReport() {
            if (!globalRiskData.score) {
                alert('Please run analysis first');
                return;
            }
            
            alert('Report ready! Use Export JSON or Print Report buttons.');
        }

        function exportJSON() {
            if (!globalRiskData.score) {
                alert('Please run analysis first');
                return;
            }
            
            const exportData = {
                metadata: {
                    projectName: document.getElementById('projectName').value || 'Unnamed Project',
                    address: document.getElementById('address').value,
                    coordinates: {
                        latitude: parseFloat(document.getElementById('latitude').value),
                        longitude: parseFloat(document.getElementById('longitude').value)
                    },
                    projectType: document.getElementById('projectType').value,
                    constructionType: document.getElementById('constructionType').value,
                    projectValue: parseInt(document.getElementById('projectValue').value) || 0,
                    analysisDate: new Date().toISOString(),
                    platform: 'CatZone NATCAT Intelligence Platform v3.1 FINAL'
                },
                riskAssessment: globalRiskData,
                dataSources: document.getElementById('dataSource').textContent
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'CatZone_v3.1_Analysis_' + (exportData.metadata.projectName.replace(/[^a-z0-9]/gi, '_')) + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openPrintView() {
            if (!globalRiskData.score) {
                alert('Please run analysis first');
                return;
            }

            const printWindow = window.open('', '_blank', 'width=1200,height=900');
            const printContent = generatePrintHTML();
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function generatePrintHTML() {
            const projectName = document.getElementById('projectName').value || 'Unnamed Project';
            const address = document.getElementById('address').value || 'No address provided';
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const projectType = document.getElementById('projectType').value;
            const projectValue = parseInt(document.getElementById('projectValue').value) || 0;
            
            let riskColor = '#10b981';
            let riskCategory = 'LOW RISK';
            if (globalRiskData.score > 75) {
                riskColor = '#ef4444';
                riskCategory = 'HIGH RISK';
            } else if (globalRiskData.score > 60) {
                riskColor = '#f59e0b';
                riskCategory = 'ELEVATED RISK';
            } else if (globalRiskData.score > 45) {
                riskColor = '#3b82f6';
                riskCategory = 'MODERATE RISK';
            }

            let recsHTML = '';
            globalRiskData.recommendations.forEach(rec => {
                recsHTML += `<li style="padding: 8px 0; padding-left: 20px; position: relative;">
                    <span style="position: absolute; left: 0; color: #92400e; font-weight: 700;">‚Üí</span>
                    ${rec}
                </li>`;
            });

            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CatZone v3.1 Risk Assessment - ${projectName}</title>
    <style>
        @media print {
            body { margin: 0; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: white;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #1e3c72;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }

        .risk-score-box {
            background: linear-gradient(135deg, ${riskColor}, ${riskColor}dd);
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            margin: 24px 0;
        }

        .risk-score-value {
            font-size: 4rem;
            font-weight: 900;
            margin: 16px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #1e3c72;
        }

        .recommendations-box {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
        }

        .recommendations-box h3 {
            color: #92400e;
            margin-bottom: 16px;
        }

        .recommendations-box ul {
            list-style: none;
            padding: 0;
        }

        .print-button {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }
    </style>
</head>
<body>
    <button onclick="window.print()" class="print-button no-print">üñ®Ô∏è Print Report</button>

    <div class="header">
        <div class="logo">CatZone v3.1</div>
        <div style="color: #6b7280; font-size: 1rem;">NATCAT Risk Intelligence Platform</div>
        <div style="color: #9ca3af; font-size: 0.85rem; margin-top: 8px;">Generated: ${new Date().toLocaleString()}</div>
    </div>

    <div class="section">
        <h2 class="section-title">Project Information</h2>
        <div class="info-grid">
            <div class="info-item">
                <div style="font-size: 0.85rem; color: #6b7280;">Project Name</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${projectName}</div>
            </div>
            <div class="info-item">
                <div style="font-size: 0.85rem; color: #6b7280;">Project Type</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${projectType}</div>
            </div>
            <div class="info-item">
                <div style="font-size: 0.85rem; color: #6b7280;">Address</div>
                <div style="font-size: 1.1rem; font-weight: 600;">${address}</div>
            </div>
            <div class="info-item">
                <div style="font-size: 0.85rem; color: #6b7280;">Project Value</div>
                <div style="font-size: 1.1rem; font-weight: 600;">$${projectValue.toLocaleString()}</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Risk Assessment Summary</h2>
        
        <div class="risk-score-box">
            <div style="font-size: 1.2rem; opacity: 0.95;">Composite Risk Score</div>
            <div class="risk-score-value">${globalRiskData.score}</div>
            <div style="font-size: 1rem; font-weight: 600;">${riskCategory}</div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Underwriting Recommendations</h2>
        <div class="recommendations-box">
            <h3>Key Recommendations</h3>
            <ul>
                ${recsHTML}
            </ul>
        </div>
    </div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.85rem;">
        <strong>Platform:</strong> CatZone NATCAT Intelligence Platform v3.1 FINAL<br>
        <strong>Powered by:</strong> Athenium Climate Intelligence
    </div>
</body>
</html>
            `;
        }

        function resetForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('projectValue').value = '';
            document.getElementById('constructionStart').value = '';
            document.getElementById('constructionEnd').value = '';
            document.getElementById('atheniumData').value = '';
            document.getElementById('results').style.display = 'none';
            
            if (map && marker) {
                map.removeLayer(marker);
                marker = null;
            }
            
            globalRiskData = {};
        }
    </script>
</body>
</html>
