<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatZone Professional - NATCAT Risk Intelligence Platform</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            min-height: 100vh;
            color: var(--dark);
        }

        .header {
            background: rgba(255,255,255,0.98);
            padding: 1rem 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--success);
            color: white;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-indicator.offline {
            background: var(--danger);
        }

        .container {
            max-width: 1800px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
        }

        .input-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .results-panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 60, 114, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 2px solid #e5e7eb;
        }

        .risk-score-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            padding: 2rem;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .risk-score-container::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .risk-score {
            font-size: 4rem;
            font-weight: 900;
            margin: 1rem 0;
            position: relative;
            z-index: 1;
        }

        .risk-gauge {
            width: 100%;
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .risk-gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            border-radius: 15px;
            transition: width 1s ease-out;
        }

        .risk-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .risk-card {
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .risk-card h3 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .risk-card .value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .perils-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .peril-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
        }

        .peril-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .peril-card .peril-name {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .peril-card .peril-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark);
        }

        .peril-card .peril-risk {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: #f3f4f6;
        }

        .peril-card.high { border-color: var(--danger); }
        .peril-card.high .peril-risk { background: #fee2e2; color: var(--danger); }
        .peril-card.moderate { border-color: var(--warning); }
        .peril-card.moderate .peril-risk { background: #fed7aa; color: #ea580c; }
        .peril-card.low { border-color: var(--success); }
        .peril-card.low .peril-risk { background: #d1fae5; color: var(--success); }

        .recommendations {
            background: #f8fafc;
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .recommendations h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            padding-left: 1.5rem;
        }

        .recommendations li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .recommendations li:last-child {
            border-bottom: none;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">CatZone Professional</div>
        <div class="status-indicator">
            <span style="width: 8px; height: 8px; background: white; border-radius: 50%; display: inline-block;"></span>
            Athenium API Connected
        </div>
    </div>

    <div class="container">
        <div class="input-panel">
            <h2 style="margin-bottom: 1.5rem; color: var(--primary);">Project Details</h2>
            
            <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="projectName" placeholder="e.g., Austin Tech Campus Phase 2">
            </div>
            
            <div class="form-group">
                <label>Project Address</label>
                <input type="text" id="address" placeholder="Enter full address">
            </div>
            
            <div class="form-group">
                <label>Latitude</label>
                <input type="number" id="latitude" step="0.000001" placeholder="e.g., 30.2672">
            </div>
            
            <div class="form-group">
                <label>Longitude</label>
                <input type="number" id="longitude" step="0.000001" placeholder="e.g., -97.7431">
            </div>
            
            <div class="form-group">
                <label>Project Type</label>
                <select id="projectType">
                    <option value="commercial">Commercial</option>
                    <option value="residential">Residential</option>
                    <option value="multifamily">Multifamily</option>
                    <option value="industrial">Industrial</option>
                    <option value="infrastructure">Infrastructure</option>
                    <option value="bridge">Bridge/Tunnel</option>
                    <option value="marine">Marine Construction</option>
                    <option value="renewable">Renewable Energy</option>
                    <option value="water">Water/Wastewater</option>
                    <option value="data_center">Data Center</option>
                    <option value="healthcare">Healthcare</option>
                    <option value="education">Education</option>
                    <option value="hospitality">Hospitality</option>
                    <option value="retail">Retail</option>
                    <option value="warehouse">Warehouse/Distribution</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Construction Type</label>
                <select id="constructionType">
                    <option value="new">New Construction</option>
                    <option value="renovation">Renovation</option>
                    <option value="addition">Addition</option>
                    <option value="demolition">Demolition & Rebuild</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Total Project Value ($)</label>
                <input type="number" id="projectValue" placeholder="e.g., 25000000">
            </div>
            
            <div class="form-group">
                <label>Manual Data Input (JSON)</label>
                <textarea id="manualData" placeholder='Optional: Paste Athenium JSON response here'></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="analyzeRisk()">
                Analyze Risk
            </button>
            
            <button class="btn btn-secondary" onclick="resetForm()">
                Clear Form
            </button>
            
            <button class="btn btn-success" onclick="downloadJSON()">
                Export JSON
            </button>
            
            <button class="btn btn-secondary" onclick="printReport()">
                Print Report
            </button>
        </div>
        
        <div class="results-panel">
            <div id="results" style="display: none;">
                <div id="map"></div>
                
                <div class="risk-score-container">
                    <h2 style="font-size: 1rem; opacity: 0.9; margin-bottom: 0.5rem;">Combined Risk Score</h2>
                    <div class="risk-score" id="riskScore">--</div>
                    <div class="risk-gauge">
                        <div class="risk-gauge-fill" id="riskGauge"></div>
                    </div>
                    <div class="risk-details">
                        <div class="risk-card">
                            <h3>Risk Level</h3>
                            <div class="value" id="riskLevel">--</div>
                        </div>
                        <div class="risk-card">
                            <h3>Suggested Rate</h3>
                            <div class="value" id="suggestedRate">--%</div>
                        </div>
                        <div class="risk-card">
                            <h3>Primary Peril</h3>
                            <div class="value" id="primaryPeril">--</div>
                        </div>
                    </div>
                </div>
                
                <div class="perils-grid" id="perilsGrid"></div>
                
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
                
                <div class="recommendations" id="recommendations"></div>
                
                <div id="locationDetails" style="margin-top: 2rem; padding: 1rem; background: #f8fafc; border-radius: 8px;"></div>
            </div>
            
            <div id="initialMessage" style="text-align: center; padding: 4rem 2rem; color: #6b7280;">
                <h2 style="font-size: 2rem; margin-bottom: 1rem;">Welcome to CatZone Professional</h2>
                <p style="font-size: 1.1rem; margin-bottom: 2rem;">Enter project details to begin NATCAT risk analysis</p>
                <p style="font-size: 0.9rem;">Powered by Athenium Climate Intelligence</p>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        let map, marker;
        let globalRiskData = {};
        let riskChart;
        
        // Initialize map when page loads
        window.addEventListener('DOMContentLoaded', function() {
            document.getElementById('results').style.display = 'block';
            document.getElementById('initialMessage').style.display = 'none';
            
            map = L.map('map').setView([30.2672, -97.7431], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            document.getElementById('results').style.display = 'none';
            document.getElementById('initialMessage').style.display = 'block';
        });
        
        // Address input - update coordinates
        document.getElementById('address').addEventListener('blur', async function() {
            const address = this.value;
            if (address) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
                    const data = await response.json();
                    if (data && data[0]) {
                        document.getElementById('latitude').value = data[0].lat;
                        document.getElementById('longitude').value = data[0].lon;
                        updateMap(parseFloat(data[0].lat), parseFloat(data[0].lon));
                    }
                } catch (error) {
                    console.error('Geocoding error:', error);
                }
            }
        });
        
        // Update map when coordinates change
        document.getElementById('latitude').addEventListener('change', function() {
            const lat = parseFloat(this.value);
            const lon = parseFloat(document.getElementById('longitude').value);
            if (lat && lon) {
                updateMap(lat, lon);
            }
        });
        
        document.getElementById('longitude').addEventListener('change', function() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(this.value);
            if (lat && lon) {
                updateMap(lat, lon);
            }
        });
        
        function updateMap(lat, lon) {
            if (!map) return;
            
            if (marker) {
                map.removeLayer(marker);
            }
            
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon], 13);
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        async function analyzeRisk() {
            const lat = document.getElementById('latitude').value;
            const lon = document.getElementById('longitude').value;
            const manualData = document.getElementById('manualData').value;
            
            if (!manualData && (!lat || !lon)) {
                showNotification('Please enter coordinates or provide manual data', 'error');
                return;
            }
            
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const initialMessage = document.getElementById('initialMessage');
            
            loading.classList.add('active');
            initialMessage.style.display = 'none';
            
            try {
                let atheniumData;
                
                if (manualData) {
                    try {
                        atheniumData = JSON.parse(manualData);
                    } catch (e) {
                        throw new Error('Invalid JSON format in manual data');
                    }
                } else {
                    // Simulate Athenium API response
                    atheniumData = await simulateAtheniumAPI(lat, lon);
                }
                
                // Add risk overlay circles
                addRiskOverlays(lat, lon, atheniumData);
                
                // Calculate comprehensive risk score
                const riskScore = calculateComprehensiveRisk(atheniumData);
                globalRiskData = riskScore;
                
                // Update all displays
                updateResults(riskScore);
                updateCharts(atheniumData);
                updateLocationDetails(lat, lon, atheniumData);
                
                loading.classList.remove('active');
                results.style.display = 'block';
                
            } catch (error) {
                console.error('Analysis error:', error);
                showNotification(error.message, 'error');
                loading.classList.remove('active');
            }
        }

        function addRiskOverlays(lat, lon, data) {
            if (!map) return;
            
            // Add flood risk circle if significant
            if (data.fluvialRisk > 5 || data.pluvialRisk > 5) {
                L.circle([lat, lon], {
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.2,
                    radius: 1000,
                    weight: 2
                }).addTo(map).bindPopup('Flood Risk Zone');
            }
            
            // Add severe weather risk circle
            if (data.hail > 5 || data.tornado > 5) {
                L.circle([lat, lon], {
                    color: '#f59e0b',
                    fillColor: '#f59e0b',
                    fillOpacity: 0.15,
                    radius: 2000,
                    weight: 2
                }).addTo(map).bindPopup('Severe Weather Risk Zone');
            }
        }

        function getProjectTypeWeights(projectType) {
            // Define weights for different project types
            const weights = {
                'water': {
                    flood: 0.25,
                    karst: 0.20,  // Critical for water infrastructure
                    rainfall: 0.15,
                    hail: 0.10,
                    wind: 0.08,
                    tornado: 0.07,
                    wildfire: 0.05,
                    hurricane: 0.05,
                    earthquake: 0.05
                },
                'infrastructure': {
                    flood: 0.20,
                    earthquake: 0.15,
                    karst: 0.15,
                    hail: 0.12,
                    wind: 0.10,
                    tornado: 0.10,
                    rainfall: 0.08,
                    wildfire: 0.05,
                    hurricane: 0.05
                },
                'commercial': {
                    hail: 0.18,
                    wind: 0.15,
                    flood: 0.15,
                    tornado: 0.12,
                    rainfall: 0.10,
                    hurricane: 0.10,
                    karst: 0.08,
                    wildfire: 0.07,
                    earthquake: 0.05
                },
                'residential': {
                    hail: 0.20,
                    wind: 0.18,
                    flood: 0.15,
                    tornado: 0.12,
                    wildfire: 0.10,
                    rainfall: 0.08,
                    hurricane: 0.07,
                    karst: 0.05,
                    earthquake: 0.05
                }
            };
            
            // Return weights for the specific project type or default to commercial
            return weights[projectType] || weights['commercial'];
        }

        function calculateComprehensiveRisk(data) {
            const perils = {};
            
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const projectType = document.getElementById('projectType').value;
            
            // Get additional risk assessments
            const karstData = assessKarstRisk(lat, lon);
            const wildfireData = estimateWildfireRisk(lat, lon);
            const earthquakeData = getUSGSEarthquakeRisk(lat, lon);
            
            // Collect all peril scores from Athenium (already on 0-10 scale)
            perils.flood = { 
                score: Math.max(data.fluvialRisk || 0, data.pluvialRisk || 0), 
                probability: Math.max(data.fluvialRisk || 0, data.pluvialRisk || 0) * 10 
            };
            perils.hail = { 
                score: data.hail || 0, 
                probability: data.hailProbability || 0 
            };
            perils.wind = { 
                score: data.wind || 0, 
                probability: data.windProbability || 0 
            };
            perils.tornado = { 
                score: data.tornado || 0, 
                probability: data.tornadoProbability || 0 
            };
            perils.hurricane = { 
                score: data.hurricaneWind || 0, 
                probability: data.hurricaneProbability || 0 
            };
            perils.rainfall = { 
                score: data.rainfall || 0, 
                probability: data.rainfallProbability || 0 
            };
            
            // Add our supplemental assessments
            if (karstData.score > 0) {
                perils.karst = { 
                    score: karstData.score, 
                    probability: null,
                    riskLevel: karstData.riskLevel,
                    details: karstData.details
                };
            }
            
            if (wildfireData.score > 0) {
                perils.wildfire = {
                    score: wildfireData.score,
                    probability: null,
                    riskLevel: wildfireData.riskLevel,
                    details: wildfireData.details
                };
            }
            
            if (earthquakeData.score > 1) {
                perils.earthquake = {
                    score: earthquakeData.score,
                    probability: null,
                    riskLevel: earthquakeData.riskLevel,
                    pga: earthquakeData.pga
                };
            }
            
            // Calculate weighted average using project-specific weights
            const weights = getProjectTypeWeights(projectType);
            let weightedSum = 0;
            let totalWeight = 0;
            
            for (const [perilName, perilData] of Object.entries(perils)) {
                const score = perilData.score || 0;
                const weight = weights[perilName] || 0.1;
                weightedSum += score * weight;
                totalWeight += weight;
            }
            
            // Convert to 0-100 scale
            const combinedScore = Math.round((weightedSum / totalWeight) * 10);
            
            // Apply project type multiplier for final adjustment
            const typeMultipliers = {
                'water': 1.15,           // Higher - critical infrastructure
                'data_center': 1.12,     // High - zero downtime tolerance
                'healthcare': 1.10,      // High - operational sensitivity
                'bridge': 1.08,          // Moderate-high - complex engineering
                'marine': 1.08,          // Moderate-high - water exposure
                'infrastructure': 1.05,   // Moderate - public infrastructure
                'industrial': 1.03,      // Standard-plus
                'commercial': 1.0,       // Baseline
                'residential': 0.95      // Lower - standard construction
            };
            
            const finalScore = Math.min(95, Math.max(5, 
                combinedScore * (typeMultipliers[projectType] || 1.0)
            ));
            
            return {
                score: Math.round(finalScore),
                elevation: data.elevation,
                perils: perils,
                recommendations: generateRecommendations(finalScore, perils, data),
                suggestedRate: calculateRate(finalScore, perils)
            };
        }

        function calculateRate(score, perils) {
            let baseRate = 0.15;
            
            if (score > 75) baseRate = 0.35;
            else if (score > 60) baseRate = 0.28;
            else if (score > 45) baseRate = 0.22;
            else if (score > 30) baseRate = 0.18;
            
            // Adjust for specific perils
            if (perils.hurricane && perils.hurricane.score > 6) baseRate += 0.05;
            if (perils.hail && perils.hail.score > 6) baseRate += 0.03;
            if (perils.flood && perils.flood.score > 6) baseRate += 0.04;
            if (perils.karst && perils.karst.score > 6) baseRate += 0.04;
            
            return baseRate.toFixed(2);
        }

        function generateRecommendations(score, perils, data) {
            const recs = [];
            const projectType = document.getElementById('projectType').value;
            
            // Overall risk level recommendations
            if (score > 75) {
                recs.push('HIGH RISK: Comprehensive coverage with enhanced sublimits required');
                recs.push('Weekly inspections recommended during construction');
                recs.push('Consider alternative risk transfer mechanisms');
            } else if (score > 60) {
                recs.push('MODERATE-HIGH RISK: Standard coverage with specific peril sublimits');
                recs.push('Bi-weekly inspections recommended during construction');
            } else if (score > 45) {
                recs.push('MODERATE RISK: Standard coverage with appropriate deductibles');
                recs.push('Monthly inspections recommended during construction');
            } else {
                recs.push('LOW-MODERATE RISK: Standard builders risk coverage appropriate');
                recs.push('Quarterly inspections sufficient');
            }
            
            // Project-specific recommendations
            if (projectType === 'water' || projectType === 'infrastructure') {
                recs.push('WATER/WASTEWATER: Require geotechnical survey for sinkhole/subsidence risk');
                recs.push('Mandatory water detection systems (LAIIER or equivalent)');
                recs.push('Environmental liability exclusion or sublimit required');
                recs.push('Verify contractor has water treatment facility experience');
            }
            
            if (projectType === 'data_center') {
                recs.push('DATA CENTER: Require redundant power/cooling during construction');
                recs.push('Equipment breakdown coverage essential');
                recs.push('Cyber liability exclusion required');
            }
            
            if (projectType === 'bridge' || projectType === 'marine') {
                recs.push('MARINE/BRIDGE: Verify contractor marine construction experience');
                recs.push('Wave/surge damage sublimit required');
                recs.push('Scour protection measures mandatory');
            }
            
            // Peril-specific recommendations
            if (perils.hail && perils.hail.score > 6) {
                recs.push('Hail exposure HIGH: Minimum 3% wind/hail deductible required');
                recs.push('Require Class 4 impact-resistant roofing materials');
            }
            
            if (perils.flood && perils.flood.score > 6) {
                recs.push('Flood exposure HIGH: Consider separate flood sublimit 50% TIV');
                recs.push('Require detailed flood emergency response plan');
            }
            
            if (perils.tornado && perils.tornado.score > 5) {
                recs.push('Tornado risk MODERATE: Verify construction anchoring standards');
            }
            
            if (perils.karst && perils.karst.score > 6) {
                recs.push('KARST HIGH: Geotechnical survey strongly recommended');
                recs.push('Consider sinkhole sublimit 25-50% of TIV');
                recs.push('Minimum $250,000 sinkhole deductible');
            }
            
            if (perils.wildfire && perils.wildfire.score > 5) {
                recs.push('WILDFIRE MODERATE: Verify local fire codes compliance');
            }
            
            return recs;
        }

        function updateResults(riskData) {
            // Update risk score display
            document.getElementById('riskScore').textContent = riskData.score;
            document.getElementById('riskGauge').style.width = `${riskData.score}%`;
            
            // Determine risk level
            let riskLevel = 'Low';
            let riskColor = '#10b981';
            if (riskData.score > 75) {
                riskLevel = 'High';
                riskColor = '#ef4444';
            } else if (riskData.score > 60) {
                riskLevel = 'Moderate-High';
                riskColor = '#f97316';
            } else if (riskData.score > 45) {
                riskLevel = 'Moderate';
                riskColor = '#f59e0b';
            } else if (riskData.score > 30) {
                riskLevel = 'Low-Moderate';
                riskColor = '#84cc16';
            }
            
            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('riskLevel').style.color = riskColor;
            
            // Update rate
            document.getElementById('suggestedRate').textContent = `${riskData.suggestedRate}%`;
            
            // Find primary peril
            let primaryPeril = 'None';
            let maxScore = 0;
            for (const [name, data] of Object.entries(riskData.perils)) {
                if (data.score > maxScore) {
                    maxScore = data.score;
                    primaryPeril = name.charAt(0).toUpperCase() + name.slice(1);
                }
            }
            document.getElementById('primaryPeril').textContent = primaryPeril;
            
            // Update perils grid
            const perilsGrid = document.getElementById('perilsGrid');
            perilsGrid.innerHTML = '';
            
            for (const [name, data] of Object.entries(riskData.perils)) {
                const card = document.createElement('div');
                let cardClass = 'low';
                if (data.score > 6) cardClass = 'high';
                else if (data.score > 4) cardClass = 'moderate';
                
                card.className = `peril-card ${cardClass}`;
                card.innerHTML = `
                    <div class="peril-name">${name.toUpperCase()}</div>
                    <div class="peril-score">${data.score.toFixed(1)}</div>
                    <div class="peril-risk">${data.probability ? data.probability.toFixed(1) + '%' : data.riskLevel || 'N/A'}</div>
                `;
                perilsGrid.appendChild(card);
            }
            
            // Update recommendations
            const recsDiv = document.getElementById('recommendations');
            recsDiv.innerHTML = '<h3>Underwriting Recommendations</h3><ul>';
            riskData.recommendations.forEach(rec => {
                recsDiv.innerHTML += `<li>${rec}</li>`;
            });
            recsDiv.innerHTML += '</ul>';
            
            // Store for export
            globalRiskData = riskData;
        }

        function updateCharts(data) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) {
                riskChart.destroy();
            }
            
            riskChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Flood', 'Hail', 'Wind', 'Tornado', 'Hurricane', 'Rainfall'],
                    datasets: [{
                        label: 'Risk Score',
                        data: [
                            data.fluvialRisk || data.pluvialRisk || 0,
                            data.hail || 0,
                            data.wind || 0,
                            data.tornado || 0,
                            data.hurricaneWind || 0,
                            data.rainfall || 0
                        ],
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            ticks: {
                                stepSize: 2
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Peril Risk Profile',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        function updateLocationDetails(lat, lon, data) {
            const detailsDiv = document.getElementById('locationDetails');
            detailsDiv.innerHTML = `
                <h3 style="margin-bottom: 1rem;">Location Details</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <strong>Coordinates:</strong><br>${lat}, ${lon}
                    </div>
                    <div>
                        <strong>Elevation:</strong><br>${Math.round(data.elevation)} ft
                    </div>
                    <div>
                        <strong>Height Above Water:</strong><br>${Math.round(data.heightAboveWater)} ft
                    </div>
                    <div>
                        <strong>Analysis Date:</strong><br>${new Date().toLocaleDateString()}
                    </div>
                </div>
            `;
        }

        async function simulateAtheniumAPI(lat, lon) {
            // This simulates an Athenium API response
            // In production, this would be an actual API call
            
            // Regional risk adjustments based on location
            const isTexas = lon > -107 && lon < -93 && lat > 25 && lat < 37;
            const isFlorida = lon > -88 && lon < -79 && lat > 24 && lat < 31;
            const isCalifornia = lon > -125 && lon < -114 && lat > 32 && lat < 42;
            const isGulfCoast = lat < 31 && lon > -98 && lon < -81;
            
            return {
                elevation: 850 + Math.random() * 300,
                heightAboveWater: 50 + Math.random() * 100,
                fluvialRisk: isGulfCoast ? 4 + Math.random() * 3 : 2 + Math.random() * 3,
                pluvialRisk: 3 + Math.random() * 3,
                hail: isTexas ? 5 + Math.random() * 3 : 2 + Math.random() * 3,
                hailProbability: isTexas ? 20 + Math.random() * 10 : 5 + Math.random() * 10,
                wind: 3 + Math.random() * 3,
                windProbability: 40 + Math.random() * 20,
                tornado: isTexas ? 4 + Math.random() * 2 : 1 + Math.random() * 2,
                tornadoProbability: isTexas ? 3 + Math.random() * 2 : 0.5 + Math.random(),
                hurricaneWind: isGulfCoast || isFlorida ? 3 + Math.random() * 4 : 0.5 + Math.random(),
                hurricaneProbability: isGulfCoast || isFlorida ? 5 + Math.random() * 5 : 0.1 + Math.random(),
                rainfall: 4 + Math.random() * 3,
                rainfallProbability: 15 + Math.random() * 10
            };
        }

        function assessKarstRisk(lat, lon) {
            // Karst/sinkhole risk assessment based on geological regions
            // This is a simplified model - real implementation would use geological databases
            
            let score = 0;
            let riskLevel = 'None';
            let details = [];
            
            // Known karst regions in the US
            const karstRegions = [
                { name: 'Florida', lat: [25, 31], lon: [-87, -80], baseScore: 8 },
                { name: 'Kentucky', lat: [36, 39], lon: [-89, -82], baseScore: 7 },
                { name: 'Tennessee', lat: [35, 37], lon: [-90, -82], baseScore: 6 },
                { name: 'Texas Edwards Plateau', lat: [29, 32], lon: [-102, -97], baseScore: 7 },
                { name: 'Missouri Ozarks', lat: [36, 38], lon: [-95, -91], baseScore: 5 },
                { name: 'Indiana', lat: [38, 40], lon: [-88, -85], baseScore: 4 },
                { name: 'Pennsylvania', lat: [39.5, 41], lon: [-80, -75], baseScore: 4 },
                { name: 'Virginia Valley', lat: [36.5, 39], lon: [-83, -78], baseScore: 5 },
                { name: 'Alabama', lat: [31, 35], lon: [-88, -85], baseScore: 5 }
            ];
            
            // Check if location is in a karst region
            for (const region of karstRegions) {
                if (lat >= region.lat[0] && lat <= region.lat[1] && 
                    lon >= region.lon[0] && lon <= region.lon[1]) {
                    score = region.baseScore;
                    details.push(`Located in ${region.name} karst region`);
                    
                    // Texas-specific adjustments
                    if (region.name === 'Texas Edwards Plateau') {
                        details.push('Edwards Plateau only - Austin, San Antonio area. Excludes coastal/north TX');
                    }
                    break;
                }
            }
            
            // Adjust for project type
            const projectType = document.getElementById('projectType').value;
            if (score > 0 && (projectType === 'water' || projectType === 'infrastructure')) {
                score += 1.5;
                details.push('CRITICAL: Water infrastructure in karst terrain - extreme sinkhole risk');
                details.push('Reference: $1.8M Tennessee loss - water facility sinkhole collapse');
            }
            
            // Urban development adjustment
            if (score > 0 && (projectType === 'commercial' || projectType === 'residential')) {
                score += 0.5;
                details.push('Urban development increases sinkhole frequency');
            }
            
            score = Math.min(10, score);
            
            // Determine risk level
            if (score >= 8) {
                riskLevel = 'EXTREME';
            } else if (score >= 6) {
                riskLevel = 'HIGH';
            } else if (score >= 4) {
                riskLevel = 'MODERATE';
            } else if (score >= 2) {
                riskLevel = 'LOW';
            } else if (score > 0) {
                riskLevel = 'MINIMAL';
            } else {
                riskLevel = 'NONE';
                details.push('No karst terrain identified at this location');
            }
            
            return {
                score: score,
                riskLevel: riskLevel,
                details: details,
                requiresGeotech: score >= 6,
                requiresSinkholeExclusion: score >= 8
            };
        }

        function estimateWildfireRisk(lat, lon) {
            // Wildfire risk estimation based on location
            // Note: No free real-time wildfire API available, using geographic estimation
            
            let score = 0;
            let riskLevel = 'Low';
            let details = [];
            
            // High wildfire risk regions
            const wildfireRegions = [
                { name: 'California', lat: [32, 42], lon: [-124, -114], baseScore: 8 },
                { name: 'Colorado Front Range', lat: [37, 41], lon: [-106, -104], baseScore: 7 },
                { name: 'Arizona', lat: [31, 37], lon: [-114, -109], baseScore: 7 },
                { name: 'Nevada', lat: [35, 42], lon: [-120, -114], baseScore: 6 },
                { name: 'Montana', lat: [44, 49], lon: [-116, -104], baseScore: 6 },
                { name: 'Idaho', lat: [42, 49], lon: [-117, -111], baseScore: 6 },
                { name: 'Oregon', lat: [42, 46], lon: [-124, -117], baseScore: 6 },
                { name: 'Washington', lat: [45.5, 49], lon: [-124, -117], baseScore: 5 },
                { name: 'New Mexico', lat: [31, 37], lon: [-109, -103], baseScore: 5 },
                { name: 'Utah', lat: [37, 42], lon: [-114, -109], baseScore: 5 },
                { name: 'Texas Hill Country', lat: [29, 31], lon: [-100, -97], baseScore: 4 },
                { name: 'Florida', lat: [25, 31], lon: [-87, -80], baseScore: 3 }
            ];
            
            // Check location against wildfire regions
            for (const region of wildfireRegions) {
                if (lat >= region.lat[0] && lat <= region.lat[1] && 
                    lon >= region.lon[0] && lon <= region.lon[1]) {
                    score = region.baseScore;
                    details.push(`Located in ${region.name} wildfire zone`);
                    break;
                }
            }
            
            // Seasonal adjustment (simplified)
            const currentMonth = new Date().getMonth();
            if (score > 0 && (currentMonth >= 6 && currentMonth <= 10)) {
                score += 1;
                details.push('Peak wildfire season (July-November)');
            }
            
            // Urban interface adjustment
            if (score > 0) {
                const projectType = document.getElementById('projectType').value;
                if (projectType === 'residential' || projectType === 'multifamily') {
                    score += 1;
                    details.push('Wildland-Urban Interface (WUI) exposure');
                }
            }
            
            score = Math.min(10, score);
            
            // Determine risk level
            if (score >= 7) {
                riskLevel = 'HIGH';
            } else if (score >= 5) {
                riskLevel = 'MODERATE';
            } else if (score >= 3) {
                riskLevel = 'LOW';
            } else {
                riskLevel = 'MINIMAL';
            }
            
            if (score === 0) {
                details.push('No significant wildfire risk at this location');
            }
            
            return {
                score: score,
                riskLevel: riskLevel,
                details: details
            };
        }

        function getUSGSEarthquakeRisk(lat, lon) {
            // Simplified earthquake risk based on seismic zones
            // Real implementation would call USGS API
            
            let score = 0;
            let riskLevel = 'Low';
            let pga = 0;
            
            // High seismic risk zones
            const seismicZones = [
                { name: 'California', lat: [32, 42], lon: [-124, -114], basePGA: 0.6 },
                { name: 'Alaska', lat: [54, 71], lon: [-170, -130], basePGA: 0.8 },
                { name: 'Pacific Northwest', lat: [42, 49], lon: [-124, -117], basePGA: 0.4 },
                { name: 'Utah/Nevada', lat: [37, 42], lon: [-114, -111], basePGA: 0.3 },
                { name: 'New Madrid', lat: [35, 38], lon: [-91, -88], basePGA: 0.3 },
                { name: 'Charleston SC', lat: [32, 34], lon: [-81, -79], basePGA: 0.2 }
            ];
            
            // Check location against seismic zones
            for (const zone of seismicZones) {
                if (lat >= zone.lat[0] && lat <= zone.lat[1] && 
                    lon >= zone.lon[0] && lon <= zone.lon[1]) {
                    pga = zone.basePGA;
                    break;
                }
            }
            
            // Convert PGA to risk score
            if (pga >= 0.8) {
                score = 10;
                riskLevel = 'EXTREME';
            } else if (pga >= 0.6) {
                score = 8;
                riskLevel = 'HIGH';
            } else if (pga >= 0.4) {
                score = 6;
                riskLevel = 'MODERATE-HIGH';
            } else if (pga >= 0.2) {
                score = 4;
                riskLevel = 'MODERATE';
            } else if (pga >= 0.1) {
                score = 2;
                riskLevel = 'LOW';
            } else {
                score = 1;
                riskLevel = 'VERY LOW';
            }
            
            return {
                score: score,
                riskLevel: riskLevel,
                pga: pga
            };
        }
        
        function getDeductibleRecommendations(riskData) {
            const deds = [];
            
            // Base AOP deductible
            if (riskData.score > 60) {
                deds.push('All Other Perils (AOP): $50,000');
            } else if (riskData.score > 45) {
                deds.push('All Other Perils (AOP): $25,000');
            } else {
                deds.push('All Other Perils (AOP): $10,000');
            }
            
            // Wind/Hail
            if (riskData.perils.hail && riskData.perils.hail.score >= 6) {
                deds.push('Wind/Hail: 5% of TIV (minimum $100,000)');
            } else if (riskData.perils.hail && riskData.perils.hail.score >= 4) {
                deds.push('Wind/Hail: 3% of TIV (minimum $50,000)');
            } else {
                deds.push('Wind/Hail: 1% of TIV (minimum $25,000)');
            }
            
            // Flood
            if (riskData.perils.flood && riskData.perils.flood.score >= 6) {
                deds.push('Flood: $100,000 with 50% TIV sublimit');
            } else if (riskData.perils.flood && riskData.perils.flood.score >= 4) {
                deds.push('Flood: $50,000 with full TIV coverage');
            } else {
                deds.push('Flood: $25,000 with full TIV coverage');
            }
            
            // Named Storm
            if (riskData.perils.hurricane && riskData.perils.hurricane.score >= 6) {
                deds.push('Named Storm: 5% of TIV');
            } else if (riskData.perils.hurricane && riskData.perils.hurricane.score >= 3) {
                deds.push('Named Storm: 3% of TIV');
            }
            
            return deds;
        }

        function resetForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('projectValue').value = '';
            document.getElementById('manualData').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('initialMessage').style.display = 'block';
            
            if (map && marker) {
                map.removeLayer(marker);
                marker = null;
            }
            
            globalRiskData = {};
            showNotification('Form cleared');
        }

        function downloadJSON() {
            if (!globalRiskData.score) {
                showNotification('Please run analysis first', 'error');
                return;
            }
            
            const exportData = {
                metadata: {
                    projectName: document.getElementById('projectName').value || 'Unnamed Project',
                    address: document.getElementById('address').value,
                    coordinates: {
                        latitude: parseFloat(document.getElementById('latitude').value),
                        longitude: parseFloat(document.getElementById('longitude').value)
                    },
                    projectType: document.getElementById('projectType').value,
                    constructionType: document.getElementById('constructionType').value,
                    projectValue: parseFloat(document.getElementById('projectValue').value),
                    analysisDate: new Date().toISOString(),
                    platform: 'CatZone Professional v3.0'
                },
                riskAssessment: globalRiskData
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `catzone_analysis_${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('JSON exported successfully');
        }

        function printReport() {
            if (!globalRiskData.score) {
                showNotification('Please run analysis first', 'error');
                return;
            }
            
            window.print();
            showNotification('Print dialog opened');
        }

        // Auto-populate Cedar Park data for demo
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('projectName').value = 'Cedar Park Industrial Facility';
                document.getElementById('address').value = '1906 Hur Industrial Blvd, Cedar Park, TX 78613';
                document.getElementById('latitude').value = '30.521862';
                document.getElementById('longitude').value = '-97.873975';
                document.getElementById('projectType').value = 'water';
                document.getElementById('constructionType').value = 'addition';
                document.getElementById('projectValue').value = '92000000';
                showNotification('Demo data loaded - Click "Analyze Risk" to run analysis');
            }, 1000);
        });
    </script>
</body>
</html>
