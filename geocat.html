<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatZone v2.0 - NATCAT Risk Intelligence Platform</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #7c3aed;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            min-height: 100vh;
            color: var(--dark);
            padding: 2rem;
        }

        .header {
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--secondary);
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .branding {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .input-panel {
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }

        .results-panel {
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 60, 114, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: #92400e;
            color: white;
        }

        .help-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .data-source-indicator {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .data-source-indicator h4 {
            color: #0369a1;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .data-source-indicator p {
            color: #0369a1;
            font-size: 0.85rem;
            margin: 0;
        }

        .risk-score-container {
            border-radius: 12px;
            padding: 2rem;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
        }

        .risk-score-label {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .risk-score-value {
            font-size: 4rem;
            font-weight: 900;
            margin: 1rem 0;
        }

        .risk-score-category {
            font-size: 1rem;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .data-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .data-card h3 {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .data-card .label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .peril-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .peril-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        .peril-card.moderate {
            border-left-color: var(--warning);
        }

        .peril-card.high {
            border-left-color: var(--danger);
        }

        .peril-card.extreme {
            border-left-color: var(--purple);
        }

        .peril-card h4 {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .peril-card .score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .peril-card .detail {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .warning-box {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .warning-box h3 {
            color: #92400e;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .warning-box p {
            color: #92400e;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .warning-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .warning-box li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: #92400e;
        }

        .warning-box li:before {
            content: "→";
            position: absolute;
            left: 0;
            font-weight: 700;
        }

        .info-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-box h4 {
            color: #1e40af;
            margin-bottom: 1rem;
        }

        .info-box .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .info-box strong {
            color: #1e40af;
        }

        .info-box p {
            margin: 0.5rem 0;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: #6b7280;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            color: #d1d5db;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .button-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .data-grid, .peril-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .data-grid, .peril-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .input-panel, .btn {
                display: none !important;
            }

            .container {
                grid-template-columns: 1fr;
            }

            .warning-box {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <div class="logo">CatZone v2.0</div>
                <div class="subtitle">NATCAT Risk Intelligence Platform</div>
                <div class="branding">Powered by aerosure</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="panel input-panel">
            <h2 style="margin-bottom: 1.5rem;">Project Details</h2>

            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" placeholder="Enter project name">
            </div>

            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" id="address" placeholder="Enter full address">
                <button class="btn btn-secondary" onclick="geocodeAddress()" style="margin-top: 0.5rem;">
                    📍 Find Coordinates
                </button>
            </div>

            <div class="form-group">
                <label for="latitude">Latitude</label>
                <input type="number" id="latitude" step="0.000001" placeholder="e.g., 34.9224">
            </div>

            <div class="form-group">
                <label for="longitude">Longitude</label>
                <input type="number" id="longitude" step="0.000001" placeholder="e.g., -82.2425">
            </div>

            <div class="form-group">
                <label for="projectType">Project Type</label>
                <select id="projectType">
                    <option value="commercial">Commercial Construction</option>
                    <option value="residential">Residential Construction</option>
                    <option value="infrastructure">Infrastructure</option>
                    <option value="bridge">Bridge Construction</option>
                    <option value="marine">Marine/Port Facility</option>
                    <option value="water">Water/Wastewater</option>
                    <option value="healthcare">Healthcare Facility</option>
                    <option value="industrial">Industrial Facility</option>
                </select>
            </div>

            <div class="form-group">
                <label for="constructionType">Construction Type</label>
                <select id="constructionType">
                    <option value="renovation">Renovation/Rehab</option>
                    <option value="new">New Construction</option>
                </select>
            </div>

            <div class="form-group">
                <label for="structuralWork">Structural Work</label>
                <select id="structuralWork">
                    <option value="non-structural">Non-Structural</option>
                    <option value="structural">Structural Work</option>
                </select>
                <p class="help-text">Structural: foundation, framing, load-bearing modifications, shoring</p>
            </div>

            <div class="form-group">
                <label for="activeOps">Active Operations On-Site</label>
                <select id="activeOps">
                    <option value="no">No Active Operations</option>
                    <option value="yes">Active Operations</option>
                </select>
                <p class="help-text">Does construction occur within/adjacent to operating facility?</p>
            </div>

            <div class="form-group">
                <label for="projectValue">Project Value ($)</label>
                <input type="number" id="projectValue" placeholder="Enter total insured value">
            </div>

            <div class="form-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate">
            </div>

            <div class="form-group">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate">
            </div>

            <button class="btn btn-primary" onclick="runBasicAnalysis()">
                ⚡ Run Basic Analysis
            </button>

            <p class="help-text" style="text-align: center;">
                Analyzes USGS elevation, earthquake, and karst risk
            </p>
        </div>

        <div class="panel results-panel">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Analyzing risk factors...</p>
            </div>

            <div id="emptyState" class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                </svg>
                <h3>No Analysis Yet</h3>
                <p>Enter project details and click "Run Basic Analysis" to begin</p>
            </div>

            <div id="results" style="display: none;"></div>
        </div>
    </div>

    <script>
        let appState = {
            projectData: {},
            analysisResults: null
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('CatZone v2.0 initialized');
        });

        async function geocodeAddress() {
            const address = document.getElementById('address').value;
            if (!address) {
                alert('Please enter an address');
                return;
            }

            showLoading(true);
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
                );
                const data = await response.json();

                if (data && data.length > 0) {
                    document.getElementById('latitude').value = parseFloat(data[0].lat).toFixed(6);
                    document.getElementById('longitude').value = parseFloat(data[0].lon).toFixed(6);
                    alert('Coordinates found!');
                } else {
                    alert('Address not found. Please try a different format.');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                alert('Error finding coordinates. Please enter manually.');
            }
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('emptyState').style.display = show ? 'none' : 'block';
            document.getElementById('results').style.display = 'none';
        }

        function collectProjectData() {
            return {
                projectName: document.getElementById('projectName').value,
                address: document.getElementById('address').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                projectType: document.getElementById('projectType').value,
                constructionType: document.getElementById('constructionType').value,
                structuralWork: document.getElementById('structuralWork').value,
                activeOps: document.getElementById('activeOps').value,
                projectValue: document.getElementById('projectValue').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value
            };
        }

        async function fetchElevation(lat, lon) {
            try {
                const response = await fetch(
                    `https://epqs.nationalmap.gov/v1/json?x=${lon}&y=${lat}&units=Feet&output=json`
                );
                const data = await response.json();
                return data.value !== undefined ? parseFloat(data.value) : null;
            } catch (error) {
                console.error('Elevation fetch error:', error);
                return null;
            }
        }

        async function fetchEarthquake(lat, lon) {
            try {
                const response = await fetch(
                    `https://earthquake.usgs.gov/ws/designmaps/asce7-16.json?latitude=${lat}&longitude=${lon}&riskCategory=III&siteClass=D&title=CatZone`
                );
                const data = await response.json();

                if (data.response && data.response.data) {
                    const pga = data.response.data.pga;
                    let score, riskLevel;

                    if (pga >= 0.8) { score = 10; riskLevel = 'Extreme'; }
                    else if (pga >= 0.6) { score = 8; riskLevel = 'High'; }
                    else if (pga >= 0.5) { score = 7; riskLevel = 'High'; }
                    else if (pga >= 0.4) { score = 6; riskLevel = 'Moderate-High'; }
                    else if (pga >= 0.3) { score = 5; riskLevel = 'Moderate'; }
                    else if (pga >= 0.2) { score = 4; riskLevel = 'Moderate-Low'; }
                    else if (pga >= 0.1) { score = 2; riskLevel = 'Low'; }
                    else { score = 1; riskLevel = 'Very Low'; }

                    return { pga, riskLevel, score };
                }
                return null;
            } catch (error) {
                console.error('Earthquake fetch error:', error);
                return null;
            }
        }

        function assessKarstRisk(lat, lon) {
            const karstRegions = [
                { state: 'FL', name: 'Florida', baseScore: 8, lat: [24, 31], lon: [-87, -80], note: 'Extensive limestone, cover collapse sinkholes common statewide' },
                { state: 'TN', name: 'Tennessee', baseScore: 8, lat: [35, 37], lon: [-90, -82], note: 'Central basin karst - Nashville, Murfreesboro. Eastern Highland Rim' },
                { state: 'KY', name: 'Kentucky', baseScore: 7, lat: [36.5, 39.1], lon: [-89.5, -82], note: 'Mammoth Cave region, extensive karst terrain' },
                { state: 'MO', name: 'Missouri', baseScore: 6, lat: [36, 38.5], lon: [-94.5, -90], note: 'Ozark Plateau karst - Springfield, Branson area' },
                { state: 'PA', name: 'Pennsylvania', baseScore: 6, lat: [39.7, 41.2], lon: [-80, -76], note: 'Appalachian karst belt - central/south-central PA' },
                { state: 'TX', name: 'Texas', baseScore: 5, lat: [29.5, 31.5], lon: [-101, -97.5], note: 'Edwards Plateau - Austin, San Antonio area' },
                { state: 'IN', name: 'Indiana', baseScore: 5, lat: [37.8, 39.5], lon: [-87.5, -85.5], note: 'Southern Indiana karst belt - Mitchell plain' },
                { state: 'AL', name: 'Alabama', baseScore: 5, lat: [33, 35], lon: [-88, -85.5], note: 'Northern Alabama karst - Huntsville region' },
                { state: 'VA', name: 'Virginia', baseScore: 5, lat: [36.5, 39.5], lon: [-81.5, -78], note: 'Shenandoah Valley/Great Valley karst' },
                { state: 'WV', name: 'West Virginia', baseScore: 5, lat: [37.2, 40.6], lon: [-82, -78], note: 'Greenbrier Valley karst' }
            ];

            let score = 0;
            let riskLevel = 'Very Low';
            let details = [];

            for (const region of karstRegions) {
                if (lat >= region.lat[0] && lat <= region.lat[1] && 
                    lon >= region.lon[0] && lon <= region.lon[1]) {
                    score = region.baseScore;
                    details.push(`Located in ${region.name} karst region`);
                    details.push(region.note);
                    break;
                }
            }

            if (score > 0) {
                score += 1;
                details.push('Urban development may increase sinkhole risk');
            }

            if (score >= 8) riskLevel = 'Extreme';
            else if (score >= 6) riskLevel = 'High';
            else if (score >= 4) riskLevel = 'Moderate';
            else if (score >= 2) riskLevel = 'Low';

            return { score: Math.min(10, score), riskLevel, details };
        }

        function calculateCompositeRisk(elevation, earthquake, karst, athenium, projectData) {
            let baseRisk = 30;

            if (elevation !== null) {
                if (elevation < 5) baseRisk += 15;
                else if (elevation < 10) baseRisk += 10;
                else if (elevation < 15) baseRisk += 5;
                else if (elevation > 50) baseRisk -= 5;
            }

            if (athenium && athenium.weather_perils) {
                const hurricane = athenium.weather_perils.hurricane_wind?.risk_score || 0;
                const rainfall = athenium.weather_perils.rainfall?.risk_score || 0;
                const hail = athenium.weather_perils.hail?.risk_score || 0;
                const wind = athenium.weather_perils.wind?.risk_score || 0;
                const tornado = athenium.weather_perils.tornado?.risk_score || 0;

                if (hurricane >= 8) baseRisk += 12;
                else if (hurricane >= 6) baseRisk += 8;
                else if (hurricane >= 4) baseRisk += 4;

                if (rainfall >= 8) baseRisk += 8;
                else if (rainfall >= 6) baseRisk += 5;
                else if (rainfall >= 4) baseRisk += 2;

                if (hail >= 6) baseRisk += 5;
                else if (hail >= 4) baseRisk += 2;

                if (wind >= 7) baseRisk += 6;
                else if (wind >= 5) baseRisk += 3;

                if (tornado >= 6) baseRisk += 6;
                else if (tornado >= 4) baseRisk += 3;
            }

            if (athenium && athenium.flood_risk) {
                const flashFlood = athenium.flood_risk.flash_flood_score || 0;
                if (flashFlood >= 8) baseRisk += 12;
                else if (flashFlood >= 6) baseRisk += 8;
                else if (flashFlood >= 4) baseRisk += 4;
            }

            if (earthquake && earthquake.score >= 7) baseRisk += 8;
            else if (earthquake && earthquake.score >= 5) baseRisk += 4;

            if (karst.score >= 7) baseRisk += 8;
            else if (karst.score >= 5) baseRisk += 5;
            else if (karst.score >= 3) baseRisk += 2;

            const typeMultipliers = {
                'marine': 1.15,
                'bridge': 1.12,
                'water': 1.10,
                'infrastructure': 1.08,
                'healthcare': 1.05,
                'industrial': 1.03,
                'commercial': 1.0,
                'residential': 0.98
            };

            const constructionMultiplier = projectData.constructionType === 'new' ? 1.08 : 1.0;
            const structuralMultiplier = projectData.structuralWork === 'structural' ? 1.15 : 1.0;
            const activeOpsMultiplier = projectData.activeOps === 'yes' ? 1.25 : 1.0;

            let finalScore = baseRisk * 
                (typeMultipliers[projectData.projectType] || 1.0) * 
                constructionMultiplier * 
                structuralMultiplier * 
                activeOpsMultiplier;

            finalScore = Math.min(95, Math.max(5, Math.round(finalScore)));

            let category = 'LOW RISK';
            let color = '#10b981';
            if (finalScore > 75) { category = 'HIGH RISK'; color = '#ef4444'; }
            else if (finalScore > 60) { category = 'ELEVATED RISK'; color = '#f59e0b'; }
            else if (finalScore > 45) { category = 'MODERATE RISK'; color = '#3b82f6'; }

            return { score: finalScore, category, color };
        }

        async function runBasicAnalysis() {
            const projectData = collectProjectData();
            const lat = parseFloat(projectData.latitude);
            const lon = parseFloat(projectData.longitude);

            if (!lat || !lon) {
                alert('Please provide valid coordinates');
                return;
            }

            appState.projectData = projectData;
            
            showLoading(true);
            document.getElementById('emptyState').style.display = 'none';

            try {
                const [elevation, earthquake, karst] = await Promise.all([
                    fetchElevation(lat, lon),
                    fetchEarthquake(lat, lon),
                    Promise.resolve(assessKarstRisk(lat, lon))
                ]);

                appState.analysisResults = {
                    elevation,
                    earthquake,
                    karst,
                    dataSources: ['USGS Elevation', 'USGS Earthquake', 'Karst Assessment (Proprietary)'],
                    coordinates: { lat, lon },
                    needsAthenium: true
                };

                renderResults();
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error running analysis: ' + error.message);
                showLoading(false);
            }
        }

        function generateAtheniumRequest() {
            const pd = appState.projectData;
            const request = `New NATCAT analysis request for CatZone:

PROJECT DETAILS:
- Project Name: ${pd.projectName || 'Not specified'}
- Address: ${pd.address || 'Not specified'}
- Coordinates: ${pd.latitude}, ${pd.longitude}
- Project Type: ${pd.projectType}
- Construction Type: ${pd.constructionType}
- Structural Work: ${pd.structuralWork}
- Active Operations: ${pd.activeOps}
- Project Value: ${pd.projectValue ? '$' + parseInt(pd.projectValue).toLocaleString() : 'Not specified'}
- Construction Period: ${pd.startDate} to ${pd.endDate}

REQUIRED ATHENIUM DATA:
Please run the following Athenium tools and return structured JSON:

1. location_weather_risk (all perils with additionalData=true)
2. location_flood_risk
3. location_wildfire_risk
4. severe_weather_history_location (hail ≥1.0", last 5 years, 3km radius)
5. severe_weather_history_location (wind ≥50mph, last 5 years)

Return the data in this JSON structure:
{
  "weather_perils": { ... },
  "flood_risk": { ... },
  "wildfire_risk": { ... },
  "hail_history": { ... },
  "wind_history": { ... }
}`;

            navigator.clipboard.writeText(request).then(() => {
                alert('Athenium request copied to clipboard!\n\nPaste it into Claude chat, then paste the JSON response back here.');
            }).catch(err => {
                alert('Could not copy to clipboard. Please copy the text manually.');
                console.error('Clipboard error:', err);
            });
        }

        function integrateAtheniumData() {
            const jsonInput = document.getElementById('atheniumDataInput').value;
            
            if (!jsonInput.trim()) {
                alert('Please paste the Athenium JSON data');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                const compositeRisk = calculateCompositeRisk(
                    appState.analysisResults.elevation,
                    appState.analysisResults.earthquake,
                    appState.analysisResults.karst,
                    data,
                    appState.projectData
                );

                appState.analysisResults.athenium = data;
                appState.analysisResults.compositeRisk = compositeRisk;
                appState.analysisResults.needsAthenium = false;
                appState.analysisResults.dataSources.push(
                    'Athenium Weather Risk',
                    'Athenium Flood Risk',
                    'Athenium Historical Events'
                );

                renderResults();
                alert('Athenium data integrated successfully!');
            } catch (error) {
                alert('Invalid JSON format. Please check the data and try again.\n\nError: ' + error.message);
            }
        }

        function generateRecommendations() {
            if (!appState.analysisResults || !appState.analysisResults.compositeRisk) return [];
            
            const recs = [];
            const score = appState.analysisResults.compositeRisk.score;
            const athenium = appState.analysisResults.athenium;
            const pd = appState.projectData;
            
            if (score > 75) {
                recs.push('HIGH RISK: Comprehensive coverage with enhanced sublimits required');
                recs.push('Weekly site inspections and real-time monitoring recommended');
                recs.push('Consider 5% or higher deductibles for CAT perils');
            } else if (score > 60) {
                recs.push('ELEVATED RISK: Enhanced coverage terms with appropriate sublimits');
                recs.push('Monthly inspections and quarterly risk reviews recommended');
                recs.push('Standard deductible structure appropriate (3-5%)');
            } else if (score > 45) {
                recs.push('MODERATE RISK: Standard coverage with appropriate sublimits');
                recs.push('Quarterly inspections sufficient');
                recs.push('Standard deductibles (2-3%)');
            } else {
                recs.push('LOW RISK: Competitive pricing available with standard terms');
                recs.push('Annual inspections sufficient');
                recs.push('Lower deductibles appropriate (1-2%)');
            }
            
            if (pd.activeOps === 'yes') {
                recs.push('ACTIVE OPERATIONS: Consider excluding existing structure from coverage');
                recs.push('Business interruption exposure - enhanced protocols required');
                recs.push('Contamination risk for sensitive operations - isolation protocols mandatory');
            }
            
            if (pd.structuralWork === 'structural') {
                recs.push('STRUCTURAL WORK: Require PE-stamped drawings and shoring plans');
                recs.push('Daily monitoring during excavation/demolition phases');
                recs.push('Verify contractor structural engineering experience');
            }
            
            if (athenium?.weather_perils?.hurricane_wind?.risk_score >= 7) {
                recs.push('Hurricane exposure HIGH: 5% windstorm deductible recommended');
                recs.push('Hurricane preparedness plan MANDATORY');
            }
            
            if (athenium?.flood_risk?.flash_flood_score >= 7) {
                recs.push('Flash flood exposure EXTREME: Flood sublimit 25-50% of TIV');
                recs.push('Water detection system strongly recommended');
                recs.push('Site drainage plan and emergency water extraction protocols required');
            }
            
            if (athenium?.weather_perils?.rainfall?.risk_score >= 7) {
                recs.push('Heavy rainfall risk HIGH: Enhanced weather monitoring required');
                recs.push('Temporary roof protection protocols mandatory');
            }
            
            const karst = appState.analysisResults.karst;
            if (karst?.score >= 7) {
                recs.push('KARST EXTREME: Mandatory geotechnical survey with sinkhole assessment');
                recs.push('Consider sinkhole exclusion or separate ground stability policy');
                recs.push('Monitor for subsidence during and after construction');
            } else if (karst?.score >= 5) {
                recs.push('Karst risk HIGH: Geotechnical survey strongly recommended');
                recs.push('Consider sinkhole sublimit or specific endorsement');
            }
            
            if (appState.analysisResults.earthquake?.score >= 7) {
                recs.push('Earthquake risk HIGH: Consider earthquake sublimit 50% TIV');
            }
            
            if (appState.analysisResults.elevation && appState.analysisResults.elevation < 15) {
                recs.push('LOW ELEVATION: Site within potential flood zone - verify FEMA maps');
            }
            
            return recs;
        }

        function analyzeConstructionTiming() {
            const pd = appState.projectData;
            if (!pd.startDate || !pd.endDate || !appState.analysisResults?.athenium) return null;
            
            const start = new Date(pd.startDate);
            const end = new Date(pd.endDate);
            
            const hurricaneStart = new Date(start.getFullYear(), 5, 1);
            const hurricaneEnd = new Date(end.getFullYear(), 10, 30);
            
            const hasOverlap = (start <= hurricaneEnd && end >= hurricaneStart);
            if (!hasOverlap) return null;
            
            const overlapMonths = [];
            const current = new Date(Math.max(start.getTime(), hurricaneStart.getTime()));
            const finish = new Date(Math.min(end.getTime(), hurricaneEnd.getTime()));
            
            while (current <= finish) {
                overlapMonths.push(current.getMonth());
                current.setMonth(current.getMonth() + 1);
            }
            
            const monthlyProb = appState.analysisResults.athenium.weather_perils?.hurricane_wind?.monthly_probability || [];
            const peakMonths = [];
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            overlapMonths.forEach(month => {
                const prob = monthlyProb[month];
                if (prob > 8) {
                    peakMonths.push({ month: monthNames[month], probability: prob });
                }
            });
            
            return {
                hasOverlap,
                overlapMonths: overlapMonths.length,
                peakMonths
            };
        }

        function generateQuickReport() {
            if (!appState.analysisResults || !appState.analysisResults.compositeRisk) return '';
            
            const recommendations = generateRecommendations();
            const timingRisk = analyzeConstructionTiming();
            const pd = appState.projectData;
            const ar = appState.analysisResults;
            
            let report = `CATZONE NATCAT RISK ANALYSIS - QUICK DECISION MEMO
Generated: ${new Date().toLocaleString()}
Platform: aerosure

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PROJECT DETAILS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Project Name: ${pd.projectName || 'Not specified'}
Address: ${pd.address || 'Not specified'}
Coordinates: ${pd.latitude}, ${pd.longitude}

Project Type: ${pd.projectType}
Construction Type: ${pd.constructionType}
Structural Work: ${pd.structuralWork}
Active Operations: ${pd.activeOps}
Project Value: ${pd.projectValue ? '$' + parseInt(pd.projectValue).toLocaleString() : 'Not specified'}
Construction Period: ${pd.startDate} to ${pd.endDate}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

COMPOSITE RISK ASSESSMENT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

COMPOSITE RISK SCORE: ${ar.compositeRisk.score}/100
RISK CATEGORY: ${ar.compositeRisk.category}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CRITICAL RISK FACTORS
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ELEVATION: ${ar.elevation ? Math.round(ar.elevation) + ' ft' : 'N/A'}
EARTHQUAKE: ${ar.earthquake ? ar.earthquake.score + '/10 - ' + ar.earthquake.riskLevel : 'N/A'}
KARST/SINKHOLE: ${ar.karst.score}/10 - ${ar.karst.riskLevel}
`;

            if (ar.athenium) {
                report += `\nWEATHER PERILS (Athenium):\n`;
                if (ar.athenium.weather_perils?.hurricane_wind) {
                    report += `  • Hurricane Wind: ${ar.athenium.weather_perils.hurricane_wind.risk_score}/10 (${ar.athenium.weather_perils.hurricane_wind.probability}% annual)\n`;
                }
                if (ar.athenium.flood_risk) {
                    report += `  • Flash Flood: ${ar.athenium.flood_risk.flash_flood_score}/10 - ${ar.athenium.flood_risk.flash_flood_level}\n`;
                    report += `  • River Flood: ${ar.athenium.flood_risk.river_flood_score}/10 - ${ar.athenium.flood_risk.river_flood_level}\n`;
                }
                if (ar.athenium.weather_perils?.rainfall) {
                    report += `  • Rainfall: ${ar.athenium.weather_perils.rainfall.risk_score}/10 (${ar.athenium.weather_perils.rainfall.probability}% annual)\n`;
                }
                if (ar.athenium.weather_perils?.wind) {
                    report += `  • Wind: ${ar.athenium.weather_perils.wind.risk_score}/10 (${ar.athenium.weather_perils.wind.probability}% annual)\n`;
                }
                if (ar.athenium.weather_perils?.hail) {
                    report += `  • Hail: ${ar.athenium.weather_perils.hail.risk_score}/10 (${ar.athenium.weather_perils.hail.probability}% annual)\n`;
                }
                if (ar.athenium.weather_perils?.tornado) {
                    report += `  • Tornado: ${ar.athenium.weather_perils.tornado.risk_score}/10 (${ar.athenium.weather_perils.tornado.probability}% annual)\n`;
                }
            }

            if (timingRisk && timingRisk.hasOverlap) {
                report += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nCONSTRUCTION TIMING RISK\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n⚠️  HURRICANE SEASON OVERLAP: ${timingRisk.overlapMonths} months of construction\n`;
                if (timingRisk.peakMonths.length > 0) {
                    report += `\nPEAK RISK MONTHS:\n${timingRisk.peakMonths.map(m => `  • ${m.month}: ${m.probability.toFixed(1)}% probability`).join('\n')}\n`;
                }
            }

            if (ar.athenium?.wind_history) {
                report += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nHISTORICAL EVENTS\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nWIND EVENTS (≥50 mph):\n  • Total Events: ${ar.athenium.wind_history.total_events} in ${ar.athenium.wind_history.time_span_years} years\n  • Maximum Wind: ${ar.athenium.wind_history.maximum_speed} mph\n  • Annual Frequency: ${ar.athenium.wind_history.annual_frequency} events/year\n`;
                if (ar.athenium.wind_history.named_storms?.length > 0) {
                    report += `  • Named Storms: ${ar.athenium.wind_history.named_storms.map(s => s.name).join(', ')}\n`;
                }
            }

            if (ar.athenium?.hail_history) {
                report += `\nHAIL EVENTS (≥1.0"):\n  • Total Events: ${ar.athenium.hail_history.total_events} in ${ar.athenium.hail_history.time_span_years} years\n  • Maximum Size: ${ar.athenium.hail_history.maximum_size}" diameter\n  • Annual Frequency: ${ar.athenium.hail_history.annual_frequency} events/year\n`;
            }

            report += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nUNDERWRITING RECOMMENDATIONS\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${recommendations.map((r, i) => `${i + 1}. ${r}`).join('\n')}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nDATA SOURCES\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${ar.dataSources.join('\n')}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\nThis analysis was generated by CatZone v2.0\nPowered by aerosure | NATCAT Risk Intelligence Platform`;

            return report;
        }

        function copyReportToClipboard() {
            const report = generateQuickReport();
            navigator.clipboard.writeText(report).then(() => {
                alert('Report copied to clipboard!');
            }).catch(err => {
                alert('Could not copy to clipboard');
                console.error('Clipboard error:', err);
            });
        }

        function getPerilColorClass(score) {
            if (score >= 8) return 'extreme';
            if (score >= 6) return 'high';
            if (score >= 4) return 'moderate';
            return '';
        }

        function renderResults() {
            showLoading(false);
            document.getElementById('results').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            const ar = appState.analysisResults;
            const resultsDiv = document.getElementById('results');
            
            let html = '';
            
            html += `
                <div class="data-source-indicator">
                    <h4>DATA SOURCES</h4>
                    <p>${ar.dataSources.join(' • ')}</p>
                </div>
            `;
            
            if (ar.compositeRisk) {
                html += `
                    <div class="risk-score-container" style="background: linear-gradient(135deg, ${ar.compositeRisk.color}, ${ar.compositeRisk.color}dd)">
                        <div class="risk-score-label">Composite Risk Score</div>
                        <div class="risk-score-value">${ar.compositeRisk.score}</div>
                        <div class="risk-score-category">${ar.compositeRisk.category}</div>
                    </div>
                `;
            }
            
            html += `
                <h3 style="margin-bottom: 1rem;">Basic Risk Factors</h3>
                <div class="data-grid">
                    <div class="data-card">
                        <h3>ELEVATION</h3>
                        <div class="value">${ar.elevation ? Math.round(ar.elevation) : 'N/A'}</div>
                        <div class="label">feet above sea level</div>
                    </div>
                    <div class="data-card">
                        <h3>EARTHQUAKE</h3>
                        <div class="value">${ar.earthquake ? ar.earthquake.score + '/10' : 'N/A'}</div>
                        <div class="label">${ar.earthquake ? ar.earthquake.riskLevel : 'N/A'}</div>
                    </div>
                    <div class="data-card">
                        <h3>KARST/SINKHOLE</h3>
                        <div class="value">${ar.karst.score}/10</div>
                        <div class="label">${ar.karst.riskLevel}</div>
                    </div>
                </div>
            `;
            
            if (ar.athenium && ar.athenium.weather_perils) {
                html += `<h3 style="margin-bottom: 1rem; margin-top: 2rem;">Weather Peril Assessment</h3><div class="peril-grid">`;
                
                const perils = [
                    { key: 'hurricane_wind', icon: '🌀', label: 'HURRICANE WIND', data: ar.athenium.weather_perils.hurricane_wind },
                    { key: 'flash_flood', icon: '💧', label: 'FLASH FLOOD', data: ar.athenium.flood_risk, scoreKey: 'flash_flood_score', levelKey: 'flash_flood_level' },
                    { key: 'rainfall', icon: '🌧️', label: 'RAINFALL', data: ar.athenium.weather_perils.rainfall },
                    { key: 'wind', icon: '💨', label: 'WIND', data: ar.athenium.weather_perils.wind },
                    { key: 'hail', icon: '🧊', label: 'HAIL', data: ar.athenium.weather_perils.hail },
                    { key: 'tornado', icon: '🌪️', label: 'TORNADO', data: ar.athenium.weather_perils.tornado }
                ];
                
                perils.forEach(peril => {
                    if (peril.data) {
                        const score = peril.scoreKey ? peril.data[peril.scoreKey] : peril.data.risk_score;
                        const detail = peril.levelKey ? peril.data[peril.levelKey] : 
                                      peril.data.probability ? `${peril.data.probability}% annual` : '';
                        const colorClass = getPerilColorClass(score);
                        
                        html += `
                            <div class="peril-card ${colorClass}">
                                <h4>${peril.icon} ${peril.label}</h4>
                                <div class="score">${score}/10</div>
                                <div class="detail">${detail}</div>
                            </div>
                        `;
                    }
                });
                
                html += `</div>`;
                
                if (ar.athenium.wind_history || ar.athenium.hail_history) {
                    html += `
                        <div class="info-box">
                            <h4>⚡ Historical Severe Weather Events</h4>
                            <div class="grid">
                    `;
                    
                    if (ar.athenium.wind_history) {
                        html += `
                            <div>
                                <strong>Wind Events (≥50 mph):</strong>
                                <p>${ar.athenium.wind_history.total_events} events in ${ar.athenium.wind_history.time_span_years} years</p>
                                <p>Maximum: ${ar.athenium.wind_history.maximum_speed} mph</p>
                                ${ar.athenium.wind_history.named_storms?.length > 0 ? 
                                    `<p style="font-size: 0.85rem;">Named storms: ${ar.athenium.wind_history.named_storms.map(s => s.name).join(', ')}</p>` : ''}
                            </div>
                        `;
                    }
                    
                    if (ar.athenium.hail_history) {
                        html += `
                            <div>
                                <strong>Hail Events (≥1.0"):</strong>
                                <p>${ar.athenium.hail_history.total_events} events in ${ar.athenium.hail_history.time_span_years} years</p>
                                <p>Maximum: ${ar.athenium.hail_history.maximum_size}" diameter</p>
                            </div>
                        `;
                    }
                    
                    html += `</div></div>`;
                }
            }
            
            if (ar.compositeRisk) {
                const timingRisk = analyzeConstructionTiming();
                if (timingRisk && timingRisk.hasOverlap) {
                    html += `
                        <div class="warning-box">
                            <h3>📅 Construction Timing Risk</h3>
                            <p style="font-size: 1.1rem; font-weight: 600;">
                                ⚠️ Hurricane Season Overlap: ${timingRisk.overlapMonths} months of construction
                            </p>
                    `;
                    
                    if (timingRisk.peakMonths.length > 0) {
                        html += `
                            <p style="font-weight: 600; margin-top: 1rem;">Peak Risk Months:</p>
                            <ul>
                                ${timingRisk.peakMonths.map(m => `<li>${m.month}: ${m.probability.toFixed(1)}% hurricane probability</li>`).join('')}
                            </ul>
                        `;
                    }
                    
                    html += `
                            <p style="margin-top: 1rem; font-size: 0.9rem; font-style: italic;">
                                Construction period spans hurricane season (June 1 - November 30). Enhanced preparedness required.
                            </p>
                        </div>
                    `;
                }
                
                const recommendations = generateRecommendations();
                html += `
                    <div class="warning-box">
                        <h3>🏆 Underwriting Recommendations</h3>
                        <ul>
                            ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                html += `
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="copyReportToClipboard()">
                            📄 Copy Quick Report to Clipboard
                        </button>
                        <button class="btn btn-secondary" onclick="window.print()">
                            🖨️ Print Report
                        </button>
                    </div>
                `;
            }
            
            if (ar.needsAthenium) {
                html += `
                    <div class="warning-box">
                        <h3>⚠️ Athenium Analysis Required</h3>
                        <p>For complete NATCAT analysis (hurricane, tornado, hail, wind, flood, wildfire), you need Athenium data.</p>
                        
                        <button class="btn btn-warning" onclick="generateAtheniumRequest()">
                            📋 Copy Athenium Request to Clipboard
                        </button>
                        
                        <div style="margin-top: 1.5rem;">
                            <label for="atheniumDataInput">Paste Athenium JSON Response Here:</label>
                            <textarea id="atheniumDataInput" placeholder='Paste the JSON response from Claude here...'></textarea>
                            <button class="btn btn-success" onclick="integrateAtheniumData()" style="margin-top: 0.5rem;">
                                ✅ Integrate Athenium Data
                            </button>
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
