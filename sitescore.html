<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteScore‚Ñ¢ v1.3.5 | Fixed & Optimized</title>
    <link rel="icon" type="image/png" href="SiteScore_favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        :root {
            --bg-primary:#080b10;--bg-secondary:#0d1117;--bg-tertiary:#161b22;--bg-card:#0d1117;--bg-elevated:#1c2433;
            --border-color:#30363d;--border-light:#484f58;--text-primary:#f0f6fc;--text-secondary:#8b949e;--text-muted:#6e7681;
            --brand-primary:#2ea043;--brand-secondary:#58a6ff;--brand-accent:#a371f7;
            --status-critical:#f85149;--status-high:#f0883e;--status-moderate:#d29922;--status-low:#2ea043;--status-info:#58a6ff;
            --gradient-brand:linear-gradient(135deg,#2ea043 0%,#58a6ff 100%);
            --gradient-header:linear-gradient(135deg,#238636 0%,#1f6feb 100%);
            --gradient-glow:radial-gradient(ellipse at center,rgba(46,160,67,0.15) 0%,transparent 70%);
            --shadow-glow:0 0 40px rgba(46,160,67,0.2);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow:hidden}
        
        /* Header */
        .header{background:var(--gradient-header);padding:0 24px;height:56px;display:flex;justify-content:space-between;align-items:center;position:relative;border-bottom:1px solid rgba(255,255,255,0.1)}
        .header::before{content:'';position:absolute;inset:0;background:var(--gradient-glow);pointer-events:none}
        .header-left{display:flex;align-items:center;gap:16px;position:relative;z-index:1}
        .logo-link{display:flex;align-items:center;text-decoration:none;min-height:40px;min-width:200px}
        .header-logo{height:40px;width:auto;filter:brightness(1.1)}
        .version{font-size:10px;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:4px;color:white;font-weight:600}
        .header-scores{display:flex;align-items:center;gap:4px;position:relative;z-index:1}
        .score-pill{display:flex;flex-direction:column;align-items:center;padding:6px 14px;background:rgba(0,0,0,0.2);border-radius:8px;min-width:70px;border:1px solid rgba(255,255,255,0.1)}
        .score-pill-value{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace;color:white}
        .score-pill-label{font-size:8px;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.7)}
        .score-pill.main{background:rgba(0,0,0,0.3);border-color:rgba(255,255,255,0.2)}
        .score-pill.main .score-pill-value{font-size:20px}

        /* Layout */
        .main-container{display:grid;grid-template-columns:360px 1fr 380px;height:calc(100vh - 56px)}
        .panel{background:var(--bg-secondary);display:flex;flex-direction:column;overflow:hidden}
        .panel-left{border-right:1px solid var(--border-color)}
        .panel-right{border-left:1px solid var(--border-color)}
        .panel-header{padding:12px 16px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);display:flex;align-items:center;gap:8px;flex-shrink:0}
        .panel-content{flex:1;overflow-y:auto;padding:14px}

        /* Input Section */
        .input-section{background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;padding:14px;margin-bottom:14px}
        .input-field{margin-bottom:10px}
        .input-field label{display:block;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:5px}
        .input-field input{width:100%;padding:9px 11px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);font-size:13px;transition:all 0.2s}
        .input-field input:focus{outline:none;border-color:var(--brand-primary);box-shadow:0 0 0 3px rgba(46,160,67,0.15)}
        .input-row{display:flex;gap:8px}
        .input-row input{flex:1}
        .input-row button{padding:9px 12px;background:var(--brand-secondary);border:none;border-radius:6px;color:white;font-weight:600;font-size:10px;cursor:pointer;white-space:nowrap}
        .coord-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .coord-row input{font-family:'JetBrains Mono',monospace;font-size:12px}

        /* Analyze Button */
        .analyze-btn{width:100%;padding:11px;background:var(--gradient-brand);border:none;border-radius:8px;color:white;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:var(--shadow-glow);transition:all 0.2s;position:relative;overflow:hidden}
        .analyze-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transform:translateX(-100%);transition:transform 0.5s}
        .analyze-btn:hover::before{transform:translateX(100%)}
        .analyze-btn:disabled{opacity:0.6;cursor:not-allowed}
        .analyze-btn .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Quick Locations */
        .quick-locations{margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)}
        .quick-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px}
        .quick-btn{width:100%;padding:8px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);font-size:10px;text-align:left;cursor:pointer;margin-bottom:5px;display:flex;align-items:center;gap:8px;transition:all 0.15s}
        .quick-btn:hover{border-color:var(--brand-primary);color:var(--text-primary);background:var(--bg-elevated)}
        .quick-btn .icon{font-size:14px}
        .quick-btn .name{font-weight:600;flex:1}
        .quick-btn .tag{font-size:7px;padding:2px 5px;border-radius:3px;font-weight:700;text-transform:uppercase}
        .tag-critical{background:rgba(248,81,73,0.2);color:var(--status-critical)}
        .tag-high{background:rgba(240,136,62,0.2);color:var(--status-high)}
        .tag-moderate{background:rgba(210,153,34,0.2);color:var(--status-moderate)}
        .tag-low{background:rgba(46,160,67,0.2);color:var(--status-low)}
        .tag-subsidence{background:rgba(136,57,239,0.2);color:#8839ef}
        .tag-seismic{background:rgba(163,113,247,0.2);color:var(--brand-accent)}

        /* Result Cards */
        .result-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;margin-bottom:12px;overflow:hidden}
        .result-header{padding:10px 12px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:space-between}
        .result-title{font-size:11px;font-weight:700;display:flex;align-items:center;gap:6px}
        .result-badge{font-size:8px;padding:3px 7px;border-radius:4px;font-weight:700;text-transform:uppercase}
        .badge-critical{background:rgba(248,81,73,0.15);color:var(--status-critical)}
        .badge-high{background:rgba(240,136,62,0.15);color:var(--status-high)}
        .badge-moderate{background:rgba(210,153,34,0.15);color:var(--status-moderate)}
        .badge-low{background:rgba(46,160,67,0.15);color:var(--status-low)}
        .badge-info{background:rgba(88,166,255,0.15);color:var(--status-info)}
        .result-content{padding:12px}

        /* Data Displays */
        .data-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
        .data-grid.cols-3{grid-template-columns:repeat(3,1fr)}
        .data-grid.cols-6{grid-template-columns:repeat(6,1fr)}
        .data-item{background:var(--bg-tertiary);padding:10px 8px;border-radius:6px;text-align:center}
        .data-item.full{grid-column:span 2}
        .data-label{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:3px}
        .data-value{font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace}
        .data-value.xl{font-size:22px}
        .data-value.sm{font-size:11px;font-family:'Inter',sans-serif;font-weight:600}

        /* Risk Flags */
        .risk-flag{padding:10px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:6px;border-left:3px solid}
        .risk-flag.critical{border-left-color:var(--status-critical);background:rgba(248,81,73,0.05)}
        .risk-flag.high{border-left-color:var(--status-high);background:rgba(240,136,62,0.05)}
        .risk-flag.moderate{border-left-color:var(--status-moderate);background:rgba(210,153,34,0.05)}
        .risk-title{font-size:11px;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:5px}
        .risk-detail{font-size:10px;color:var(--text-secondary);line-height:1.4}

        /* Score Card */
        .score-card{background:linear-gradient(135deg,rgba(46,160,67,0.08),rgba(88,166,255,0.08));border:1px solid rgba(46,160,67,0.25)}
        .score-card .result-header{background:linear-gradient(135deg,rgba(46,160,67,0.15),rgba(88,166,255,0.15))}
        .overall-score{text-align:center;padding:16px;background:var(--bg-primary);border-radius:8px;margin-bottom:10px;position:relative;overflow:hidden}
        .overall-score::before{content:'';position:absolute;inset:0;background:var(--gradient-glow);opacity:0.5}
        .overall-score-label{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px;position:relative}
        .overall-score-value{font-size:44px;font-weight:900;font-family:'JetBrains Mono',monospace;line-height:1;position:relative}
        .overall-score-scale{font-size:9px;color:var(--text-muted);margin-top:4px;position:relative}
        .score-breakdown{display:grid;grid-template-columns:repeat(6,1fr);gap:4px;margin-top:10px}
        .score-item{background:var(--bg-tertiary);padding:8px 4px;border-radius:6px;text-align:center}
        .score-item-label{font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);margin-bottom:2px}
        .score-item-value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
        .score-item-weight{font-size:7px;color:var(--text-muted)}
        .recommendation-box{text-align:center;padding:12px;background:var(--bg-primary);border-radius:8px;margin-top:10px}
        .recommendation-label{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px}
        .recommendation-value{font-size:14px;font-weight:800}

        /* Special Cards */
        .seismic-card{background:linear-gradient(135deg,rgba(163,113,247,0.08),rgba(88,166,255,0.08));border:1px solid rgba(163,113,247,0.25)}
        .seismic-card .result-header{background:linear-gradient(135deg,rgba(163,113,247,0.15),rgba(88,166,255,0.15))}
        .wui-card{background:linear-gradient(135deg,rgba(248,81,73,0.08),rgba(240,136,62,0.08));border:1px solid rgba(248,81,73,0.25)}
        .wui-card .result-header{background:linear-gradient(135deg,rgba(248,81,73,0.15),rgba(240,136,62,0.15))}
        .subsidence-card{background:linear-gradient(135deg,rgba(136,57,239,0.08),rgba(163,113,247,0.08));border:1px solid rgba(136,57,239,0.25)}
        .subsidence-card .result-header{background:linear-gradient(135deg,rgba(136,57,239,0.15),rgba(163,113,247,0.15))}
        .athenium-card{background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(163,113,247,0.08));border:1px solid rgba(88,166,255,0.25)}
        .athenium-card .result-header{background:linear-gradient(135deg,rgba(88,166,255,0.15),rgba(163,113,247,0.15))}

        /* Athenium Input */
        .athenium-paste{width:100%;min-height:90px;padding:10px;background:var(--bg-tertiary);border:1px dashed var(--border-color);border-radius:6px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:9px;resize:vertical;margin-bottom:8px}
        .athenium-paste:focus{outline:none;border-color:var(--status-info);border-style:solid}
        .parse-btn{width:100%;padding:9px;background:var(--status-info);border:none;border-radius:6px;color:white;font-weight:700;font-size:11px;cursor:pointer}
        .athenium-display{margin-top:10px;background:var(--bg-tertiary);border-radius:6px;padding:10px}
        .athenium-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:10px;border-bottom:1px solid var(--border-color)}
        .athenium-row:last-child{border-bottom:none}

        /* Export */
        .export-section{padding:12px;background:var(--bg-tertiary);border-top:1px solid var(--border-color);flex-shrink:0}
        .export-btn{width:100%;padding:10px;border-radius:8px;font-weight:700;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:6px}
        .export-btn:last-child{margin-bottom:0}
        .export-btn.primary{background:var(--gradient-brand);border:none;color:white}
        .export-btn.secondary{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary)}

        /* Map */
        .map-container{position:relative;background:var(--bg-primary)}
        #map{width:100%;height:100%}
        .map-loading{position:absolute;inset:0;background:rgba(8,11,16,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
        .map-loading.active{display:flex}
        .loading-spinner{width:36px;height:36px;border:3px solid var(--border-color);border-top-color:var(--brand-primary);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px}
        .loading-text{font-size:13px;color:var(--text-secondary)}
        .loading-detail{font-size:10px;color:var(--text-muted);margin-top:4px}
        .loading-steps{margin-top:12px;text-align:left}
        .loading-step{font-size:9px;color:var(--text-muted);padding:3px 0;display:flex;align-items:center;gap:6px}
        .loading-step.active{color:var(--brand-primary)}
        .loading-step.done{color:var(--status-low)}
        .loading-step.error{color:var(--status-critical)}
        .loading-step .check{font-weight:bold}

        /* Map Controls */
        .map-controls{position:absolute;top:12px;left:12px;z-index:10;display:flex;flex-direction:column;gap:6px}
        .map-control-card{background:rgba(8,11,16,0.92);border:1px solid var(--border-color);border-radius:8px;padding:10px;backdrop-filter:blur(12px);min-width:150px}
        .map-control-title{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;gap:4px}
        .map-control-title .dot{width:5px;height:5px;border-radius:50%;background:var(--brand-primary)}
        .map-toggle{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;color:var(--text-secondary);cursor:pointer}
        .map-toggle:hover{color:var(--text-primary)}
        .map-toggle input{accent-color:var(--brand-primary);width:12px;height:12px}
        .map-toggle .badge{font-size:7px;padding:1px 4px;background:var(--brand-accent);color:white;border-radius:3px;font-weight:600;margin-left:auto}

        /* Map Info */
        .map-info{position:absolute;top:12px;right:12px;background:rgba(8,11,16,0.92);border:1px solid var(--border-color);border-radius:10px;padding:12px;backdrop-filter:blur(12px);min-width:200px;z-index:10}
        .map-info-header{display:flex;align-items:center;gap:6px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border-color)}
        .map-info-title{font-size:12px;font-weight:700}
        .map-info-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:10px;border-bottom:1px solid var(--border-color)}
        .map-info-row:last-child{border-bottom:none}
        .map-info-label{color:var(--text-muted)}
        .map-info-value{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:9px}

        /* Map Legend */
        .map-legend{position:absolute;bottom:24px;left:12px;background:rgba(8,11,16,0.92);border:1px solid var(--border-color);border-radius:8px;padding:10px 12px;backdrop-filter:blur(12px);z-index:10}
        .legend-title{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:6px}
        .legend-item{display:flex;align-items:center;gap:6px;font-size:9px;color:var(--text-secondary);margin-bottom:3px}
        .legend-item:last-child{margin-bottom:0}
        .legend-dot{width:10px;height:10px;border-radius:50%;border:2px solid rgba(255,255,255,0.8)}
        .legend-line{width:16px;height:3px;border-radius:2px}
        .legend-rect{width:16px;height:10px;border-radius:2px;opacity:0.7}

        /* Tip Box */
        .tip-box{background:var(--bg-card);border:1px dashed var(--border-color);border-radius:8px;padding:12px;text-align:center}
        .tip-icon{font-size:20px;margin-bottom:6px}
        .tip-text{font-size:10px;color:var(--text-muted);line-height:1.4}
        .tip-text strong{color:var(--text-secondary)}

        /* Scrollbar */
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:var(--bg-primary)}
        ::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}

        /* Mapbox Popup */
        .mapboxgl-popup-content{background:var(--bg-card);color:var(--text-primary);border-radius:8px;padding:10px 12px;border:1px solid var(--border-color);box-shadow:0 8px 32px rgba(0,0,0,0.5)}
        .mapboxgl-popup-tip{border-top-color:var(--bg-card)}
        .popup-title{font-size:11px;font-weight:700;margin-bottom:3px}
        .popup-detail{font-size:9px;color:var(--text-secondary)}

        /* Animations */
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(46,160,67,0.3)}50%{box-shadow:0 0 40px rgba(46,160,67,0.5)}}
        .pulse{animation:pulse 2s ease-in-out infinite}
        .glow{animation:glow 2s ease-in-out infinite}
        
        /* Flood Risk Card */
        .flood-card{background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(46,160,67,0.08));border:1px solid rgba(88,166,255,0.25)}
        .flood-card .result-header{background:linear-gradient(135deg,rgba(88,166,255,0.15),rgba(46,160,67,0.15))}
        .freeboard-warning{padding:8px;background:rgba(248,81,73,0.15);border-left:3px solid var(--status-critical);border-radius:0 6px 6px 0;margin-top:8px;font-size:10px}
        .freeboard-ok{padding:8px;background:rgba(46,160,67,0.15);border-left:3px solid var(--status-low);border-radius:0 6px 6px 0;margin-top:8px;font-size:10px}
        .freeboard-moderate{padding:8px;background:rgba(210,153,34,0.15);border-left:3px solid var(--status-moderate);border-radius:0 6px 6px 0;margin-top:8px;font-size:10px}
        /* Historical Validation Card */
        .history-card{background:linear-gradient(135deg,rgba(240,136,62,0.08),rgba(210,153,34,0.08));border:1px solid rgba(240,136,62,0.25)}
        .history-card .result-header{background:linear-gradient(135deg,rgba(240,136,62,0.15),rgba(210,153,34,0.15))}
        .hurricane-timeline{margin-top:10px;padding:10px;background:var(--bg-tertiary);border-radius:6px}
        .hurricane-event{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border-color);font-size:10px}
        .hurricane-event:last-child{border-bottom:none}
        .hurricane-name{font-weight:700}
        .hurricane-date{color:var(--text-muted);font-size:9px}
        .hurricane-wind{font-family:'JetBrains Mono',monospace;font-weight:600}

        /* Responsive Fixes */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 320px 1fr;
            }
            .panel-right {
                display: none; /* Hide right panel initially on tablets */
            }
            .panel-right.active {
                display: flex; position: fixed; inset: 0; z-index: 1000;
            }
        }
        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
                overflow: visible;
            }
            .map-container {
                height: 50vh;
                min-height: 400px;
                order: -1; /* Map on top */
            }
            .panel {
                height: auto;
                max-height: none;
                overflow: visible;
            }
            .panel-left, .panel-right {
                border: none;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="#" class="logo-link">
                <span class="logo-fallback" style="color:white;font-weight:700;font-size:18px">SiteScore‚Ñ¢</span>
            </a>
            <span class="version">v1.3.5 (FIXED)</span>
        </div>
        <div class="header-scores">
            <div class="score-pill main"><div class="score-pill-value" id="headerScore">‚Äî</div><div class="score-pill-label">Score</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerKarst">‚Äî</div><div class="score-pill-label">Karst</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerSeismic">‚Äî</div><div class="score-pill-label">Seismic</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerFlood">‚Äî</div><div class="score-pill-label">Flood</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerWildfire">‚Äî</div><div class="score-pill-label">Fire</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerWind">‚Äî</div><div class="score-pill-label">Wind</div></div>
        </div>
    </header>

    <div class="main-container">
        <div class="panel panel-left">
            <div class="panel-header"><span>üìç</span> Site Analysis</div>
            <div class="panel-content">
                <div class="input-section">
                    <div class="input-field">
                        <label>Address Lookup</label>
                        <div class="input-row">
                            <input type="text" id="addressInput" placeholder="123 Main St, City, State">
                            <button onclick="geocodeAddress()">üîç Find</button>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Project Name</label>
                        <input type="text" id="projectName" placeholder="e.g., Norfolk State Science Building">
                    </div>
                    <div class="coord-row">
                        <div class="input-field"><label>Latitude</label><input type="text" id="lat" placeholder="35.9427"></div>
                        <div class="input-field"><label>Longitude</label><input type="text" id="lon" placeholder="-83.9510"></div>
                    </div>
                    <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()"><span>‚ö°</span> Analyze Site</button>
                    <div class="quick-locations">
                        <div class="quick-title">Test Locations</div>
                        <button class="quick-btn" onclick="setLocation('UT MFR Research',35.9427,-83.9510)"><span class="icon">üï≥Ô∏è</span><span class="name">Knoxville TN</span><span class="tag tag-critical">KARST</span></button>
                        <button class="quick-btn" onclick="setLocation('LA Office Tower',34.0522,-118.2437)"><span class="icon">üåã</span><span class="name">Los Angeles CA</span><span class="tag tag-seismic">SEISMIC</span></button>
                        <button class="quick-btn" onclick="setLocation('Lake Arrowhead Resort',34.248,-117.189)"><span class="icon">üî•</span><span class="name">Lake Arrowhead CA</span><span class="tag tag-critical">WUI</span></button>
                        <button class="quick-btn" onclick="setLocation('USD Phase 1B',37.592665,-122.089949)"><span class="icon">üåä</span><span class="name">Union City CA</span><span class="tag tag-high">LIQUEFACTION</span></button>
                        <button class="quick-btn" onclick="setLocation('Corcoran Ag Facility',36.098,-119.56)"><span class="icon">üìâ</span><span class="name">Corcoran CA</span><span class="tag tag-subsidence">SUBSIDENCE</span></button>
                    </div>
                    <div style="font-size:9px;color:var(--text-muted);margin-top:10px;padding:8px;background:var(--bg-tertiary);border-radius:6px;text-align:center">üí° Click map to set coordinates</div>
                </div>
                <div id="resultsContainer"></div>
            </div>
            <div class="export-section">
                <button class="export-btn primary" onclick="generateReport()">üìÑ Generate Report</button>
                <button class="export-btn secondary" onclick="copyJSON()">üìã Copy JSON</button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="map-loading" id="mapLoading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Analyzing Site...</div>
                <div class="loading-detail" id="loadingDetail">Initializing...</div>
                <div class="loading-steps" id="loadingSteps"></div>
            </div>
            <div class="map-controls">
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> Basemap</div>
                    <label class="map-toggle"><input type="radio" name="basemap" value="terrain" checked onchange="setBasemap('terrain')"> Terrain</label>
                    <label class="map-toggle"><input type="radio" name="basemap" value="satellite" onchange="setBasemap('satellite')"> Satellite</label>
                </div>
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> Karst Data</div>
                    <label class="map-toggle"><input type="checkbox" id="toggleSinks" checked onchange="toggleFeatures('sink')"> üï≥Ô∏è Sinks</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleSprings" checked onchange="toggleFeatures('spring')"> üíß Springs</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleFlowlines" checked onchange="toggleFlowlines()"> üåä Flowlines</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleKarstTerrain" onchange="toggleKarstTerrain()"> üó∫Ô∏è Karst Terrain<span class="badge">NEW</span></label>
                </div>
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> Hazard Zones</div>
                    <label class="map-toggle"><input type="checkbox" id="toggleFemaFlood" onchange="toggleFEMAFlood()"> üåä FEMA Flood</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleWUI" onchange="toggleWUILayer()"> üî• WUI National</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleFHSZ" onchange="toggleFHSZLayer()"> üî• CA Fire Hazard</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleCASubsidence" onchange="toggleCASubsidenceLayer()"> üìâ CA Subsidence<span class="badge">NEW</span></label>
                </div>
            </div>
            <div class="map-info">
                <div class="map-info-header"><span style="font-size:14px">üìç</span><span class="map-info-title">Site Info</span></div>
                <div class="map-info-row"><span class="map-info-label">Coordinates</span><span class="map-info-value" id="infoCoords">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Elevation</span><span class="map-info-value" id="infoElevation">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Nearest Sink</span><span class="map-info-value" id="infoSink">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Karst Terrain</span><span class="map-info-value" id="infoKarstTerrain">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Seismic PGA</span><span class="map-info-value" id="infoPGA">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">WUI Class</span><span class="map-info-value" id="infoWUI">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">CA Fire Zone</span><span class="map-info-value" id="infoFHSZ">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">CA Subsidence</span><span class="map-info-value" id="infoSubsidence">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">CA Liquefaction</span><span class="map-info-value" id="infoLiquefaction">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Soil Type</span><span class="map-info-value" id="infoSoil">‚Äî</span></div>
            </div>
            <div class="map-legend">
                <div class="legend-title">Legend</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f85149"></div> Site</div>
                <div class="legend-item"><div class="legend-dot" style="background:#a371f7"></div> Sink</div>
                <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div> Spring</div>
                <div class="legend-item"><div class="legend-line" style="background:#58a6ff"></div> Flowline</div>
                <div class="legend-item"><div class="legend-rect" style="background:#6366f1"></div> Karst Terrain</div>
                <div class="legend-item"><div class="legend-rect" style="background:rgba(0,112,255,0.5)"></div> FEMA Flood</div>
                <div class="legend-item"><div class="legend-rect" style="background:#f97316"></div> WUI Zone</div>
                <div class="legend-item"><div class="legend-rect" style="background:#dc2626"></div> CA Subsidence</div>
            </div>
        </div>

        <div class="panel panel-right">
            <div class="panel-header"><span>üéØ</span> Risk Scoring</div>
            <div class="panel-content">
                <div class="result-card score-card" id="scoreCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üéØ</span> Site Risk Score</div></div>
                    <div class="result-content">
                        <div class="overall-score">
                            <div class="overall-score-label">Overall Risk Score</div>
                            <div class="overall-score-value" id="overallScore">‚Äî</div>
                            <div class="overall-score-scale">0 = Best ‚Ä¢ 10 = Worst</div>
                        </div>
                        <div class="score-breakdown" style="grid-template-columns:repeat(7,1fr)">
                            <div class="score-item"><div class="score-item-label">Karst</div><div class="score-item-value" id="scoreKarst">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Seismic</div><div class="score-item-value" id="scoreSeismic">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Flood</div><div class="score-item-value" id="scoreFlood">‚Äî</div><div class="score-item-weight">20%</div></div>
                            <div class="score-item"><div class="score-item-label">Wildfire</div><div class="score-item-value" id="scoreWildfire">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Wind</div><div class="score-item-value" id="scoreWind">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Soil</div><div class="score-item-value" id="scoreSoil">‚Äî</div><div class="score-item-weight">10%</div></div>
                            <div class="score-item"><div class="score-item-label">Subsid.</div><div class="score-item-value" id="scoreSubsidence">‚Äî</div><div class="score-item-weight">10%</div></div>
                        </div>
                        <div class="recommendation-box">
                            <div class="recommendation-label">Recommendation</div>
                            <div class="recommendation-value" id="recommendation">‚Äî</div>
                        </div>
                    </div>
                </div>
                <div class="result-card seismic-card" id="seismicCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üåã</span> USGS Seismic</div><span class="result-badge badge-low" id="seismicBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid cols-3">
                            <div class="data-item"><div class="data-label">PGA</div><div class="data-value" id="seismicPGA">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Score</div><div class="data-value" id="seismicScore">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">SDC</div><div class="data-value" id="seismicSDC">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card wui-card" id="wuiCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üî•</span> Wildfire / WUI</div><span class="result-badge badge-low" id="wuiBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">WUI Class</div><div class="data-value sm" id="wuiClass">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Fire Score</div><div class="data-value" id="wuiScore">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">CA FHSZ</div><div class="data-value" id="caFireSeverity">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Veg Cover</div><div class="data-value" id="wuiVeg">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card subsidence-card" id="subsidenceCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üìâ</span> CA Ground Subsidence</div><span class="result-badge badge-low" id="subsidenceBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Annual Rate</div><div class="data-value" id="subsidenceRate">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Score</div><div class="data-value" id="subsidenceScore">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Total (2015+)</div><div class="data-value" id="subsidenceTotal">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Data Source</div><div class="data-value sm" id="subsidenceSource">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                                <div class="result-card flood-card" id="floodRiskCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üåä</span> Flood Risk Analysis</div><span class="result-badge badge-info" id="floodRiskBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">River Flood</div><div class="data-value" id="floodRiver">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Flash Flood</div><div class="data-value" id="floodFlash">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">FEMA Zone</div><div class="data-value" id="floodFema">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">BFE</div><div class="data-value" id="floodBfe">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Elevation</div><div class="data-value" id="floodElev">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Freeboard</div><div class="data-value" id="floodFreeboard">‚Äî</div></div>
                        </div>
                        <div id="freeboardAlert"></div>
                        <div class="data-grid" style="margin-top:8px">
                            <div class="data-item"><div class="data-label">100-yr Depth</div><div class="data-value" id="floodInund100">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">500-yr Depth</div><div class="data-value" id="floodInund500">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card history-card" id="historyCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üìú</span> Historical Validation</div><span class="result-badge badge-info" id="historyBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Hail Events</div><div class="data-value" id="histHail">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Wind Events</div><div class="data-value" id="histWind">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Max Hail</div><div class="data-value" id="histMaxHail">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Max Wind</div><div class="data-value" id="histMaxWind">‚Äî</div></div>
                        </div>
                        <div class="hurricane-timeline" id="hurricaneTimeline" style="display:none">
                            <div style="font-size:9px;font-weight:600;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">üåÄ Hurricane History</div>
                            <div id="hurricaneEvents"></div>
                        </div>
                    </div>
                </div>
                <div class="result-card athenium-card">
                    <div class="result-header"><div class="result-title"><span>üìä</span> Athenium Climate Data</div></div>
                    <div class="result-content">
                        <textarea class="athenium-paste" id="atheniumPaste" placeholder="Paste Athenium MCP output...

River Flood Score: 0.4/10
Flash Flood Score: 3.6/10
Wildfire: 7/10
Wind: 9/10
Hail: 5/10"></textarea>
                        <button class="parse-btn" onclick="parseAthenium()">Parse & Recalculate</button>
                        <div class="athenium-display" id="atheniumDisplay" style="display:none"><div id="atheniumParsed"></div></div>
                    </div>
                </div>
                <div class="tip-box">
                    <div class="tip-icon">üí°</div>
                    <div class="tip-text"><strong>Higher Score = Higher Risk</strong><br>Paste Athenium flood/wind data to complete the composite score calculation.</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWVyb3N1cmUiLCJhIjoiY21qNTZvMTlyMHV5aTNnb2dib2JuaXFyMSJ9.WN3RY1Ne-VQjn0o51xvEkQ';
        
        const API = {
            THREEDP: 'https://3dhp.nationalmap.gov/arcgis/rest/services/usgs_3dhp_all/FeatureServer',
            SSURGO_WFS: 'https://sdmdataaccess.sc.egov.usda.gov/Spatial/SDMWGS84Geographic.wfs',
            SSURGO_SQL: 'https://sdmdataaccess.sc.egov.usda.gov/tabular/post.rest',
            USGS_ELEV: 'https://epqs.nationalmap.gov/v1/json',
            USGS_SEISMIC: 'https://earthquake.usgs.gov/ws/designmaps',
            USGS_WMS: 'https://elevation.nationalmap.gov/arcgis/services/3DEPElevation/ImageServer/WMSServer',
            FEMA_NFHL: 'https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer',
            USFS_WUI: 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_WUI_2020_01/MapServer/0',
            CA_FHSZ_SRA: 'https://services.gis.ca.gov/arcgis/rest/services/Environment/Fire_Severity_Zones/MapServer/0',
            CA_FHSZ_LRA: 'https://services.gis.ca.gov/arcgis/rest/services/Environment/Fire_Severity_Zones/MapServer/1',
            USGS_KARST: 'https://mrdata.usgs.gov/services/karst',
            CA_SUBSIDENCE_POINTS: 'https://gis.water.ca.gov/arcgis/rest/services/Elevation/Vertical_Displacement_Point_Data_Locations_2024Q1/MapServer/0',
            CA_SUBSIDENCE_RASTER: 'https://gis.water.ca.gov/arcgisimg/rest/services/SAR/Vertical_Displacement_TRE_ALTAMIRA_Annual_Rate_20230101_20240101/ImageServer',
            CA_CGS_LIQUEFACTION: 'https://services.gis.ca.gov/arcgis/rest/services/GeoscientificInformation/Liquefaction/MapServer/0'
        };

        const WEIGHTS = {
            karst: 0.15,
            seismic: 0.15,
            flood: 0.20,
            wildfire: 0.15,
            wind: 0.15,
            soil: 0.10,
            subsidence: 0.10
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let map, siteMarker = null, featureMarkers = [];
        let layerStates = { femaFlood: false, wui: false, fhsz: false, hillshade: false, contours: false, karstTerrain: false, caSubsidence: false };
        
        const data = {
            project: null,
            coordinates: null,
            elevation: null,
            karst: null,
            karstTerrain: null,
            soil: null,
            seismic: null,
            wui: null,
            subsidence: null,
            liquefaction: null,
            athenium: null,
            flags: [],
            scores: { karst: null, seismic: null, flood: null, wildfire: null, wind: null, soil: null, subsidence: null, overall: null },
            timestamp: null
        };

        // ============================================
        // MAP INITIALIZATION
        // ============================================
        function initMap() {
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/outdoors-v12',
                    center: [-98, 39],
                    zoom: 4,
                    preserveDrawingBuffer: true // CRITICAL FOR REPORT GENERATION
                });

                map.on('load', function() {
                    map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize: 512 });
                    map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
                    // Load prev session if exists
                    loadFromStorage();
                });

                map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
                map.addControl(new mapboxgl.ScaleControl({ unit: 'imperial' }), 'bottom-left');

                map.on('click', async function(e) {
                    document.getElementById('lat').value = e.lngLat.lat.toFixed(6);
                    document.getElementById('lon').value = e.lngLat.lng.toFixed(6);
                    document.getElementById('infoCoords').textContent = e.lngLat.lat.toFixed(4) + ', ' + e.lngLat.lng.toFixed(4);
                    // Fast elevation fetch on click
                    fetchElevation(e.lngLat.lat, e.lngLat.lng).then(elev => {
                        if(elev !== null) document.getElementById('infoElevation').textContent = elev.toFixed(1) + ' ft';
                    });
                });
            } catch (e) {
                console.error("Mapbox init failed. Check token.", e);
                document.getElementById('map').innerHTML = '<div style="color:white;text-align:center;padding:20px;">Map failed to load. Please check your Mapbox Access Token.</div>';
            }
        }

        // ============================================
        // UTILS: Safe Fetch & Storage
        // ============================================
        async function safeFetch(promise, name, timeout = 10000) {
            try {
                const res = await Promise.race([
                    promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))
                ]);
                return res;
            } catch (e) {
                console.warn(`[${name}] API failed or timed out:`, e);
                updateLoadingStep(name, 'error');
                return null;
            }
        }

        function saveToStorage() {
            localStorage.setItem('siteScoreData', JSON.stringify({
                lat: document.getElementById('lat').value,
                lon: document.getElementById('lon').value,
                project: document.getElementById('projectName').value,
                data: data
            }));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('siteScoreData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.lat) document.getElementById('lat').value = parsed.lat;
                    if (parsed.lon) document.getElementById('lon').value = parsed.lon;
                    if (parsed.project) document.getElementById('projectName').value = parsed.project;
                    // Restore basic state if needed, but usually we want user to re-run for freshness
                    // flyToSite(parsed.lat, parsed.lon);
                } catch(e) {}
            }
        }

        // ============================================
        // MAP LAYERS
        // ============================================
        function setBasemap(style) {
            const styles = {
                terrain: 'mapbox://styles/mapbox/outdoors-v12',
                satellite: 'mapbox://styles/mapbox/satellite-streets-v12'
            };
            const savedStates = { ...layerStates };
            map.setStyle(styles[style]);
            map.once('style.load', function() {
                if (!map.getSource('mapbox-dem')) {
                    map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize: 512 });
                }
                map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
                // Restore active layers
                if (savedStates.femaFlood) { layerStates.femaFlood = false; document.getElementById('toggleFemaFlood').checked = true; toggleFEMAFlood(); }
                if (savedStates.wui) { layerStates.wui = false; document.getElementById('toggleWUI').checked = true; toggleWUILayer(); }
                if (savedStates.fhsz) { layerStates.fhsz = false; document.getElementById('toggleFHSZ').checked = true; toggleFHSZLayer(); }
                if (savedStates.karstTerrain) { layerStates.karstTerrain = false; document.getElementById('toggleKarstTerrain').checked = true; toggleKarstTerrain(); }
                if (savedStates.caSubsidence) { layerStates.caSubsidence = false; document.getElementById('toggleCASubsidence').checked = true; toggleCASubsidenceLayer(); }
            });
        }

        function toggleFEMAFlood() {
            const checkbox = document.getElementById('toggleFemaFlood');
            const layerId = 'fema-flood';
            if (checkbox.checked) {
                if (map.getLayer(layerId)) map.removeLayer(layerId);
                if (map.getSource('fema-flood-source')) map.removeSource('fema-flood-source');
                map.addSource('fema-flood-source', {
                    type: 'raster',
                    tiles: ['https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&layers=show:28&f=image'],
                    tileSize: 256
                });
                map.addLayer({ id: layerId, type: 'raster', source: 'fema-flood-source', paint: { 'raster-opacity': 0.6 }, minzoom: 9 });
                layerStates.femaFlood = true;
            } else {
                if (map.getLayer(layerId)) map.setLayoutProperty(layerId, 'visibility', 'none');
                layerStates.femaFlood = false;
            }
        }
        // ... (Other toggle functions similar structure, kept concise for brevity)
        function toggleWUILayer() {
             const checkbox = document.getElementById('toggleWUI');
             if(checkbox.checked){
                 if(map.getSource('wui-source')) map.removeSource('wui-source');
                 map.addSource('wui-source', { type:'raster', tiles:['https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_WUI_2020_01/MapServer/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&layers=show:0&f=image'], tileSize:256});
                 map.addLayer({id:'wui-layer', type:'raster', source:'wui-source', paint:{'raster-opacity':0.55}, minzoom:8});
                 layerStates.wui = true;
             } else { if(map.getLayer('wui-layer')) map.removeLayer('wui-layer'); layerStates.wui = false; }
        }
        function toggleFHSZLayer() {
             const checkbox = document.getElementById('toggleFHSZ');
             if(checkbox.checked){
                 if(map.getSource('fhsz-source')) map.removeSource('fhsz-source');
                 map.addSource('fhsz-source', { type:'raster', tiles:['https://services.gis.ca.gov/arcgis/rest/services/Environment/Fire_Severity_Zones/MapServer/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&layers=show:0,1,2,3,4,5&f=image'], tileSize:256});
                 map.addLayer({id:'fhsz-layer', type:'raster', source:'fhsz-source', paint:{'raster-opacity':0.5}, minzoom:8});
                 layerStates.fhsz = true;
             } else { if(map.getLayer('fhsz-layer')) map.removeLayer('fhsz-layer'); layerStates.fhsz = false; }
        }
        function toggleKarstTerrain() {
             const checkbox = document.getElementById('toggleKarstTerrain');
             if(checkbox.checked){
                 if(map.getSource('karst-source')) map.removeSource('karst-source');
                 map.addSource('karst-source', { type:'raster', tiles:['https://tiles.arcgis.com/tiles/hoKRg7d6zCP8hwp2/arcgis/rest/services/Carbonate_Karst/MapServer/tile/{z}/{y}/{x}'], tileSize:256});
                 map.addLayer({id:'karst-layer', type:'raster', source:'karst-source', paint:{'raster-opacity':0.6}, minzoom:5});
                 layerStates.karstTerrain = true;
             } else { if(map.getLayer('karst-layer')) map.removeLayer('karst-layer'); layerStates.karstTerrain = false; }
        }
        function toggleCASubsidenceLayer() {
             const checkbox = document.getElementById('toggleCASubsidence');
             if(checkbox.checked){
                 if(map.getSource('sub-source')) map.removeSource('sub-source');
                 map.addSource('sub-source', { type:'raster', tiles:['https://gis.water.ca.gov/arcgisimg/rest/services/SAR/Vertical_Displacement_TRE_ALTAMIRA_Annual_Rate_20230101_20240101/ImageServer/exportImage?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&f=image'], tileSize:256});
                 map.addLayer({id:'sub-layer', type:'raster', source:'sub-source', paint:{'raster-opacity':0.7}, minzoom:8});
                 layerStates.caSubsidence = true;
             } else { if(map.getLayer('sub-layer')) map.removeLayer('sub-layer'); layerStates.caSubsidence = false; }
        }
        function toggleFeatures(type) {
            const checkbox = document.getElementById('toggle' + (type === 'sink' ? 'Sinks' : 'Springs'));
            featureMarkers.filter(m => m._type === type).forEach(m => {
                m.getElement().style.display = checkbox.checked ? 'block' : 'none';
            });
        }
        function toggleFlowlines() {
            const checkbox = document.getElementById('toggleFlowlines');
            if (map.getLayer('flowlines-layer')) {
                map.setLayoutProperty('flowlines-layer', 'visibility', checkbox.checked ? 'visible' : 'none');
            }
        }

        // ============================================
        // API CALLS
        // ============================================
        async function geocodeAddress() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) return;
            try {
                const res = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&country=US&limit=1`).then(r => r.json());
                if (res.features && res.features.length) {
                    const [lon, lat] = res.features[0].center;
                    document.getElementById('lat').value = lat.toFixed(6);
                    document.getElementById('lon').value = lon.toFixed(6);
                    if (!document.getElementById('projectName').value) {
                        document.getElementById('projectName').value = res.features[0].place_name.split(',')[0];
                    }
                    flyToSite(lat, lon);
                } else { alert('Address not found'); }
            } catch (e) { alert('Geocode error'); }
        }

        async function fetchElevation(lat, lon) {
            try {
                const res = await fetch(`${API.USGS_ELEV}?x=${lon}&y=${lat}&units=Feet&wkid=4326`).then(r => r.json());
                return res.value !== undefined ? res.value : null;
            } catch (e) { return null; }
        }

        async function fetch3DHP(lat, lon) {
            const bbox = (lon - 0.1) + ',' + (lat - 0.1) + ',' + (lon + 0.1) + ',' + (lat + 0.1);
            const params = '&geometryType=esriGeometryEnvelope&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&outSR=4326&f=json';
            const [sinks, springs, flowlines] = await Promise.all([
                fetch(`${API.THREEDP}/20/query?where=featuretype%3D8&geometry=${bbox}${params}`).then(r => r.json()),
                fetch(`${API.THREEDP}/20/query?where=featuretype%3D7&geometry=${bbox}${params}`).then(r => r.json()),
                fetch(`${API.THREEDP}/50/query?where=1%3D1&geometry=${bbox}${params}&resultRecordCount=50`).then(r => r.json())
            ]);
            return { sinks: sinks.features || [], springs: springs.features || [], flowlines: flowlines.features || [] };
        }

        async function fetchKarstTerrain(lat, lon) {
             try {
                // Short timeout for this specific query as it hangs often
                const ctrl = new AbortController();
                setTimeout(() => ctrl.abort(), 4000);
                const url = `${API.USGS_KARST}?SERVICE=WFS&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=karstus&BBOX=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&SRSNAME=EPSG:4326&MAXFEATURES=1`;
                const text = await fetch(url, { signal: ctrl.signal }).then(r => r.text());
                return { 
                    inKarst: text.includes('gml:featureMember') && text.includes('karstus'), 
                    rockType: text.match(/<ms:rock_type>([^<]+)<\/ms:rock_type>/)?.[1] 
                };
             } catch(e) { return { inKarst: false, error: true }; }
        }

        async function fetchSSURGO(lat, lon) {
            try {
                // Step 1: Get Map Unit Key
                const wfsRes = await fetch(`${API.SSURGO_WFS}?SERVICE=WFS&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=mapunitpoly&BBOX=${lon-0.005},${lat-0.005},${lon+0.005},${lat+0.005}&SRSNAME=EPSG:4326&MAXFEATURES=1`).then(r => r.text());
                const mukey = wfsRes.match(/<ms:mukey>(\d+)<\/ms:mukey>/)?.[1];
                if (!mukey) return null;
                // Step 2: Query Data
                const sql = `SELECT TOP 1 mu.mukey, mu.muname, c.compname, c.comppct_r, c.drainagecl, c.hydgrp, c.corcon, c.corsteel FROM mapunit mu INNER JOIN component c ON c.mukey = mu.mukey WHERE mu.mukey = '${mukey}' ORDER BY c.comppct_r DESC`;
                const dataRes = await fetch(API.SSURGO_SQL, { method: 'POST', body: JSON.stringify({ query: sql }), headers: {'Content-Type': 'application/json'} }).then(r => r.json());
                const row = dataRes.Table[0];
                return row ? { mapunit: row[1], component: row[2], drainage: row[4], hydro: row[5], corConcrete: row[6], corSteel: row[7] } : null;
            } catch(e) { return null; }
        }

        async function fetchSeismic(lat, lon) {
            try {
                const res = await fetch(`${API.USGS_SEISMIC}/asce7-16.json?latitude=${lat}&longitude=${lon}&riskCategory=II&siteClass=D&title=SiteScore`).then(r => r.json());
                const d = res.response.data;
                return { pga: d.pga, sdc: d.sdc };
            } catch(e) { return null; }
        }

        async function fetchWUI(lat, lon) {
            try {
                let result = { wuiClass: null, caFireSeverity: null, score: 0 };
                // USFS
                const wuiRes = await fetch(`${API.USFS_WUI}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=WUICLASS2020,VEG2019PC&returnGeometry=false&f=json`).then(r => r.json());
                if (wuiRes.features?.length) {
                    result.wuiClass = wuiRes.features[0].attributes.WUICLASS2020;
                    result.vegPercent = wuiRes.features[0].attributes.VEG2019PC;
                }
                // CA FHSZ
                if (lon >= -124.5 && lon <= -114 && lat >= 32.5 && lat <= 42) {
                    const sra = await fetch(`${API.CA_FHSZ_SRA}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&outFields=HAZ_CLASS&f=json`).then(r => r.json());
                    if (sra.features?.length) result.caFireSeverity = sra.features[0].attributes.HAZ_CLASS;
                    else {
                        const lra = await fetch(`${API.CA_FHSZ_LRA}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&outFields=HAZ_CLASS&f=json`).then(r => r.json());
                        if (lra.features?.length) result.caFireSeverity = lra.features[0].attributes.HAZ_CLASS;
                    }
                }
                // Scoring
                let score = 0;
                if (result.caFireSeverity === 'Very High') score = 10;
                else if (result.caFireSeverity === 'High') score = 8;
                else if (result.wuiClass && result.wuiClass.includes('Intermix')) score = 8;
                else if (result.wuiClass && result.wuiClass.includes('Interface')) score = 6;
                result.score = score;
                return result;
            } catch(e) { return null; }
        }

        // ============================================
        // CALCULATION LOGIC
        // ============================================
        function calculateScores() {
            // Karst
            let kScore = 0;
            if (data.karst) {
                const nearest = data.karst.sinks[0]?.dist || 999;
                if (nearest < 0.5) kScore = 10;
                else if (nearest < 1) kScore = 9;
                else if (nearest < 2) kScore = 8;
                else if (nearest < 3) kScore = 7;
                else if (nearest < 5) kScore = 4;
                if (data.karstTerrain?.inKarst && kScore < 3) kScore = 3;
                data.scores.karst = kScore;
            }

            // Seismic
            if (data.seismic?.pga) {
                const pga = data.seismic.pga;
                data.scores.seismic = pga >= 0.6 ? 10 : pga >= 0.4 ? 8 : pga >= 0.2 ? 6 : pga >= 0.1 ? 3 : 1;
            }

            // Soil
            if (data.soil) {
                let sScore = 2;
                if (data.soil.mapunit.toLowerCase().includes('dump')) sScore = 10;
                else if (data.soil.component.toLowerCase().includes('udorthent')) sScore = 8;
                else {
                    if (data.soil.drainage.includes('Poor')) sScore += 3;
                    if (data.soil.corSteel === 'High') sScore += 2;
                }
                data.scores.soil = Math.min(10, sScore);
            }

            // Dynamic Weighting
            let weightedSum = 0;
            let totalWeight = 0;

            const addScore = (key, weight) => {
                if (data.scores[key] !== null) {
                    weightedSum += data.scores[key] * weight;
                    totalWeight += weight;
                }
            };

            addScore('karst', WEIGHTS.karst);
            addScore('seismic', WEIGHTS.seismic);
            addScore('flood', WEIGHTS.flood); // From Athenium
            addScore('wildfire', WEIGHTS.wildfire); // WUI or Athenium
            addScore('wind', WEIGHTS.wind); // Athenium
            addScore('soil', WEIGHTS.soil);
            addScore('subsidence', WEIGHTS.subsidence);

            data.scores.overall = totalWeight > 0 ? (weightedSum / totalWeight).toFixed(1) : null;
        }

        function generateFlags() {
            data.flags = [];
            // Simplified flag logic
            if (data.scores.karst >= 6) data.flags.push({severity: 'critical', title: 'High Karst Risk', detail: 'Sinkholes detected nearby.'});
            if (data.scores.seismic >= 6) data.flags.push({severity: 'high', title: 'High Seismic Zone', detail: `PGA: ${(data.seismic.pga*100).toFixed(1)}%g`});
            if (data.scores.soil >= 8) data.flags.push({severity: 'critical', title: 'Poor Soil / Fill', detail: 'Possible artificial fill or dump site.'});
            if (data.floodRisk?.freeboard < 0) data.flags.push({severity: 'critical', title: 'Negative Freeboard', detail: 'Site is below BFE.'});
        }

        // ============================================
        // ATHENIUM PARSER (FIXED)
        // ============================================
        function parseAthenium() {
            const text = document.getElementById('atheniumPaste').value;
            if (!text.trim()) return;

            const extract = (regex) => {
                const match = text.match(regex);
                return match ? parseFloat(match[1].replace(/,/g, '')) : null;
            };

            const parsed = {
                river: extract(/river(?: flood)?(?: score)?.*?(\d+(?:\.\d+)?)/i),
                flash: extract(/flash(?: flood)?(?: score)?.*?(\d+(?:\.\d+)?)/i),
                wind: extract(/wind(?: score)?.*?(\d+(?:\.\d+)?)/i),
                wildfire: extract(/wildfire(?: score)?.*?(\d+(?:\.\d+)?)/i),
                fema: (text.match(/fema.*?zone[:\s]*([A-Z0-9]+)/i) || [])[1],
                floodDetails: {
                    bfe: extract(/base flood elevation[:\s]*(\d+(?:\.\d+)?)/i),
                    freeboard: extract(/freeboard[:\s]*(-?\d+(?:\.\d+)?)/i)
                }
            };

            data.athenium = parsed;
            
            // Merge scores
            if (parsed.river !== null || parsed.flash !== null) data.scores.flood = Math.max(parsed.river||0, parsed.flash||0);
            if (parsed.wind !== null) data.scores.wind = parsed.wind;
            if (parsed.wildfire !== null) data.scores.wildfire = Math.max(data.scores.wildfire||0, parsed.wildfire);
            if (parsed.floodDetails) data.floodRisk = parsed.floodDetails;

            document.getElementById('atheniumDisplay').style.display = 'block';
            document.getElementById('atheniumParsed').innerHTML = `
                <div class="athenium-row"><span>Flood</span><span>${data.scores.flood || '-'}</span></div>
                <div class="athenium-row"><span>Wind</span><span>${data.scores.wind || '-'}</span></div>
                <div class="athenium-row"><span>FEMA</span><span>${parsed.fema || '-'}</span></div>
            `;
            
            calculateScores();
            generateFlags();
            renderResults();
            updateHeader();
            updateScoreCard();
        }

        // ============================================
        // MAIN RUN
        // ============================================
        function updateLoadingStep(step, status) {
            const container = document.getElementById('loadingSteps');
            let el = document.getElementById(`step-${step}`);
            if (!el) {
                el = document.createElement('div');
                el.id = `step-${step}`;
                el.className = 'loading-step';
                container.appendChild(el);
            }
            el.className = `loading-step ${status}`;
            const icon = status === 'done' ? '‚úì' : status === 'error' ? '‚ö†Ô∏è' : '‚óå';
            el.innerHTML = `<span class="check">${icon}</span> ${step}`;
        }

        async function runAnalysis() {
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            
            if (!lat || !lon) { alert("Please set a location"); return; }
            
            data.coordinates = { lat, lon };
            data.project = document.getElementById('projectName').value || 'Unnamed';
            saveToStorage();

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            document.getElementById('mapLoading').classList.add('active');
            document.getElementById('loadingSteps').innerHTML = '';

            // 1. Elevation
            updateLoadingStep('Elevation', 'active');
            data.elevation = await safeFetch(fetchElevation(lat, lon), 'Elevation');
            updateLoadingStep('Elevation', 'done');

            // 2. Karst
            updateLoadingStep('Karst', 'active');
            const kData = await safeFetch(fetch3DHP(lat, lon), 'Karst Features');
            data.karstTerrain = await safeFetch(fetchKarstTerrain(lat, lon), 'Karst Terrain', 4000);
            
            if (kData) {
                const sinks = kData.sinks.map(f => ({ dist: haversine(lat, lon, f.geometry.y, f.geometry.x), ...f })).sort((a,b)=>a.dist-b.dist);
                const springs = kData.springs.map(f => ({ dist: haversine(lat, lon, f.geometry.y, f.geometry.x), ...f })).sort((a,b)=>a.dist-b.dist);
                data.karst = { sinks, springs };
                renderMapFeatures(sinks, springs, kData.flowlines);
                updateLoadingStep('Karst', 'done');
            } else {
                updateLoadingStep('Karst', 'error');
            }

            // 3. Soil
            updateLoadingStep('Soil', 'active');
            data.soil = await safeFetch(fetchSSURGO(lat, lon), 'Soil');
            updateLoadingStep('Soil', data.soil ? 'done' : 'error');

            // 4. Seismic
            updateLoadingStep('Seismic', 'active');
            data.seismic = await safeFetch(fetchSeismic(lat, lon), 'Seismic');
            updateLoadingStep('Seismic', 'done');

            // 5. WUI
            updateLoadingStep('Wildfire', 'active');
            data.wui = await safeFetch(fetchWUI(lat, lon), 'Wildfire');
            updateLoadingStep('Wildfire', 'done');

            // Finalize
            calculateScores();
            generateFlags();
            renderResults();
            updateHeader();
            updateScoreCard();
            flyToSite(lat, lon);

            document.getElementById('mapLoading').classList.remove('active');
            btn.disabled = false;
        }

        function renderResults() {
            // Helper to render UI based on data object
            // (Simplified version of original logic to fit fixed structure)
            const k = data.karst, s = data.scores;
            
            // Update Score Card
            document.getElementById('scoreCard').style.display = 'block';
            document.getElementById('overallScore').textContent = s.overall || '‚Äî';
            document.getElementById('scoreKarst').textContent = s.karst || '-';
            document.getElementById('scoreSeismic').textContent = s.seismic || '-';
            document.getElementById('scoreFlood').textContent = s.flood || '-';
            document.getElementById('scoreWildfire').textContent = s.wildfire || '-';
            document.getElementById('scoreWind').textContent = s.wind || '-';
            document.getElementById('scoreSoil').textContent = s.soil || '-';
            
            // Update Info Panel
            document.getElementById('infoCoords').textContent = `${data.coordinates.lat.toFixed(4)}, ${data.coordinates.lon.toFixed(4)}`;
            if(k) document.getElementById('infoSink').textContent = k.sinks[0] ? `${k.sinks[0].dist.toFixed(2)} mi` : 'None';
            if(data.seismic) document.getElementById('infoPGA').textContent = `${(data.seismic.pga*100).toFixed(1)}% g`;
            if(data.soil) document.getElementById('infoSoil').textContent = data.soil.component;

            // Render Flags
            const container = document.getElementById('resultsContainer');
            let html = '';
            data.flags.forEach(f => {
                html += `<div class="risk-flag ${f.severity}"><div class="risk-title">${f.title}</div><div class="risk-detail">${f.detail}</div></div>`;
            });
            container.innerHTML = html;
            
            // Recommendation
            const rec = document.getElementById('recommendation');
            const crits = data.flags.filter(f => f.severity === 'critical').length;
            if(crits > 0) { rec.textContent = "REFER TO SPECIALIST"; rec.style.color = "var(--status-critical)"; }
            else if(s.overall >= 6) { rec.textContent = "ENHANCED REVIEW"; rec.style.color = "var(--status-high)"; }
            else { rec.textContent = "STANDARD PROCESSING"; rec.style.color = "var(--status-low)"; }
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 3959; // miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function flyToSite(lat, lon) {
            if (siteMarker) siteMarker.remove();
            const el = document.createElement('div');
            el.className = 'pulse';
            el.style.cssText = 'width:20px;height:20px;background:#f85149;border:3px solid white;border-radius:50%;box-shadow:0 0 10px rgba(0,0,0,0.5);';
            siteMarker = new mapboxgl.Marker(el).setLngLat([lon, lat]).addTo(map);
            map.flyTo({ center: [lon, lat], zoom: 14, pitch: 45 });
        }
        
        function renderMapFeatures(sinks, springs, flowlines) {
            featureMarkers.forEach(m => m.remove());
            featureMarkers = [];
            
            sinks.forEach(f => {
                const el = document.createElement('div');
                el.style.cssText = 'width:10px;height:10px;background:#a371f7;border:1px solid white;border-radius:50%;';
                const m = new mapboxgl.Marker(el).setLngLat([f.geometry.x, f.geometry.y]).setPopup(new mapboxgl.Popup().setHTML('Sink')).addTo(map);
                m._type = 'sink';
                featureMarkers.push(m);
            });
            // Flowlines logic (simplified)
            if(map.getSource('flowlines')) map.removeSource('flowlines');
            if(map.getLayer('flowlines-layer')) map.removeLayer('flowlines-layer');
            
            const features = flowlines.filter(f => f.geometry.paths).map(f => ({
                type: 'Feature', geometry: { type: 'LineString', coordinates: f.geometry.paths[0] }
            }));
            
            map.addSource('flowlines', { type: 'geojson', data: { type: 'FeatureCollection', features: features }});
            map.addLayer({ id: 'flowlines-layer', type: 'line', source: 'flowlines', paint: { 'line-color': '#58a6ff', 'line-width': 2 }});
        }

        function copyJSON() {
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            alert("Data copied to clipboard");
        }

        async function generateReport() {
            // Wait for map to settle if it's loading
            if (!map.loaded()) {
                await new Promise(r => map.once('idle', r));
            }
            const img = map.getCanvas().toDataURL();
            const win = window.open('', '_blank');
            win.document.write(`
                <html><head><title>Report</title><style>body{font-family:sans-serif;padding:20px} .score{font-size:40px;font-weight:bold}</style></head>
                <body>
                    <h1>SiteScore Report: ${data.project}</h1>
                    <p>${new Date().toLocaleString()}</p>
                    <div style="background:#eee;padding:20px;border-radius:8px;text-align:center">
                        <div>Overall Risk Score</div>
                        <div class="score" style="color:${data.scores.overall >= 6 ? 'red' : 'green'}">${data.scores.overall || 'N/A'}</div>
                    </div>
                    <img src="${img}" style="width:100%;max-width:800px;margin:20px 0;border-radius:8px;border:1px solid #ccc"/>
                    <h3>Risk Breakdown</h3>
                    <ul>
                        <li>Karst: ${data.scores.karst}</li>
                        <li>Seismic: ${data.scores.seismic}</li>
                        <li>Flood: ${data.scores.flood}</li>
                        <li>Fire: ${data.scores.wildfire}</li>
                    </ul>
                    <h3>Flags</h3>
                    ${data.flags.map(f => `<p><strong>${f.title}</strong>: ${f.detail}</p>`).join('')}
                    <button onclick="window.print()">Print PDF</button>
                </body></html>
            `);
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
