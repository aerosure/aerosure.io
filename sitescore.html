<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteScore‚Ñ¢ v1.3.6 | Know Before You Bind</title>
    <link rel="icon" type="image/png" href="SiteScore_favicon.png">
    <link rel="apple-touch-icon" href="SiteScore_favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        :root {
            --bg-primary:#080b10;--bg-secondary:#0d1117;--bg-tertiary:#161b22;--bg-card:#0d1117;--bg-elevated:#1c2433;
            --border-color:#30363d;--border-light:#484f58;--text-primary:#f0f6fc;--text-secondary:#8b949e;--text-muted:#6e7681;
            --brand-primary:#2ea043;--brand-secondary:#58a6ff;--brand-accent:#a371f7;
            --status-critical:#f85149;--status-high:#f0883e;--status-moderate:#d29922;--status-low:#2ea043;--status-info:#58a6ff;--status-warning:#fbbf24;
            --gradient-brand:linear-gradient(135deg,#2ea043 0%,#58a6ff 100%);
            --gradient-header:linear-gradient(135deg,#238636 0%,#1f6feb 100%);
            --gradient-glow:radial-gradient(ellipse at center,rgba(46,160,67,0.15) 0%,transparent 70%);
            --shadow-glow:0 0 40px rgba(46,160,67,0.2);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow:hidden}
        .header{background:var(--gradient-header);padding:0 24px;height:56px;display:flex;justify-content:space-between;align-items:center;position:relative;border-bottom:1px solid rgba(255,255,255,0.1)}
        .header::before{content:'';position:absolute;inset:0;background:var(--gradient-glow);pointer-events:none}
        .header-left{display:flex;align-items:center;gap:16px;position:relative;z-index:1}
        .logo-link{display:flex;align-items:center;text-decoration:none;min-height:40px;min-width:200px}
        .header-logo{height:40px;width:auto;filter:brightness(1.1)}
        .version{font-size:10px;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:4px;color:white;font-weight:600}
        .header-scores{display:flex;align-items:center;gap:4px;position:relative;z-index:1}
        .score-pill{display:flex;flex-direction:column;align-items:center;padding:6px 14px;background:rgba(0,0,0,0.2);border-radius:8px;min-width:70px;border:1px solid rgba(255,255,255,0.1)}
        .score-pill-value{font-size:16px;font-weight:700;font-family:'JetBrains Mono',monospace;color:white}
        .score-pill-label{font-size:8px;text-transform:uppercase;letter-spacing:0.5px;color:rgba(255,255,255,0.7)}
        .score-pill.main{background:rgba(0,0,0,0.3);border-color:rgba(255,255,255,0.2)}
        .score-pill.main .score-pill-value{font-size:20px}
        .main-container{display:grid;grid-template-columns:360px 1fr 380px;height:calc(100vh - 56px)}
        .panel{background:var(--bg-secondary);display:flex;flex-direction:column;overflow:hidden}
        .panel-left{border-right:1px solid var(--border-color)}
        .panel-right{border-left:1px solid var(--border-color)}
        .panel-header{padding:12px 16px;background:var(--bg-tertiary);border-bottom:1px solid var(--border-color);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);display:flex;align-items:center;gap:8px;flex-shrink:0}
        .panel-content{flex:1;overflow-y:auto;padding:14px}
        .input-section{background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;padding:14px;margin-bottom:14px}
        .input-field{margin-bottom:10px}
        .input-field label{display:block;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:5px}
        .input-field input{width:100%;padding:9px 11px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);font-size:13px;transition:all 0.2s}
        .input-field input:focus{outline:none;border-color:var(--brand-primary);box-shadow:0 0 0 3px rgba(46,160,67,0.15)}
        .input-row{display:flex;gap:8px}
        .input-row input{flex:1}
        .input-row button{padding:9px 12px;background:var(--brand-secondary);border:none;border-radius:6px;color:white;font-weight:600;font-size:10px;cursor:pointer;white-space:nowrap}
        .coord-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .coord-row input{font-family:'JetBrains Mono',monospace;font-size:12px}
        .analyze-btn{width:100%;padding:11px;background:var(--gradient-brand);border:none;border-radius:8px;color:white;font-weight:700;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:var(--shadow-glow);transition:all 0.2s;position:relative;overflow:hidden}
        .analyze-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transform:translateX(-100%);transition:transform 0.5s}
        .analyze-btn:hover::before{transform:translateX(100%)}
        .analyze-btn:disabled{opacity:0.6;cursor:not-allowed}
        .analyze-btn .spinner{width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .api-status{font-size:9px;padding:6px 10px;background:var(--bg-tertiary);border-radius:6px;margin-top:8px;display:none;border-left:3px solid var(--status-warning)}
        .api-status.visible{display:block}
        .quick-locations{margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)}
        .quick-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:8px}
        .quick-btn{width:100%;padding:8px 10px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-secondary);font-size:10px;text-align:left;cursor:pointer;margin-bottom:5px;display:flex;align-items:center;gap:8px;transition:all 0.15s}
        .quick-btn:hover{border-color:var(--brand-primary);color:var(--text-primary);background:var(--bg-elevated)}
        .quick-btn .icon{font-size:14px}
        .quick-btn .name{font-weight:600;flex:1}
        .quick-btn .tag{font-size:7px;padding:2px 5px;border-radius:3px;font-weight:700;text-transform:uppercase}
        .tag-critical{background:rgba(248,81,73,0.2);color:var(--status-critical)}
        .tag-high{background:rgba(240,136,62,0.2);color:var(--status-high)}
        .tag-moderate{background:rgba(210,153,34,0.2);color:var(--status-moderate)}
        .tag-low{background:rgba(46,160,67,0.2);color:var(--status-low)}
        .tag-subsidence{background:rgba(136,57,239,0.2);color:#8839ef}
        .tag-seismic{background:rgba(163,113,247,0.2);color:var(--brand-accent)}
        .result-card{background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;margin-bottom:12px;overflow:hidden}
        .result-header{padding:10px 12px;background:var(--bg-tertiary);display:flex;align-items:center;justify-content:space-between}
        .result-title{font-size:11px;font-weight:700;display:flex;align-items:center;gap:6px}
        .result-badge{font-size:8px;padding:3px 7px;border-radius:4px;font-weight:700;text-transform:uppercase}
        .badge-critical{background:rgba(248,81,73,0.15);color:var(--status-critical)}
        .badge-high{background:rgba(240,136,62,0.15);color:var(--status-high)}
        .badge-moderate{background:rgba(210,153,34,0.15);color:var(--status-moderate)}
        .badge-low{background:rgba(46,160,67,0.15);color:var(--status-low)}
        .badge-info{background:rgba(88,166,255,0.15);color:var(--status-info)}
        .badge-warning{background:rgba(251,191,36,0.15);color:var(--status-warning)}
        .result-content{padding:12px}
        .data-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
        .data-grid.cols-3{grid-template-columns:repeat(3,1fr)}
        .data-grid.cols-6{grid-template-columns:repeat(6,1fr)}
        .data-item{background:var(--bg-tertiary);padding:10px 8px;border-radius:6px;text-align:center}
        .data-item.full{grid-column:span 2}
        .data-label{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:3px}
        .data-value{font-size:15px;font-weight:700;font-family:'JetBrains Mono',monospace}
        .data-value.xl{font-size:22px}
        .data-value.sm{font-size:11px;font-family:'Inter',sans-serif;font-weight:600}
        .risk-flag{padding:10px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:6px;border-left:3px solid}
        .risk-flag.critical{border-left-color:var(--status-critical);background:rgba(248,81,73,0.05)}
        .risk-flag.high{border-left-color:var(--status-high);background:rgba(240,136,62,0.05)}
        .risk-flag.moderate{border-left-color:var(--status-moderate);background:rgba(210,153,34,0.05)}
        .risk-title{font-size:11px;font-weight:700;margin-bottom:3px;display:flex;align-items:center;gap:5px}
        .risk-detail{font-size:10px;color:var(--text-secondary);line-height:1.4}
        .score-card{background:linear-gradient(135deg,rgba(46,160,67,0.08),rgba(88,166,255,0.08));border:1px solid rgba(46,160,67,0.25)}
        .score-card .result-header{background:linear-gradient(135deg,rgba(46,160,67,0.15),rgba(88,166,255,0.15))}
        .overall-score{text-align:center;padding:16px;background:var(--bg-primary);border-radius:8px;margin-bottom:10px;position:relative;overflow:hidden}
        .overall-score::before{content:'';position:absolute;inset:0;background:var(--gradient-glow);opacity:0.5}
        .overall-score-label{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px;position:relative}
        .overall-score-value{font-size:44px;font-weight:900;font-family:'JetBrains Mono',monospace;line-height:1;position:relative}
        .overall-score-scale{font-size:9px;color:var(--text-muted);margin-top:4px;position:relative}
        .score-breakdown{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:10px}
        .score-item{background:var(--bg-tertiary);padding:8px 4px;border-radius:6px;text-align:center}
        .score-item-label{font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);margin-bottom:2px}
        .score-item-value{font-size:13px;font-weight:700;font-family:'JetBrains Mono',monospace}
        .score-item-weight{font-size:7px;color:var(--text-muted)}
        .recommendation-box{text-align:center;padding:12px;background:var(--bg-primary);border-radius:8px;margin-top:10px}
        .recommendation-label{font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px}
        .recommendation-value{font-size:14px;font-weight:800}
        .seismic-card{background:linear-gradient(135deg,rgba(163,113,247,0.08),rgba(88,166,255,0.08));border:1px solid rgba(163,113,247,0.25)}
        .seismic-card .result-header{background:linear-gradient(135deg,rgba(163,113,247,0.15),rgba(88,166,255,0.15))}
        .wui-card{background:linear-gradient(135deg,rgba(248,81,73,0.08),rgba(240,136,62,0.08));border:1px solid rgba(248,81,73,0.25)}
        .wui-card .result-header{background:linear-gradient(135deg,rgba(248,81,73,0.15),rgba(240,136,62,0.15))}
        .subsidence-card{background:linear-gradient(135deg,rgba(136,57,239,0.08),rgba(163,113,247,0.08));border:1px solid rgba(136,57,239,0.25)}
        .subsidence-card .result-header{background:linear-gradient(135deg,rgba(136,57,239,0.15),rgba(163,113,247,0.15))}
        .athenium-card{background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(163,113,247,0.08));border:1px solid rgba(88,166,255,0.25)}
        .athenium-card .result-header{background:linear-gradient(135deg,rgba(88,166,255,0.15),rgba(163,113,247,0.15))}
        .flood-card{background:linear-gradient(135deg,rgba(88,166,255,0.08),rgba(46,160,67,0.08));border:1px solid rgba(88,166,255,0.25)}
        .flood-card .result-header{background:linear-gradient(135deg,rgba(88,166,255,0.15),rgba(46,160,67,0.15))}
        .history-card{background:linear-gradient(135deg,rgba(240,136,62,0.08),rgba(210,153,34,0.08));border:1px solid rgba(240,136,62,0.25)}
        .history-card .result-header{background:linear-gradient(135deg,rgba(240,136,62,0.15),rgba(210,153,34,0.15))}
        .athenium-paste{width:100%;min-height:90px;padding:10px;background:var(--bg-tertiary);border:1px dashed var(--border-color);border-radius:6px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:9px;resize:vertical;margin-bottom:8px}
        .athenium-paste:focus{outline:none;border-color:var(--status-info);border-style:solid}
        .parse-btn{width:100%;padding:9px;background:var(--status-info);border:none;border-radius:6px;color:white;font-weight:700;font-size:11px;cursor:pointer}
        .athenium-display{margin-top:10px;background:var(--bg-tertiary);border-radius:6px;padding:10px}
        .athenium-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:10px;border-bottom:1px solid var(--border-color)}
        .athenium-row:last-child{border-bottom:none}
        .freeboard-warning{padding:8px;background:rgba(248,81,73,0.15);border-left:3px solid var(--status-critical);border-radius:0 6px 6px 0;margin-top:8px;font-size:10px}
        .freeboard-ok{padding:8px;background:rgba(46,160,67,0.15);border-left:3px solid var(--status-low);border-radius:0 6px 6px 0;margin-top:8px;font-size:10px}
        .freeboard-moderate{padding:8px;background:rgba(210,153,34,0.15);border-left:3px solid var(--status-moderate);border-radius:0 6px 6px 0;margin-top:8px;font-size:10px}
        .hurricane-timeline{margin-top:10px;padding:10px;background:var(--bg-tertiary);border-radius:6px}
        .hurricane-event{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border-color);font-size:10px}
        .hurricane-event:last-child{border-bottom:none}
        .hurricane-name{font-weight:700}
        .hurricane-date{color:var(--text-muted);font-size:9px}
        .hurricane-wind{font-family:'JetBrains Mono',monospace;font-weight:600}
        .export-section{padding:12px;background:var(--bg-tertiary);border-top:1px solid var(--border-color);flex-shrink:0}
        .export-btn{width:100%;padding:10px;border-radius:8px;font-weight:700;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:6px}
        .export-btn:last-child{margin-bottom:0}
        .export-btn.primary{background:var(--gradient-brand);border:none;color:white}
        .export-btn.secondary{background:var(--bg-primary);border:1px solid var(--border-color);color:var(--text-primary)}
        .map-container{position:relative;background:var(--bg-primary)}
        #map{width:100%;height:100%}
        .map-loading{position:absolute;inset:0;background:rgba(8,11,16,0.9);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
        .map-loading.active{display:flex}
        .loading-spinner{width:36px;height:36px;border:3px solid var(--border-color);border-top-color:var(--brand-primary);border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:12px}
        .loading-text{font-size:13px;color:var(--text-secondary)}
        .loading-detail{font-size:10px;color:var(--text-muted);margin-top:4px}
        .loading-steps{margin-top:12px;text-align:left}
        .loading-step{font-size:9px;color:var(--text-muted);padding:3px 0;display:flex;align-items:center;gap:6px}
        .loading-step.active{color:var(--brand-primary)}
        .loading-step.done{color:var(--status-low)}
        .loading-step.warning{color:var(--status-warning)}
        .loading-step.failed{color:var(--status-critical)}
        .loading-step .check{color:inherit}
        .map-controls{position:absolute;top:12px;left:12px;z-index:10;display:flex;flex-direction:column;gap:6px}
        .map-control-card{background:rgba(8,11,16,0.92);border:1px solid var(--border-color);border-radius:8px;padding:10px;backdrop-filter:blur(12px);min-width:150px}
        .map-control-title{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:6px;display:flex;align-items:center;gap:4px}
        .map-control-title .dot{width:5px;height:5px;border-radius:50%;background:var(--brand-primary)}
        .map-toggle{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:10px;color:var(--text-secondary);cursor:pointer}
        .map-toggle:hover{color:var(--text-primary)}
        .map-toggle input{accent-color:var(--brand-primary);width:12px;height:12px}
        .map-toggle .badge{font-size:7px;padding:1px 4px;background:var(--brand-accent);color:white;border-radius:3px;font-weight:600;margin-left:auto}
        .map-info{position:absolute;top:12px;right:12px;background:rgba(8,11,16,0.92);border:1px solid var(--border-color);border-radius:10px;padding:12px;backdrop-filter:blur(12px);min-width:200px;z-index:10}
        .map-info-header{display:flex;align-items:center;gap:6px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border-color)}
        .map-info-title{font-size:12px;font-weight:700}
        .map-info-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:10px;border-bottom:1px solid var(--border-color)}
        .map-info-row:last-child{border-bottom:none}
        .map-info-label{color:var(--text-muted)}
        .map-info-value{font-weight:600;font-family:'JetBrains Mono',monospace;font-size:9px}
        .map-legend{position:absolute;bottom:24px;left:12px;background:rgba(8,11,16,0.92);border:1px solid var(--border-color);border-radius:8px;padding:10px 12px;backdrop-filter:blur(12px);z-index:10}
        .legend-title{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-muted);margin-bottom:6px}
        .legend-item{display:flex;align-items:center;gap:6px;font-size:9px;color:var(--text-secondary);margin-bottom:3px}
        .legend-item:last-child{margin-bottom:0}
        .legend-dot{width:10px;height:10px;border-radius:50%;border:2px solid rgba(255,255,255,0.8)}
        .legend-line{width:16px;height:3px;border-radius:2px}
        .legend-rect{width:16px;height:10px;border-radius:2px;opacity:0.7}
        .tip-box{background:var(--bg-card);border:1px dashed var(--border-color);border-radius:8px;padding:12px;text-align:center}
        .tip-icon{font-size:20px;margin-bottom:6px}
        .tip-text{font-size:10px;color:var(--text-muted);line-height:1.4}
        .tip-text strong{color:var(--text-secondary)}
        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-track{background:var(--bg-primary)}
        ::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}
        .mapboxgl-popup-content{background:var(--bg-card);color:var(--text-primary);border-radius:8px;padding:10px 12px;border:1px solid var(--border-color);box-shadow:0 8px 32px rgba(0,0,0,0.5)}
        .mapboxgl-popup-tip{border-top-color:var(--bg-card)}
        .popup-title{font-size:11px;font-weight:700;margin-bottom:3px}
        .popup-detail{font-size:9px;color:var(--text-secondary)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        @keyframes glow{0%,100%{box-shadow:0 0 20px rgba(46,160,67,0.3)}50%{box-shadow:0 0 40px rgba(46,160,67,0.5)}}
        .pulse{animation:pulse 2s ease-in-out infinite}
        .glow{animation:glow 2s ease-in-out infinite}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="https://aerosure.io" class="logo-link" title="Back to aerosure.io">
                <img src="SiteScore_Logo.png" alt="SiteScore‚Ñ¢" class="header-logo" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
                <span class="logo-fallback" style="display:none;color:white;font-weight:700;font-size:18px">SiteScore‚Ñ¢</span>
            </a>
            <span class="version">v1.3.6</span>
        </div>
        <div class="header-scores">
            <div class="score-pill main"><div class="score-pill-value" id="headerScore">‚Äî</div><div class="score-pill-label">Score</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerKarst">‚Äî</div><div class="score-pill-label">Karst</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerSeismic">‚Äî</div><div class="score-pill-label">Seismic</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerFlood">‚Äî</div><div class="score-pill-label">Flood</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerWildfire">‚Äî</div><div class="score-pill-label">Fire</div></div>
            <div class="score-pill"><div class="score-pill-value" id="headerWind">‚Äî</div><div class="score-pill-label">Wind</div></div>
        </div>
    </header>
    <div class="main-container">
        <div class="panel panel-left">
            <div class="panel-header"><span>üìç</span> Site Analysis</div>
            <div class="panel-content">
                <div class="input-section">
                    <div class="input-field">
                        <label>Address Lookup</label>
                        <div class="input-row">
                            <input type="text" id="addressInput" placeholder="123 Main St, City, State">
                            <button onclick="geocodeAddress()">üîç Find</button>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Project Name</label>
                        <input type="text" id="projectName" placeholder="e.g., Norfolk State Science Building" maxlength="100">
                    </div>
                    <div class="coord-row">
                        <div class="input-field"><label>Latitude</label><input type="text" id="lat" placeholder="35.9427"></div>
                        <div class="input-field"><label>Longitude</label><input type="text" id="lon" placeholder="-83.9510"></div>
                    </div>
                    <button class="analyze-btn" id="analyzeBtn" onclick="runAnalysis()"><span>‚ö°</span> Analyze Site</button>
                    <div class="api-status" id="apiStatus"></div>
                    <div class="quick-locations">
                        <div class="quick-title">Test Locations</div>
                        <button class="quick-btn" onclick="setLocation('UT MFR Research',35.9427,-83.9510)"><span class="icon">üï≥Ô∏è</span><span class="name">Knoxville TN</span><span class="tag tag-critical">KARST</span></button>
                        <button class="quick-btn" onclick="setLocation('LA Office Tower',34.0522,-118.2437)"><span class="icon">üåã</span><span class="name">Los Angeles CA</span><span class="tag tag-seismic">SEISMIC</span></button>
                        <button class="quick-btn" onclick="setLocation('Lake Arrowhead Resort',34.248,-117.189)"><span class="icon">üî•</span><span class="name">Lake Arrowhead CA</span><span class="tag tag-critical">WUI</span></button>
                        <button class="quick-btn" onclick="setLocation('USD Phase 1B',37.592665,-122.089949)"><span class="icon">üåä</span><span class="name">Union City CA</span><span class="tag tag-high">LIQUEFACTION</span></button>
                        <button class="quick-btn" onclick="setLocation('Miami Distribution',25.76,-80.19)"><span class="icon">üåä</span><span class="name">Miami FL</span><span class="tag tag-high">FLOOD</span></button>
                        <button class="quick-btn" onclick="setLocation('Denver Tech',39.74,-104.99)"><span class="icon">‚úÖ</span><span class="name">Denver CO</span><span class="tag tag-low">LOW</span></button>
                        <button class="quick-btn" onclick="setLocation('Corcoran Ag Facility',36.098,-119.56)"><span class="icon">üìâ</span><span class="name">Corcoran CA</span><span class="tag tag-subsidence">SUBSIDENCE</span></button>
                    </div>
                    <div style="font-size:9px;color:var(--text-muted);margin-top:10px;padding:8px;background:var(--bg-tertiary);border-radius:6px;text-align:center">üí° Click map to set coordinates</div>
                </div>
                <div id="resultsContainer"></div>
            </div>
            <div class="export-section">
                <button class="export-btn primary" onclick="generateReport()">üìÑ Generate Report</button>
                <button class="export-btn secondary" onclick="copyJSON()">üìã Copy JSON</button>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <div class="map-loading" id="mapLoading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Analyzing Site...</div>
                <div class="loading-detail" id="loadingDetail">Initializing...</div>
                <div class="loading-steps" id="loadingSteps"></div>
            </div>
            <div class="map-controls">
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> Basemap</div>
                    <label class="map-toggle"><input type="radio" name="basemap" value="terrain" checked onchange="setBasemap('terrain')"> Terrain</label>
                    <label class="map-toggle"><input type="radio" name="basemap" value="satellite" onchange="setBasemap('satellite')"> Satellite</label>
                </div>
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> Karst Data</div>
                    <label class="map-toggle"><input type="checkbox" id="toggleSinks" checked onchange="toggleFeatures('sink')"> üï≥Ô∏è Sinks</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleSprings" checked onchange="toggleFeatures('spring')"> üíß Springs</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleFlowlines" checked onchange="toggleFlowlines()"> üåä Flowlines</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleKarstTerrain" onchange="toggleKarstTerrain()"> üó∫Ô∏è Karst Terrain<span class="badge">NEW</span></label>
                </div>
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> USGS Overlays</div>
                    <label class="map-toggle"><input type="checkbox" id="toggleHillshade" onchange="toggleUSGSLayer('hillshade')"> üèîÔ∏è Hillshade</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleContours" onchange="toggleUSGSLayer('contours')"> üìè Contours</label>
                </div>
                <div class="map-control-card">
                    <div class="map-control-title"><div class="dot"></div> Hazard Zones</div>
                    <label class="map-toggle"><input type="checkbox" id="toggleFemaFlood" onchange="toggleFEMAFlood()"> üåä FEMA Flood</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleWUI" onchange="toggleWUILayer()"> üî• WUI National</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleFHSZ" onchange="toggleFHSZLayer()"> üî• CA Fire Hazard</label>
                    <label class="map-toggle"><input type="checkbox" id="toggleCASubsidence" onchange="toggleCASubsidenceLayer()"> üìâ CA Subsidence<span class="badge">NEW</span></label>
                </div>
            </div>
            <div class="map-info">
                <div class="map-info-header"><span style="font-size:14px">üìç</span><span class="map-info-title">Site Info</span></div>
                <div class="map-info-row"><span class="map-info-label">Coordinates</span><span class="map-info-value" id="infoCoords">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Elevation</span><span class="map-info-value" id="infoElevation">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Nearest Sink</span><span class="map-info-value" id="infoSink">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Karst Terrain</span><span class="map-info-value" id="infoKarstTerrain">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Seismic PGA</span><span class="map-info-value" id="infoPGA">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">WUI Class</span><span class="map-info-value" id="infoWUI">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">CA Fire Zone</span><span class="map-info-value" id="infoFHSZ">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">CA Subsidence</span><span class="map-info-value" id="infoSubsidence">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">CA Liquefaction</span><span class="map-info-value" id="infoLiquefaction">‚Äî</span></div>
                <div class="map-info-row"><span class="map-info-label">Soil Type</span><span class="map-info-value" id="infoSoil">‚Äî</span></div>
            </div>
            <div class="map-legend">
                <div class="legend-title">Legend</div>
                <div class="legend-item"><div class="legend-dot" style="background:#f85149"></div> Site</div>
                <div class="legend-item"><div class="legend-dot" style="background:#a371f7"></div> Sink</div>
                <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div> Spring</div>
                <div class="legend-item"><div class="legend-line" style="background:#58a6ff"></div> Flowline</div>
                <div class="legend-item"><div class="legend-rect" style="background:#6366f1"></div> Karst Terrain</div>
                <div class="legend-item"><div class="legend-rect" style="background:rgba(0,112,255,0.5)"></div> FEMA Flood</div>
                <div class="legend-item"><div class="legend-rect" style="background:#f97316"></div> WUI Zone</div>
                <div class="legend-item"><div class="legend-rect" style="background:#dc2626"></div> CA Subsidence</div>
            </div>
        </div>
        <div class="panel panel-right">
            <div class="panel-header"><span>üéØ</span> Risk Scoring</div>
            <div class="panel-content">
                <div class="result-card score-card" id="scoreCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üéØ</span> Site Risk Score</div></div>
                    <div class="result-content">
                        <div class="overall-score">
                            <div class="overall-score-label">Overall Risk Score</div>
                            <div class="overall-score-value" id="overallScore">‚Äî</div>
                            <div class="overall-score-scale">0 = Best ‚Ä¢ 10 = Worst</div>
                        </div>
                        <div class="score-breakdown">
                            <div class="score-item"><div class="score-item-label">Karst</div><div class="score-item-value" id="scoreKarst">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Seismic</div><div class="score-item-value" id="scoreSeismic">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Flood</div><div class="score-item-value" id="scoreFlood">‚Äî</div><div class="score-item-weight">20%</div></div>
                            <div class="score-item"><div class="score-item-label">Wildfire</div><div class="score-item-value" id="scoreWildfire">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Wind</div><div class="score-item-value" id="scoreWind">‚Äî</div><div class="score-item-weight">15%</div></div>
                            <div class="score-item"><div class="score-item-label">Soil</div><div class="score-item-value" id="scoreSoil">‚Äî</div><div class="score-item-weight">10%</div></div>
                            <div class="score-item"><div class="score-item-label">Subsid.</div><div class="score-item-value" id="scoreSubsidence">‚Äî</div><div class="score-item-weight">10%</div></div>
                        </div>
                        <div class="recommendation-box">
                            <div class="recommendation-label">Recommendation</div>
                            <div class="recommendation-value" id="recommendation">‚Äî</div>
                        </div>
                    </div>
                </div>
                <div class="result-card seismic-card" id="seismicCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üåã</span> USGS Seismic</div><span class="result-badge badge-low" id="seismicBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid cols-3">
                            <div class="data-item"><div class="data-label">PGA</div><div class="data-value" id="seismicPGA">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Score</div><div class="data-value" id="seismicScore">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">SDC</div><div class="data-value" id="seismicSDC">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card wui-card" id="wuiCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üî•</span> Wildfire / WUI</div><span class="result-badge badge-low" id="wuiBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">WUI Class</div><div class="data-value sm" id="wuiClass">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Fire Score</div><div class="data-value" id="wuiScore">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">CA FHSZ</div><div class="data-value" id="caFireSeverity">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Veg Cover</div><div class="data-value" id="wuiVeg">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card subsidence-card" id="subsidenceCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üìâ</span> CA Ground Subsidence</div><span class="result-badge badge-low" id="subsidenceBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Annual Rate</div><div class="data-value" id="subsidenceRate">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Score</div><div class="data-value" id="subsidenceScore">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Total (2015+)</div><div class="data-value" id="subsidenceTotal">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Data Source</div><div class="data-value sm" id="subsidenceSource">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card flood-card" id="floodRiskCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üåä</span> Flood Risk Analysis</div><span class="result-badge badge-info" id="floodRiskBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">River Flood</div><div class="data-value" id="floodRiver">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Flash Flood</div><div class="data-value" id="floodFlash">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">FEMA Zone</div><div class="data-value" id="floodFema">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">BFE</div><div class="data-value" id="floodBfe">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Elevation</div><div class="data-value" id="floodElev">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Freeboard</div><div class="data-value" id="floodFreeboard">‚Äî</div></div>
                        </div>
                        <div id="freeboardAlert"></div>
                        <div class="data-grid" style="margin-top:8px">
                            <div class="data-item"><div class="data-label">100-yr Depth</div><div class="data-value" id="floodInund100">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">500-yr Depth</div><div class="data-value" id="floodInund500">‚Äî</div></div>
                        </div>
                    </div>
                </div>
                <div class="result-card history-card" id="historyCard" style="display:none">
                    <div class="result-header"><div class="result-title"><span>üìú</span> Historical Validation</div><span class="result-badge badge-info" id="historyBadge">‚Äî</span></div>
                    <div class="result-content">
                        <div class="data-grid">
                            <div class="data-item"><div class="data-label">Hail Events</div><div class="data-value" id="histHail">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Wind Events</div><div class="data-value" id="histWind">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Max Hail</div><div class="data-value" id="histMaxHail">‚Äî</div></div>
                            <div class="data-item"><div class="data-label">Max Wind</div><div class="data-value" id="histMaxWind">‚Äî</div></div>
                        </div>
                        <div class="hurricane-timeline" id="hurricaneTimeline" style="display:none">
                            <div style="font-size:9px;font-weight:600;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">üåÄ Hurricane History</div>
                            <div id="hurricaneEvents"></div>
                        </div>
                    </div>
                </div>
                <div class="result-card athenium-card">
                    <div class="result-header"><div class="result-title"><span>üìä</span> Athenium Climate Data</div></div>
                    <div class="result-content">
                        <textarea class="athenium-paste" id="atheniumPaste" placeholder="Paste Athenium MCP output...

River Flood Score: 0.4/10
Flash Flood Score: 3.6/10
Wildfire: 7/10
Wind: 9/10
Hail: 5/10"></textarea>
                        <button class="parse-btn" onclick="parseAthenium()">Parse & Recalculate</button>
                        <div class="athenium-display" id="atheniumDisplay" style="display:none"><div id="atheniumParsed"></div></div>
                    </div>
                </div>
                <div class="tip-box">
                    <div class="tip-icon">üí°</div>
                    <div class="tip-text"><strong>Higher Score = Higher Risk</strong><br>Paste Athenium flood/wind data to complete the composite score calculation.</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // CONFIGURATION & CONSTANTS
        // ============================================
        mapboxgl.accessToken = 'pk.eyJ1IjoiYWVyb3N1cmUiLCJhIjoiY21qNTZvMTlyMHV5aTNnb2dib2JuaXFyMSJ9.WN3RY1Ne-VQjn0o51xvEkQ';
        
        const DEBUG = false;
        const log = (...args) => { if (DEBUG) console.log('[SiteScore]', ...args); };
        
        const API_TIMEOUT = 10000;
        const API_TIMEOUT_SHORT = 5000;
        const KM_PER_DEGREE = 111;
        
        const API = {
            THREEDP: 'https://3dhp.nationalmap.gov/arcgis/rest/services/usgs_3dhp_all/FeatureServer',
            SSURGO_WFS: 'https://sdmdataaccess.sc.egov.usda.gov/Spatial/SDMWGS84Geographic.wfs',
            SSURGO_SQL: 'https://sdmdataaccess.sc.egov.usda.gov/tabular/post.rest',
            USGS_ELEV: 'https://epqs.nationalmap.gov/v1/json',
            USGS_SEISMIC: 'https://earthquake.usgs.gov/ws/designmaps',
            USGS_WMS: 'https://elevation.nationalmap.gov/arcgis/services/3DEPElevation/ImageServer/WMSServer',
            FEMA_NFHL: 'https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer',
            USFS_WUI: 'https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_WUI_2020_01/MapServer/0',
            CA_FHSZ_SRA: 'https://services.gis.ca.gov/arcgis/rest/services/Environment/Fire_Severity_Zones/MapServer/0',
            CA_FHSZ_LRA: 'https://services.gis.ca.gov/arcgis/rest/services/Environment/Fire_Severity_Zones/MapServer/1',
            CA_SUBSIDENCE_POINTS: 'https://gis.water.ca.gov/arcgis/rest/services/Elevation/Vertical_Displacement_Point_Data_Locations_2024Q1/MapServer/0',
            CA_CGS_LIQUEFACTION: 'https://services.gis.ca.gov/arcgis/rest/services/GeoscientificInformation/Liquefaction/MapServer/0'
        };

        const WEIGHTS = { karst: 0.15, seismic: 0.15, flood: 0.20, wildfire: 0.15, wind: 0.15, soil: 0.10, subsidence: 0.10 };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let map, siteMarker = null, featureMarkers = [];
        let layerStates = { femaFlood: false, wui: false, fhsz: false, hillshade: false, contours: false, karstTerrain: false, caSubsidence: false };
        let apiFailures = [];
        
        const data = {
            project: null, coordinates: null, elevation: null, karst: null, karstTerrain: null,
            soil: null, seismic: null, wui: null, subsidence: null, liquefaction: null, athenium: null,
            flags: [], scores: { karst: null, seismic: null, flood: null, wildfire: null, wind: null, soil: null, subsidence: null, overall: null },
            timestamp: null
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        async function safeFetch(fetchPromise, apiName, timeout = API_TIMEOUT) {
            try {
                const result = await Promise.race([
                    fetchPromise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))
                ]);
                return result;
            } catch (err) {
                log(`${apiName} failed:`, err.message);
                apiFailures.push({ api: apiName, error: err.message });
                return null;
            }
        }
        
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 3959, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
        
        function getScoreColor(score) {
            if (score === null || score === undefined) return 'var(--text-muted)';
            if (score >= 8) return 'var(--status-critical)';
            if (score >= 6) return 'var(--status-high)';
            if (score >= 4) return 'var(--status-moderate)';
            return 'var(--status-low)';
        }
        
        function showApiStatus() {
            const el = document.getElementById('apiStatus');
            if (apiFailures.length === 0) { el.classList.remove('visible'); return; }
            el.innerHTML = '‚ö†Ô∏è Partial data - some APIs unavailable: ' + apiFailures.map(f => f.api).join(', ');
            el.classList.add('visible');
        }

        // ============================================
        // MAP INITIALIZATION
        // ============================================
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map', style: 'mapbox://styles/mapbox/outdoors-v12',
                center: [-98, 39], zoom: 4, preserveDrawingBuffer: true
            });
            map.on('load', function() {
                map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize: 512 });
                map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
                log('Map initialized');
            });
            map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
            map.addControl(new mapboxgl.ScaleControl({ unit: 'imperial' }), 'bottom-left');
            map.on('click', async function(e) {
                document.getElementById('lat').value = e.lngLat.lat.toFixed(6);
                document.getElementById('lon').value = e.lngLat.lng.toFixed(6);
                document.getElementById('infoCoords').textContent = e.lngLat.lat.toFixed(4) + ', ' + e.lngLat.lng.toFixed(4);
                const elev = await fetchElevation(e.lngLat.lat, e.lngLat.lng);
                if (elev !== null) document.getElementById('infoElevation').textContent = elev.toFixed(1) + ' ft';
            });
        }

        // ============================================
        // MAP LAYER CONTROLS
        // ============================================
        function setBasemap(style) {
            const styles = { terrain: 'mapbox://styles/mapbox/outdoors-v12', satellite: 'mapbox://styles/mapbox/satellite-streets-v12' };
            const savedStates = { ...layerStates };
            map.setStyle(styles[style]);
            map.once('style.load', function() {
                if (!map.getSource('mapbox-dem')) {
                    map.addSource('mapbox-dem', { type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1', tileSize: 512 });
                }
                map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });
                setTimeout(() => {
                    Object.keys(savedStates).forEach(key => {
                        if (savedStates[key]) {
                            layerStates[key] = false;
                            const checkbox = document.getElementById('toggle' + key.charAt(0).toUpperCase() + key.slice(1));
                            if (checkbox) checkbox.checked = true;
                            switch(key) {
                                case 'femaFlood': toggleFEMAFlood(); break;
                                case 'wui': toggleWUILayer(); break;
                                case 'fhsz': toggleFHSZLayer(); break;
                                case 'hillshade': case 'contours': toggleUSGSLayer(key); break;
                                case 'karstTerrain': toggleKarstTerrain(); break;
                                case 'caSubsidence': toggleCASubsidenceLayer(); break;
                            }
                        }
                    });
                }, 100);
            });
        }

        function toggleUSGSLayer(layer) {
            const checkbox = document.getElementById('toggle' + layer.charAt(0).toUpperCase() + layer.slice(1));
            const layerId = 'usgs-' + layer, sourceId = 'usgs-' + layer;
            if (checkbox.checked) {
                if (map.getLayer(layerId)) map.removeLayer(layerId);
                if (map.getSource(sourceId)) map.removeSource(sourceId);
                const wmsLayer = layer === 'hillshade' ? '3DEPElevation:Hillshade%20Multidirectional' : '3DEPElevation:Contour%2025';
                map.addSource(sourceId, { type: 'raster', tiles: [API.USGS_WMS + '?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&LAYERS=' + wmsLayer + '&FORMAT=image/png&TRANSPARENT=true&SRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'], tileSize: 256 });
                map.addLayer({ id: layerId, type: 'raster', source: sourceId, paint: { 'raster-opacity': layer === 'hillshade' ? 0.6 : 0.8 } }, 'road-label');
                layerStates[layer] = true;
            } else {
                if (map.getLayer(layerId)) map.setLayoutProperty(layerId, 'visibility', 'none');
                layerStates[layer] = false;
            }
        }

        function toggleFEMAFlood() {
            const checkbox = document.getElementById('toggleFemaFlood');
            if (checkbox.checked) {
                if (map.getLayer('fema-flood')) map.removeLayer('fema-flood');
                if (map.getSource('fema-flood-source')) map.removeSource('fema-flood-source');
                map.addSource('fema-flood-source', { type: 'raster', tiles: ['https://hazards.fema.gov/arcgis/rest/services/public/NFHL/MapServer/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&layers=show:28&f=image'], tileSize: 256 });
                map.addLayer({ id: 'fema-flood', type: 'raster', source: 'fema-flood-source', paint: { 'raster-opacity': 0.6 }, minzoom: 9 });
                layerStates.femaFlood = true;
            } else {
                if (map.getLayer('fema-flood')) map.setLayoutProperty('fema-flood', 'visibility', 'none');
                layerStates.femaFlood = false;
            }
        }

        function toggleWUILayer() {
            const checkbox = document.getElementById('toggleWUI');
            if (checkbox.checked) {
                if (map.getLayer('wui-layer')) map.removeLayer('wui-layer');
                if (map.getSource('wui-source')) map.removeSource('wui-source');
                map.addSource('wui-source', { type: 'raster', tiles: ['https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_WUI_2020_01/MapServer/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&layers=show:0&f=image'], tileSize: 256 });
                map.addLayer({ id: 'wui-layer', type: 'raster', source: 'wui-source', paint: { 'raster-opacity': 0.55 }, minzoom: 8 });
                layerStates.wui = true;
            } else {
                if (map.getLayer('wui-layer')) map.setLayoutProperty('wui-layer', 'visibility', 'none');
                layerStates.wui = false;
            }
        }

        function toggleFHSZLayer() {
            const checkbox = document.getElementById('toggleFHSZ');
            if (checkbox.checked) {
                if (map.getLayer('fhsz-layer')) map.removeLayer('fhsz-layer');
                if (map.getSource('fhsz-source')) map.removeSource('fhsz-source');
                map.addSource('fhsz-source', { type: 'raster', tiles: ['https://services.gis.ca.gov/arcgis/rest/services/Environment/Fire_Severity_Zones/MapServer/export?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&transparent=true&layers=show:0,1,2,3,4,5&f=image'], tileSize: 256 });
                map.addLayer({ id: 'fhsz-layer', type: 'raster', source: 'fhsz-source', paint: { 'raster-opacity': 0.5 }, minzoom: 8 });
                layerStates.fhsz = true;
            } else {
                if (map.getLayer('fhsz-layer')) map.setLayoutProperty('fhsz-layer', 'visibility', 'none');
                layerStates.fhsz = false;
            }
        }

        function toggleKarstTerrain() {
            const checkbox = document.getElementById('toggleKarstTerrain');
            if (checkbox.checked) {
                if (map.getLayer('karst-terrain-layer')) map.removeLayer('karst-terrain-layer');
                if (map.getSource('karst-terrain-source')) map.removeSource('karst-terrain-source');
                map.addSource('karst-terrain-source', { type: 'raster', tiles: ['https://tiles.arcgis.com/tiles/hoKRg7d6zCP8hwp2/arcgis/rest/services/Carbonate_Karst/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 });
                map.addLayer({ id: 'karst-terrain-layer', type: 'raster', source: 'karst-terrain-source', paint: { 'raster-opacity': 0.6 }, minzoom: 5 });
                layerStates.karstTerrain = true;
            } else {
                if (map.getLayer('karst-terrain-layer')) map.setLayoutProperty('karst-terrain-layer', 'visibility', 'none');
                layerStates.karstTerrain = false;
            }
        }

        function toggleCASubsidenceLayer() {
            const checkbox = document.getElementById('toggleCASubsidence');
            if (checkbox.checked) {
                if (map.getLayer('ca-subsidence-layer')) map.removeLayer('ca-subsidence-layer');
                if (map.getSource('ca-subsidence-source')) map.removeSource('ca-subsidence-source');
                map.addSource('ca-subsidence-source', { type: 'raster', tiles: ['https://gis.water.ca.gov/arcgisimg/rest/services/SAR/Vertical_Displacement_TRE_ALTAMIRA_Annual_Rate_20230101_20240101/ImageServer/exportImage?bbox={bbox-epsg-3857}&bboxSR=3857&imageSR=3857&size=256,256&format=png32&f=image'], tileSize: 256 });
                map.addLayer({ id: 'ca-subsidence-layer', type: 'raster', source: 'ca-subsidence-source', paint: { 'raster-opacity': 0.7 }, minzoom: 8 });
                layerStates.caSubsidence = true;
            } else {
                if (map.getLayer('ca-subsidence-layer')) map.setLayoutProperty('ca-subsidence-layer', 'visibility', 'none');
                layerStates.caSubsidence = false;
            }
        }

        function toggleFeatures(type) {
            const checkbox = document.getElementById('toggle' + (type === 'sink' ? 'Sinks' : 'Springs'));
            featureMarkers.filter(m => m._type === type).forEach(m => { m.getElement().style.display = checkbox.checked ? 'block' : 'none'; });
        }

        function toggleFlowlines() {
            const checkbox = document.getElementById('toggleFlowlines');
            if (map.getLayer('flowlines-layer')) map.setLayoutProperty('flowlines-layer', 'visibility', checkbox.checked ? 'visible' : 'none');
        }

        // ============================================
        // API QUERY FUNCTIONS
        // ============================================
        async function geocodeAddress() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) { alert('Enter an address'); return; }
            try {
                const res = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}&country=US&limit=1`).then(r => r.json());
                if (res.features && res.features.length) {
                    const [lon, lat] = res.features[0].center;
                    document.getElementById('lat').value = lat.toFixed(6);
                    document.getElementById('lon').value = lon.toFixed(6);
                    if (!document.getElementById('projectName').value) document.getElementById('projectName').value = res.features[0].place_name.split(',')[0];
                    map.flyTo({ center: [lon, lat], zoom: 14 });
                } else { alert('Address not found'); }
            } catch (e) { log('Geocode error:', e); alert('Geocoding failed'); }
        }

        async function fetchElevation(lat, lon) {
            try {
                const res = await fetch(`${API.USGS_ELEV}?x=${lon}&y=${lat}&units=Feet&wkid=4326`).then(r => r.json());
                if (res.value !== undefined) { data.elevation = res.value; return res.value; }
                return null;
            } catch (e) { log('Elevation error:', e); return null; }
        }

        async function fetch3DHP(lat, lon) {
            const buffer = 10 / KM_PER_DEGREE;
            const bbox = `${lon - buffer},${lat - buffer},${lon + buffer},${lat + buffer}`;
            const baseParams = '&geometryType=esriGeometryEnvelope&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=true&outSR=4326&f=json&resultRecordCount=100';
            try {
                const [sinks, springs, flowlines] = await Promise.all([
                    fetch(`${API.THREEDP}/20/query?where=featuretype%3D8&geometry=${bbox}${baseParams}`).then(r => r.json()),
                    fetch(`${API.THREEDP}/20/query?where=featuretype%3D7&geometry=${bbox}${baseParams}`).then(r => r.json()),
                    fetch(`${API.THREEDP}/50/query?where=1%3D1&geometry=${bbox}${baseParams}&resultRecordCount=50`).then(r => r.json())
                ]);
                return { sinks: sinks.features || [], springs: springs.features || [], flowlines: flowlines.features || [] };
            } catch (e) { log('3DHP error:', e); return { sinks: [], springs: [], flowlines: [] }; }
        }

        async function fetchKarstTerrain(lat, lon) {
            try {
                const res = await fetch(`https://mrdata.usgs.gov/services/karst?SERVICE=WFS&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=karstus&BBOX=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&SRSNAME=EPSG:4326&MAXFEATURES=1`);
                const text = await res.text();
                if (text.includes('Unable to access') || text.includes('404')) return { inKarst: false, rockType: null, serviceUnavailable: true };
                if (text.includes('karstus') && text.includes('gml:featureMember')) {
                    const rockMatch = text.match(/<ms:rock_type>([^<]+)<\/ms:rock_type>/);
                    return { inKarst: true, rockType: rockMatch ? rockMatch[1] : 'Carbonate' };
                }
                return { inKarst: false, rockType: null };
            } catch (e) { log('Karst terrain error:', e); return { inKarst: false, rockType: null, serviceUnavailable: true }; }
        }

        async function fetchSSURGO(lat, lon) {
            try {
                const buffer = 0.005;
                const wfsRes = await fetch(`${API.SSURGO_WFS}?SERVICE=WFS&VERSION=1.1.0&REQUEST=GetFeature&TYPENAME=mapunitpoly&BBOX=${lon-buffer},${lat-buffer},${lon+buffer},${lat+buffer}&SRSNAME=EPSG:4326&MAXFEATURES=1`);
                const wfsText = await wfsRes.text();
                const mukeyMatch = wfsText.match(/<ms:mukey>(\d+)<\/ms:mukey>/);
                if (!mukeyMatch) return null;
                const sqlQuery = `SELECT TOP 1 mu.mukey, mu.muname, c.compname, c.comppct_r, c.drainagecl, c.hydgrp, c.corcon, c.corsteel FROM mapunit mu INNER JOIN component c ON c.mukey = mu.mukey WHERE mu.mukey = '${mukeyMatch[1]}' ORDER BY c.comppct_r DESC`;
                const sqlRes = await fetch(API.SSURGO_SQL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: sqlQuery }) });
                const sqlText = await sqlRes.text();
                const get = tag => { const m = sqlText.match(new RegExp(`<${tag}>([^<]*)</${tag}>`)); return m ? m[1] : null; };
                const muname = get('muname');
                if (!muname) return null;
                return { mukey: get('mukey'), mapunit: muname, component: get('compname'), drainage: get('drainagecl'), hydro: get('hydgrp'), corConcrete: get('corcon'), corSteel: get('corsteel') };
            } catch (e) { log('SSURGO error:', e); return null; }
        }

        async function fetchSeismic(lat, lon) {
            try {
                const res = await fetch(`${API.USGS_SEISMIC}/asce7-16.json?latitude=${lat}&longitude=${lon}&riskCategory=II&siteClass=D&title=SiteScore`).then(r => r.json());
                if (res.response && res.response.data) {
                    const d = res.response.data;
                    return { pga: d.pga, ss: d.ss, s1: d.s1, sds: d.sds, sd1: d.sd1, sdc: d.sdc };
                }
                return null;
            } catch (e) { log('Seismic error:', e); return null; }
        }

        async function fetchWUI(lat, lon) {
            try {
                const result = { wuiClass: null, housingDensity: null, vegPercent: null, caFireSeverity: null, inWUI: false, score: 0 };
                const wuiRes = await fetch(`${API.USFS_WUI}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=WUICLASS2020,HUDEN2020,VEG2019PC&returnGeometry=false&f=json`).then(r => r.json());
                if (wuiRes.features && wuiRes.features.length > 0) {
                    const attrs = wuiRes.features[0].attributes;
                    result.wuiClass = attrs.WUICLASS2020;
                    result.housingDensity = attrs.HUDEN2020;
                    result.vegPercent = attrs.VEG2019PC;
                    if (result.wuiClass && (result.wuiClass.includes('Intermix') || result.wuiClass.includes('Interface'))) result.inWUI = true;
                }
                if (lon >= -124.5 && lon <= -114 && lat >= 32.5 && lat <= 42) {
                    const sraRes = await fetch(`${API.CA_FHSZ_SRA}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=HAZ_CLASS&returnGeometry=false&f=json`).then(r => r.json());
                    if (sraRes.features && sraRes.features.length > 0) result.caFireSeverity = sraRes.features[0].attributes.HAZ_CLASS;
                    else {
                        const lraRes = await fetch(`${API.CA_FHSZ_LRA}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=HAZ_CLASS&returnGeometry=false&f=json`).then(r => r.json());
                        if (lraRes.features && lraRes.features.length > 0) result.caFireSeverity = lraRes.features[0].attributes.HAZ_CLASS;
                    }
                }
                let score = 0;
                if (result.caFireSeverity === 'Very High') score = 10;
                else if (result.caFireSeverity === 'High') score = 8;
                else if (result.caFireSeverity === 'Moderate') score = 5;
                else if (result.wuiClass) {
                    if (result.wuiClass.includes('High_Dens_Intermix')) score = 9;
                    else if (result.wuiClass.includes('Med_Dens_Intermix')) score = 8;
                    else if (result.wuiClass.includes('Low_Dens_Intermix')) score = 7;
                    else if (result.wuiClass.includes('High_Dens_Interface')) score = 7;
                    else if (result.wuiClass.includes('Med_Dens_Interface')) score = 6;
                    else if (result.wuiClass.includes('Low_Dens_Interface')) score = 5;
                    else if (result.wuiClass.includes('Veg') && !result.wuiClass.includes('NoVeg')) score = 3;
                }
                if (result.inWUI && result.vegPercent > 75) score = Math.min(10, score + 1);
                result.score = score;
                result.risk = score >= 8 ? 'EXTREME' : score >= 6 ? 'HIGH' : score >= 4 ? 'MODERATE' : score >= 2 ? 'LOW' : 'MINIMAL';
                return result;
            } catch (e) { log('WUI error:', e); return null; }
        }

        async function fetchCASubsidence(lat, lon) {
            if (lon < -124.5 || lon > -114 || lat < 32.5 || lat > 42) return null;
            try {
                const buffer = 0.002;
                const geometry = encodeURIComponent(JSON.stringify({ xmin: lon-buffer, ymin: lat-buffer, xmax: lon+buffer, ymax: lat+buffer, spatialReference: { wkid: 4326 } }));
                const res = await fetch(`${API.CA_SUBSIDENCE_POINTS}/query?geometry=${geometry}&geometryType=esriGeometryEnvelope&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=false&f=json`).then(r => r.json());
                if (!res.features || res.features.length === 0) return { hasData: false, inMonitoredArea: false };
                const attrs = res.features[0].attributes;
                let totalDisplacement = null, annualRate = null;
                Object.keys(attrs).forEach(field => {
                    const lower = field.toLowerCase();
                    if ((lower.includes('total') || lower.includes('cum') || lower.includes('disp')) && typeof attrs[field] === 'number') totalDisplacement = attrs[field];
                    if ((lower.includes('rate') || lower.includes('annual') || lower.includes('velocity')) && typeof attrs[field] === 'number') annualRate = attrs[field];
                });
                const dispFeet = Math.abs(totalDisplacement || 0), dispInchesTotal = dispFeet * 12;
                const estimatedAnnualInches = annualRate ? Math.abs(annualRate * 12) : dispInchesTotal / 9;
                let score = estimatedAnnualInches >= 6 ? 10 : estimatedAnnualInches >= 4 ? 9 : estimatedAnnualInches >= 3 ? 8 : estimatedAnnualInches >= 2 ? 7 : estimatedAnnualInches >= 1 ? 6 : estimatedAnnualInches >= 0.5 ? 4 : estimatedAnnualInches >= 0.25 ? 2 : 1;
                return { hasData: true, inMonitoredArea: true, totalDisplacementFt: totalDisplacement, totalDisplacementIn: dispInchesTotal, estimatedAnnualIn: estimatedAnnualInches, score, risk: score >= 8 ? 'EXTREME' : score >= 6 ? 'HIGH' : score >= 4 ? 'MODERATE' : 'LOW' };
            } catch (e) { log('CA Subsidence error:', e); return null; }
        }

        async function fetchCALiquefaction(lat, lon) {
            if (lon < -124.5 || lon > -114 || lat < 32.5 || lat > 42) return null;
            try {
                const res = await fetch(`${API.CA_CGS_LIQUEFACTION}/query?geometry=${lon},${lat}&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&outFields=*&returnGeometry=false&f=json`).then(r => r.json());
                if (res.features && res.features.length > 0) {
                    return { inZone: true, zoneType: 'Liquefaction Zone of Required Investigation', authority: 'California Geological Survey' };
                }
                return { inZone: false, zoneType: null, authority: 'California Geological Survey' };
            } catch (e) { log('CGS Liquefaction error:', e); return null; }
        }
, totalWeight = 0;
            if (data.scores.karst !== null) { weightedSum += data.scores.karst * WEIGHTS.karst; totalWeight += WEIGHTS.karst; }
            if (data.scores.seismic !== null) { weightedSum += data.scores.seismic * WEIGHTS.seismic; totalWeight += WEIGHTS.seismic; }
            if (data.scores.flood !== null) { weightedSum += data.scores.flood * WEIGHTS.flood; totalWeight += WEIGHTS.flood; }
            if (data.scores.wildfire !== null) { weightedSum += data.scores.wildfire * WEIGHTS.wildfire; totalWeight += WEIGHTS.wildfire; }
            if (data.scores.wind !== null) { weightedSum += data.scores.wind * WEIGHTS.wind; totalWeight += WEIGHTS.wind; }
            if (data.scores.soil !== null) { weightedSum += data.scores.soil * WEIGHTS.soil; totalWeight += WEIGHTS.soil; }
            if (data.scores.subsidence !== null) { weightedSum += data.scores.subsidence * WEIGHTS.subsidence; totalWeight += WEIGHTS.subsidence; }
            data.scores.overall = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 10) / 10 : null;
        }

        function generateFlags() {
            data.flags = [];
            const k = data.karst, s = data.soil, eq = data.seismic, a = data.athenium, w = data.wui;
            
            if (k && k.score >= 8) data.flags.push({ severity: 'critical', title: 'EXTREME Karst Risk', detail: `Nearest karst feature ${k.nearest.dist.toFixed(2)} mi. Mandatory GPR/geotech evaluation.` });
            else if (k && k.score >= 6) data.flags.push({ severity: 'high', title: 'HIGH Karst Risk', detail: `Nearest feature ${k.nearest.dist.toFixed(2)} mi. Geotech strongly recommended.` });
            else if (k && k.score >= 4) data.flags.push({ severity: 'moderate', title: 'MODERATE Karst Risk', detail: `Karst features within ${k.nearest.dist.toFixed(1)} mi.` });
            if (k && k.inKarstTerrain && k.score < 6) data.flags.push({ severity: 'moderate', title: 'Karst Terrain', detail: `Site located in ${k.rockType || 'carbonate'} karst terrain.` });
            
            if (eq && eq.pga >= 0.40) data.flags.push({ severity: 'critical', title: 'EXTREME Seismic Zone', detail: `PGA ${(eq.pga * 100).toFixed(1)}% g. SDC ${eq.sdc}.` });
            else if (eq && eq.pga >= 0.15) data.flags.push({ severity: 'high', title: 'HIGH Seismic Risk', detail: `PGA ${(eq.pga * 100).toFixed(1)}% g. SDC ${eq.sdc}.` });
            
            if (s && s.isDisturbed) {
                if (s.disturbedType === 'Dump/Landfill') data.flags.push({ severity: 'critical', title: 'CRITICAL: Dump/Landfill Site', detail: `SSURGO indicates dump or landfill soil. MANDATORY geotech investigation. Map unit: ${s.mapunit}` });
                else if (s.disturbedType === 'Disturbed Fill (Udorthents)') data.flags.push({ severity: 'critical', title: 'CRITICAL: Disturbed Fill Soil', detail: `Site has disturbed/uncontrolled fill soil. MANDATORY geotech report. Map unit: ${s.mapunit}` });
                else if (s.disturbedType === 'Artificial Fill') data.flags.push({ severity: 'high', title: 'HIGH: Artificial Fill Site', detail: `SSURGO indicates man-made fill material. Geotech recommended. Map unit: ${s.mapunit}` });
                else if (s.disturbedType === 'Urban Modified') data.flags.push({ severity: 'moderate', title: 'Urban Modified Soil', detail: `Heavily urbanized soil with unknown modification history. Map unit: ${s.mapunit}` });
            }
            if (s && s.propertiesMissing) data.flags.push({ severity: 'moderate', title: 'Incomplete Soil Data', detail: 'Key soil properties not available. May indicate disturbed soil.' });
            if (s && s.corSteel === 'High') data.flags.push({ severity: 'high', title: 'High Steel Corrosion', detail: 'Soil corrosivity to steel rated HIGH. Cathodic protection required.' });
            if (s && s.drainage && s.drainage.toLowerCase().includes('poor')) data.flags.push({ severity: 'moderate', title: 'Poor Soil Drainage', detail: `${s.drainage} (Hydro Group ${s.hydro}). Dewatering may be required.` });
            
            if (a && a.flash >= 7) data.flags.push({ severity: 'critical', title: 'EXTREME Flash Flood', detail: `Athenium flash flood score ${a.flash}/10.` });
            else if (a && a.flash >= 5) data.flags.push({ severity: 'high', title: 'HIGH Flash Flood Risk', detail: `Athenium flash flood score ${a.flash}/10.` });
            if (a && a.hurricaneWind >= 8) data.flags.push({ severity: 'critical', title: 'EXTREME Hurricane Wind', detail: `Athenium hurricane wind score ${a.hurricaneWind}/10.` });
            else if (a && a.hurricaneWind >= 6) data.flags.push({ severity: 'high', title: 'HIGH Hurricane Wind', detail: `Athenium hurricane wind score ${a.hurricaneWind}/10.` });
            if (a && a.wind >= 8) data.flags.push({ severity: 'high', title: 'HIGH Wind Exposure', detail: `Athenium wind score ${a.wind}/10.` });
            if (a && a.wildfire >= 8) data.flags.push({ severity: 'critical', title: 'EXTREME Wildfire', detail: `Athenium wildfire score ${a.wildfire}/10.` });
            else if (a && a.wildfire >= 6) data.flags.push({ severity: 'high', title: 'HIGH Wildfire', detail: `Athenium wildfire score ${a.wildfire}/10.` });
            
            if (w && w.caFireSeverity === 'Very High') data.flags.push({ severity: 'critical', title: 'CA Very High Fire Hazard', detail: 'CAL FIRE FHSZ: Very High severity. Mandatory fire-resistant construction.' });
            else if (w && w.caFireSeverity === 'High') data.flags.push({ severity: 'high', title: 'CA High Fire Hazard', detail: 'CAL FIRE FHSZ: High severity.' });
            else if (w && w.inWUI && w.wuiClass && w.wuiClass.includes('Intermix')) data.flags.push({ severity: 'high', title: 'WUI Intermix Zone', detail: `USFS WUI 2020: ${w.wuiClass.replace(/_/g, ' ')}.` });
            
            const sub = data.subsidence;
            if (sub && sub.hasData) {
                if (sub.score >= 8) data.flags.push({ severity: 'critical', title: 'EXTREME Ground Subsidence', detail: `InSAR data shows ~${sub.estimatedAnnualIn.toFixed(1)} in/year subsidence.` });
                else if (sub.score >= 6) data.flags.push({ severity: 'high', title: 'HIGH Ground Subsidence', detail: `InSAR data shows ~${sub.estimatedAnnualIn.toFixed(1)} in/year subsidence.` });
                else if (sub.score >= 4) data.flags.push({ severity: 'moderate', title: 'MODERATE Ground Subsidence', detail: `InSAR data shows ~${sub.estimatedAnnualIn.toFixed(1)} in/year subsidence.` });
            }
            
            const liq = data.liquefaction;
            if (liq && liq.inZone) {
                const severity = (eq && eq.pga >= 0.40) ? 'critical' : 'high';
                data.flags.push({ severity, title: severity === 'critical' ? 'CRITICAL: CA Liquefaction Zone + Seismic' : 'CA Liquefaction Zone (CGS)', detail: 'Site is within CGS Liquefaction Zone. Mandatory geotechnical investigation per CGS SP-117A.' });
            }
        }

        // ============================================
        // MAIN ANALYSIS FUNCTION
        // ============================================
        function setLocation(name, lat, lon) {
            document.getElementById('projectName').value = name;
            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lon;
        }

        function updateLoadingStep(step, status) {
            const steps = document.getElementById('loadingSteps');
            const stepId = 'step-' + step.replace(/\s+/g, '-');
            const icons = { done: '‚úì', active: '‚óå', warning: '‚ö†', failed: '‚úó' };
            const icon = icons[status] || '‚óã';
            const existing = document.getElementById(stepId);
            if (existing) { existing.className = 'loading-step ' + status; existing.innerHTML = `<span class="check">${icon}</span> ${step}`; }
            else steps.innerHTML += `<div id="${stepId}" class="loading-step ${status}"><span class="check">${icon}</span> ${step}</div>`;
        }

        async function runAnalysis() {
            const name = document.getElementById('projectName').value || 'Unnamed Site';
            const lat = parseFloat(document.getElementById('lat').value);
            const lon = parseFloat(document.getElementById('lon').value);
            if (isNaN(lat) || isNaN(lon) || lat < 24 || lat > 50 || lon < -125 || lon > -66) { alert('Enter valid CONUS coordinates (24-50¬∞N, 66-125¬∞W)'); return; }
            
            data.project = name; data.coordinates = { lat, lon }; data.timestamp = new Date().toISOString(); data.flags = []; apiFailures = [];
            
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Analyzing...';
            document.getElementById('mapLoading').classList.add('active');
            document.getElementById('loadingSteps').innerHTML = '';
            document.getElementById('apiStatus').classList.remove('visible');
            
            try {
                updateLoadingStep('Elevation', 'active');
                document.getElementById('loadingDetail').textContent = 'Querying USGS Elevation...';
                data.elevation = await safeFetch(fetchElevation(lat, lon), 'Elevation', API_TIMEOUT_SHORT);
                updateLoadingStep('Elevation', data.elevation !== null ? 'done' : 'warning');
                
                updateLoadingStep('Karst Features', 'active');
                document.getElementById('loadingDetail').textContent = 'Querying USGS 3DHP...';
                const karstData = await safeFetch(fetch3DHP(lat, lon), 'Karst Features') || { sinks: [], springs: [], flowlines: [] };
                updateLoadingStep('Karst Features', 'done');
                
                updateLoadingStep('Karst Terrain', 'active');
                document.getElementById('loadingDetail').textContent = 'Querying Karst Terrain Map...';
                data.karstTerrain = await safeFetch(fetchKarstTerrain(lat, lon), 'Karst Terrain', API_TIMEOUT_SHORT);
                updateLoadingStep('Karst Terrain', data.karstTerrain ? 'done' : 'warning');
                
                data.karst = processKarst(karstData, data.karstTerrain, lat, lon);
                
                updateLoadingStep('Soil Survey', 'active');
                document.getElementById('loadingDetail').textContent = 'Querying USDA SSURGO...';
                data.soil = await safeFetch(fetchSSURGO(lat, lon), 'Soil Survey');
                updateLoadingStep('Soil Survey', data.soil ? 'done' : 'warning');
                
                updateLoadingStep('Seismic', 'active');
                document.getElementById('loadingDetail').textContent = 'Querying USGS Seismic...';
                data.seismic = await safeFetch(fetchSeismic(lat, lon), 'Seismic');
                updateLoadingStep('Seismic', data.seismic ? 'done' : 'warning');
                
                updateLoadingStep('Wildfire/WUI', 'active');
                document.getElementById('loadingDetail').textContent = 'Querying USFS WUI...';
                data.wui = await safeFetch(fetchWUI(lat, lon), 'Wildfire/WUI');
                updateLoadingStep('Wildfire/WUI', data.wui ? 'done' : 'warning');
                
                if (lon >= -124.5 && lon <= -114 && lat >= 32.5 && lat <= 42) {
                    updateLoadingStep('CA Subsidence', 'active');
                    document.getElementById('loadingDetail').textContent = 'Querying CA DWR InSAR...';
                    data.subsidence = await safeFetch(fetchCASubsidence(lat, lon), 'CA Subsidence');
                    updateLoadingStep('CA Subsidence', data.subsidence ? 'done' : 'warning');
                    
                    updateLoadingStep('CA Liquefaction', 'active');
                    document.getElementById('loadingDetail').textContent = 'Querying CGS Liquefaction...';
                    data.liquefaction = await safeFetch(fetchCALiquefaction(lat, lon), 'CA Liquefaction');
                    updateLoadingStep('CA Liquefaction', data.liquefaction ? 'done' : 'warning');
                } else { data.subsidence = null; data.liquefaction = null; }
                
                calculateScores(); generateFlags(); renderResults(); renderMapFeatures(karstData.sinks, karstData.springs, karstData.flowlines);
                flyToSite(lat, lon); updateMapInfo(); updateHeader(); updateScoreCard(); showApiStatus();
            } catch (err) { log('Analysis error:', err); alert('Analysis failed: ' + err.message); }
            finally { btn.disabled = false; btn.innerHTML = '<span>‚ö°</span> Analyze Site'; document.getElementById('mapLoading').classList.remove('active'); }
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function renderResults() {
            const container = document.getElementById('resultsContainer');
            const k = data.karst, s = data.soil;
            const karstColor = getScoreColor(k ? k.score : 0);
            
            let html = `<div class="result-card"><div class="result-header"><div class="result-title"><span>üï≥Ô∏è</span> USGS 3DHP - Karst</div><span class="result-badge ${k && k.score >= 8 ? 'badge-critical' : k && k.score >= 6 ? 'badge-high' : k && k.score >= 4 ? 'badge-moderate' : 'badge-low'}">${k ? k.risk : '‚Äî'}</span></div><div class="result-content"><div class="data-grid"><div class="data-item"><div class="data-label">Risk Score</div><div class="data-value xl" style="color:${karstColor}">${k ? k.score : '‚Äî'}/10</div></div><div class="data-item"><div class="data-label">Nearest</div><div class="data-value">${k && k.nearest ? k.nearest.dist.toFixed(2) + ' mi' : 'None'}</div></div><div class="data-item"><div class="data-label">Sinks</div><div class="data-value">${k ? k.sinks.length : 0}</div></div><div class="data-item"><div class="data-label">Springs</div><div class="data-value">${k ? k.springs.length : 0}</div></div></div>`;
            if (k && k.inKarstTerrain) html += `<div style="margin-top:8px;padding:8px;background:rgba(163,113,247,0.1);border-radius:6px;border-left:3px solid var(--brand-accent);font-size:10px"><strong>‚ö†Ô∏è Karst Terrain:</strong> ${escapeHtml(k.rockType) || 'Carbonate'}</div>`;
            html += '</div></div>';
            
            const soilBadge = s ? (s.corSteel === 'High' ? 'badge-high' : 'badge-low') : 'badge-info';
            const soilLabel = s ? (s.corSteel === 'High' ? 'CORROSIVE' : 'OK') : 'N/A';
            html += `<div class="result-card"><div class="result-header"><div class="result-title"><span>ü™®</span> USDA SSURGO</div><span class="result-badge ${soilBadge}">${soilLabel}</span></div><div class="result-content">`;
            if (s) {
                html += `<div class="data-grid"><div class="data-item full"><div class="data-label">Map Unit</div><div class="data-value sm">${escapeHtml(s.mapunit) || '‚Äî'}</div></div><div class="data-item"><div class="data-label">Drainage</div><div class="data-value sm">${escapeHtml(s.drainage) || '‚Äî'}</div></div><div class="data-item"><div class="data-label">Hydro</div><div class="data-value">${escapeHtml(s.hydro) || '‚Äî'}</div></div><div class="data-item"><div class="data-label">Steel Corr.</div><div class="data-value" style="color:${s.corSteel === 'High' ? 'var(--status-critical)' : 'inherit'}">${escapeHtml(s.corSteel) || '‚Äî'}</div></div><div class="data-item"><div class="data-label">Concrete Corr.</div><div class="data-value" style="color:${s.corConcrete === 'High' ? 'var(--status-high)' : 'inherit'}">${escapeHtml(s.corConcrete) || '‚Äî'}</div></div></div>`;
            } else html += '<div style="text-align:center;padding:16px;color:var(--text-muted)">No SSURGO data available</div>';
            html += '</div></div>';
            
            if (data.flags.length > 0) {
                html += `<div class="result-card"><div class="result-header"><div class="result-title"><span>‚ö†Ô∏è</span> Risk Flags (${data.flags.length})</div></div><div class="result-content">`;
                data.flags.forEach(f => {
                    const icon = f.severity === 'critical' ? 'üö®' : f.severity === 'high' ? '‚ö†Ô∏è' : '‚ö°';
                    html += `<div class="risk-flag ${f.severity}"><div class="risk-title">${icon} ${escapeHtml(f.title)}</div><div class="risk-detail">${escapeHtml(f.detail)}</div></div>`;
                });
                html += '</div></div>';
            }
            container.innerHTML = html;
        }

        function updateHeader() {
            const s = data.scores;
            const setScore = (id, val) => {
                const el = document.getElementById(id);
                if (val !== null && val !== undefined) { el.textContent = typeof val === 'number' && val % 1 !== 0 ? val.toFixed(1) : val; el.style.color = val >= 7 ? '#f85149' : val >= 5 ? '#f0883e' : val >= 3 ? '#d29922' : '#2ea043'; }
                else { el.textContent = '‚Äî'; el.style.color = ''; }
            };
            setScore('headerScore', s.overall); setScore('headerKarst', s.karst); setScore('headerSeismic', s.seismic);
            setScore('headerFlood', s.flood); setScore('headerWildfire', s.wildfire); setScore('headerWind', s.wind);
        }

        function updateScoreCard() {
            const s = data.scores;
            document.getElementById('scoreCard').style.display = 'block';
            const overall = document.getElementById('overallScore');
            overall.textContent = s.overall !== null ? s.overall.toFixed(1) : '‚Äî';
            overall.style.color = getScoreColor(s.overall || 0);
            const setItem = (id, val) => { const el = document.getElementById(id); el.textContent = val !== null ? val : '‚Äî'; el.style.color = getScoreColor(val || 0); };
            setItem('scoreKarst', s.karst); setItem('scoreSeismic', s.seismic); setItem('scoreFlood', s.flood);
            setItem('scoreWildfire', s.wildfire); setItem('scoreWind', s.wind); setItem('scoreSoil', s.soil); setItem('scoreSubsidence', s.subsidence);
            
            const criticals = data.flags.filter(f => f.severity === 'critical').length;
            const highs = data.flags.filter(f => f.severity === 'high').length;
            let rec, color;
            if (criticals >= 2) { rec = 'DECLINE / SPECIALIST'; color = 'var(--status-critical)'; }
            else if (criticals >= 1) { rec = 'REQUEST GEOTECH'; color = 'var(--status-high)'; }
            else if (highs >= 2) { rec = 'ENHANCED DD'; color = 'var(--status-moderate)'; }
            else if (highs >= 1 || data.flags.length >= 3) { rec = 'STANDARD + CONDITIONS'; color = 'var(--status-moderate)'; }
            else { rec = 'PROCEED STANDARD'; color = 'var(--status-low)'; }
            document.getElementById('recommendation').textContent = rec;
            document.getElementById('recommendation').style.color = color;
            
            const eq = data.seismic;
            if (eq) {
                document.getElementById('seismicCard').style.display = 'block';
                document.getElementById('seismicPGA').textContent = (eq.pga * 100).toFixed(1) + '%';
                document.getElementById('seismicPGA').style.color = eq.pga >= 0.15 ? 'var(--status-critical)' : 'var(--status-low)';
                document.getElementById('seismicScore').textContent = s.seismic + '/10';
                document.getElementById('seismicSDC').textContent = eq.sdc || '‚Äî';
                const badge = document.getElementById('seismicBadge');
                badge.textContent = eq.pga >= 0.40 ? 'EXTREME' : eq.pga >= 0.15 ? 'HIGH' : 'LOW';
                badge.className = 'result-badge ' + (eq.pga >= 0.40 ? 'badge-critical' : eq.pga >= 0.15 ? 'badge-high' : 'badge-low');
            }
            
            const w = data.wui;
            if (w && (w.wuiClass || w.caFireSeverity || s.wildfire)) {
                document.getElementById('wuiCard').style.display = 'block';
                document.getElementById('wuiClass').textContent = w.wuiClass ? w.wuiClass.replace(/_/g, ' ').substring(0, 20) : '‚Äî';
                document.getElementById('wuiScore').textContent = (s.wildfire || w.score || 0) + '/10';
                document.getElementById('wuiScore').style.color = getScoreColor(s.wildfire || w.score || 0);
                document.getElementById('caFireSeverity').textContent = w.caFireSeverity || '‚Äî';
                document.getElementById('caFireSeverity').style.color = w.caFireSeverity === 'Very High' ? 'var(--status-critical)' : w.caFireSeverity === 'High' ? 'var(--status-high)' : 'var(--status-low)';
                document.getElementById('wuiVeg').textContent = w.vegPercent != null ? w.vegPercent.toFixed(0) + '%' : '‚Äî';
                const wuiBadge = document.getElementById('wuiBadge');
                wuiBadge.textContent = w.risk || 'N/A';
                wuiBadge.className = 'result-badge ' + (w.score >= 8 ? 'badge-critical' : w.score >= 6 ? 'badge-high' : w.score >= 4 ? 'badge-moderate' : 'badge-low');
            }
            
            const sub = data.subsidence;
            if (sub && sub.hasData) {
                document.getElementById('subsidenceCard').style.display = 'block';
                document.getElementById('subsidenceRate').textContent = sub.estimatedAnnualIn.toFixed(1) + ' in/yr';
                document.getElementById('subsidenceRate').style.color = getScoreColor(sub.score);
                document.getElementById('subsidenceScore').textContent = sub.score + '/10';
                document.getElementById('subsidenceScore').style.color = getScoreColor(sub.score);
                document.getElementById('subsidenceTotal').textContent = sub.totalDisplacementIn.toFixed(1) + ' in';
                document.getElementById('subsidenceSource').textContent = 'TRE ALTAMIRA';
                const subBadge = document.getElementById('subsidenceBadge');
                subBadge.textContent = sub.risk;
                subBadge.className = 'result-badge ' + (sub.score >= 8 ? 'badge-critical' : sub.score >= 6 ? 'badge-high' : sub.score >= 4 ? 'badge-moderate' : 'badge-low');
            }
        }

        function updateMapInfo() {
            const c = data.coordinates, k = data.karst, eq = data.seismic, s = data.soil, w = data.wui;
            document.getElementById('infoCoords').textContent = c.lat.toFixed(4) + ', ' + c.lon.toFixed(4);
            document.getElementById('infoElevation').textContent = data.elevation !== null ? data.elevation.toFixed(1) + ' ft' : '‚Äî';
            document.getElementById('infoSink').textContent = k && k.sinks[0] ? k.sinks[0].dist.toFixed(2) + ' mi' : 'None';
            document.getElementById('infoKarstTerrain').textContent = k && k.inKarstTerrain ? (k.rockType || 'Yes') : 'No';
            document.getElementById('infoKarstTerrain').style.color = k && k.inKarstTerrain ? 'var(--status-moderate)' : 'var(--status-low)';
            document.getElementById('infoPGA').textContent = eq && eq.pga ? (eq.pga * 100).toFixed(1) + '% g' : '‚Äî';
            document.getElementById('infoSoil').textContent = s ? s.component : '‚Äî';
            if (w) {
                const wuiDisplay = w.wuiClass ? (w.wuiClass.includes('Intermix') ? 'Intermix' : w.wuiClass.includes('Interface') ? 'Interface' : 'Non-WUI') : 'Non-WUI';
                document.getElementById('infoWUI').textContent = wuiDisplay;
                document.getElementById('infoWUI').style.color = wuiDisplay === 'Intermix' ? 'var(--status-critical)' : wuiDisplay === 'Interface' ? 'var(--status-high)' : 'var(--status-low)';
                document.getElementById('infoFHSZ').textContent = w.caFireSeverity || (c.lon >= -124.5 && c.lon <= -114 ? 'None' : 'N/A');
                document.getElementById('infoFHSZ').style.color = w.caFireSeverity === 'Very High' ? 'var(--status-critical)' : w.caFireSeverity === 'High' ? 'var(--status-high)' : 'var(--status-low)';
            }
            const sub = data.subsidence;
            if (sub && sub.hasData) { document.getElementById('infoSubsidence').textContent = sub.estimatedAnnualIn.toFixed(1) + ' in/yr'; document.getElementById('infoSubsidence').style.color = sub.score >= 8 ? 'var(--status-critical)' : sub.score >= 6 ? 'var(--status-high)' : sub.score >= 4 ? 'var(--status-moderate)' : 'var(--status-low)'; }
            else if (c.lon >= -124.5 && c.lon <= -114 && c.lat >= 32.5 && c.lat <= 42) { document.getElementById('infoSubsidence').textContent = 'No data'; document.getElementById('infoSubsidence').style.color = 'var(--text-muted)'; }
            else { document.getElementById('infoSubsidence').textContent = 'N/A'; document.getElementById('infoSubsidence').style.color = 'var(--text-muted)'; }
            const liq = data.liquefaction;
            if (liq && liq.inZone) { document.getElementById('infoLiquefaction').textContent = 'IN ZONE'; document.getElementById('infoLiquefaction').style.color = 'var(--status-high)'; }
            else if (c.lon >= -124.5 && c.lon <= -114 && c.lat >= 32.5 && c.lat <= 42) { document.getElementById('infoLiquefaction').textContent = liq ? 'Not in zone' : 'No data'; document.getElementById('infoLiquefaction').style.color = 'var(--status-low)'; }
            else { document.getElementById('infoLiquefaction').textContent = 'N/A'; document.getElementById('infoLiquefaction').style.color = 'var(--text-muted)'; }
        }

        function updateFloodRiskCard(parsed) {
            const fd = parsed.floodDetails || {};
            if (!parsed.river && !parsed.flash && !fd.bfe && !parsed.fema) { document.getElementById('floodRiskCard').style.display = 'none'; return; }
            document.getElementById('floodRiskCard').style.display = 'block';
            if (parsed.river) { document.getElementById('floodRiver').textContent = parsed.river + '/10'; document.getElementById('floodRiver').style.color = parsed.river >= 8 ? 'var(--status-critical)' : parsed.river >= 6 ? 'var(--status-high)' : 'var(--status-low)'; }
            if (parsed.flash) { document.getElementById('floodFlash').textContent = parsed.flash + '/10'; document.getElementById('floodFlash').style.color = parsed.flash >= 7 ? 'var(--status-critical)' : parsed.flash >= 5 ? 'var(--status-high)' : 'var(--status-low)'; }
            if (parsed.fema) { document.getElementById('floodFema').textContent = parsed.fema; document.getElementById('floodFema').style.color = ['A','AE','AH','AO','V','VE'].includes(parsed.fema.toUpperCase()) ? 'var(--status-critical)' : 'var(--status-low)'; }
            if (fd.bfe) document.getElementById('floodBfe').textContent = fd.bfe.toFixed(1) + ' ft';
            const elev = parsed.elevation || data.elevation;
            if (elev) document.getElementById('floodElev').textContent = elev.toFixed(1) + ' ft';
            const freeboardEl = document.getElementById('floodFreeboard'), alertEl = document.getElementById('freeboardAlert');
            if (fd.freeboard !== undefined) {
                freeboardEl.textContent = fd.freeboard.toFixed(1) + ' ft';
                if (fd.freeboard < 0) { freeboardEl.style.color = 'var(--status-critical)'; alertEl.innerHTML = `<div class="freeboard-warning">‚ö†Ô∏è <strong>CRITICAL:</strong> Property is ${Math.abs(fd.freeboard).toFixed(1)} ft BELOW BFE</div>`; }
                else if (fd.freeboard < 2) { freeboardEl.style.color = 'var(--status-moderate)'; alertEl.innerHTML = `<div class="freeboard-moderate">‚ö° Low freeboard - only ${fd.freeboard.toFixed(1)} ft above BFE</div>`; }
                else { freeboardEl.style.color = 'var(--status-low)'; alertEl.innerHTML = `<div class="freeboard-ok">‚úì Adequate freeboard: ${fd.freeboard.toFixed(1)} ft above BFE</div>`; }
            }
            if (fd.inund100) { document.getElementById('floodInund100').textContent = fd.inund100.toFixed(1) + ' ft'; document.getElementById('floodInund100').style.color = fd.inund100 >= 10 ? 'var(--status-critical)' : fd.inund100 >= 5 ? 'var(--status-high)' : 'var(--status-moderate)'; }
            if (fd.inund500) { document.getElementById('floodInund500').textContent = fd.inund500.toFixed(1) + ' ft'; document.getElementById('floodInund500').style.color = fd.inund500 >= 15 ? 'var(--status-critical)' : fd.inund500 >= 8 ? 'var(--status-high)' : 'var(--status-moderate)'; }
            const badge = document.getElementById('floodRiskBadge'), maxFlood = Math.max(parsed.river || 0, parsed.flash || 0);
            if (maxFlood >= 8) { badge.textContent = 'EXTREME'; badge.className = 'result-badge badge-critical'; }
            else if (maxFlood >= 6) { badge.textContent = 'HIGH'; badge.className = 'result-badge badge-high'; }
            else if (maxFlood >= 4) { badge.textContent = 'MODERATE'; badge.className = 'result-badge badge-moderate'; }
            else { badge.textContent = 'LOW'; badge.className = 'result-badge badge-low'; }
        }

        function updateHistoryCard(parsed) {
            const h = parsed.history || {};
            if (!h.hailEvents && !h.windEvents && (!parsed.hurricanes || !parsed.hurricanes.length)) { document.getElementById('historyCard').style.display = 'none'; return; }
            document.getElementById('historyCard').style.display = 'block';
            if (h.hailEvents) document.getElementById('histHail').textContent = h.hailEvents;
            if (h.windEvents) document.getElementById('histWind').textContent = h.windEvents;
            if (h.maxHail) { document.getElementById('histMaxHail').textContent = h.maxHail.toFixed(1) + '"'; document.getElementById('histMaxHail').style.color = h.maxHail >= 2 ? 'var(--status-critical)' : h.maxHail >= 1 ? 'var(--status-high)' : 'var(--status-low)'; }
            if (h.maxWind) { document.getElementById('histMaxWind').textContent = h.maxWind.toFixed(0) + ' mph'; document.getElementById('histMaxWind').style.color = h.maxWind >= 75 ? 'var(--status-critical)' : h.maxWind >= 58 ? 'var(--status-high)' : 'var(--status-low)'; }
            if (parsed.hurricanes && parsed.hurricanes.length > 0) {
                document.getElementById('hurricaneTimeline').style.display = 'block';
                let hHtml = '';
                parsed.hurricanes.forEach(storm => {
                    const windColor = storm.wind >= 111 ? 'var(--status-critical)' : storm.wind >= 96 ? 'var(--status-high)' : 'var(--status-moderate)';
                    hHtml += `<div class="hurricane-event"><span class="hurricane-name">üåÄ ${escapeHtml(storm.name.toUpperCase())}</span><span class="hurricane-date">${escapeHtml(storm.date)}</span><span class="hurricane-wind" style="color:${windColor}">${storm.wind.toFixed(0)} mph</span></div>`;
                });
                document.getElementById('hurricaneEvents').innerHTML = hHtml;
            }
            const badge = document.getElementById('historyBadge'), totalEvents = (h.hailEvents || 0) + (h.windEvents || 0);
            if (totalEvents >= 50 || (parsed.hurricanes && parsed.hurricanes.length >= 2)) { badge.textContent = 'HIGH ACTIVITY'; badge.className = 'result-badge badge-high'; }
            else if (totalEvents >= 20) { badge.textContent = 'MODERATE'; badge.className = 'result-badge badge-moderate'; }
            else { badge.textContent = 'LOW'; badge.className = 'result-badge badge-low'; }
        }

        // ============================================
        // ATHENIUM PARSER
        // ============================================
        function parseAthenium() {
            const text = document.getElementById('atheniumPaste').value;
            if (!text.trim()) return;
            const extract = (regex) => { const match = text.match(regex); return match ? parseFloat(match[1].replace(/,/g, '')) : null; };
            const parsed = {
                river: extract(/river(?:\s*flood)?(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                flash: extract(/flash(?:\s*flood)?(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                elevation: extract(/elevation[:\s]*(\d+(?:,\d+)?(?:\.\d+)?)\s*(?:ft|feet|')/i),
                hurricaneWind: extract(/hurricane\s*wind(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                wind: extract(/(?:^|[^e]\s)wind(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                hail: extract(/hail(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                tornado: extract(/tornado(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                rainfall: extract(/rainfall(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                wildfire: extract(/wildfire(?:\s*score)?[:\s]*(\d+(?:\.\d+)?)/i),
                fema: (text.match(/fema.*?zone[:\s]*([A-Z0-9]+)/i) || [])[1],
                floodDetails: { bfe: extract(/base\s*flood\s*elevation[:\s]*(\d+(?:\.\d+)?)/i), freeboard: extract(/freeboard[:\s]*([-]?\d+(?:\.\d+)?)/i), inund100: extract(/100[-\s]*(?:yr|year)\s*(?:inundation|depth|flood)[:\s]*(\d+(?:\.\d+)?)/i), inund500: extract(/500[-\s]*(?:yr|year)\s*(?:inundation|depth|flood)[:\s]*(\d+(?:\.\d+)?)/i) },
                history: { hailEvents: extract(/hail\s*events[:\s]*(\d+)/i), windEvents: extract(/wind\s*events[:\s]*(\d+)/i), maxHail: extract(/max(?:imum)?\s*hail[:\s]*(\d+(?:\.\d+)?)/i), maxWind: extract(/max(?:imum)?\s*wind[:\s]*(\d+(?:\.\d+)?)/i) },
                hurricanes: []
            };
            const hurricanePattern = /hurricane\s+(\w+)[:\s]*(\d+(?:\.\d+)?)\s*mph\s*\(([^)]+)\)/gi;
            let hMatch; while ((hMatch = hurricanePattern.exec(text)) !== null) parsed.hurricanes.push({ name: hMatch[1], wind: parseFloat(hMatch[2]), date: hMatch[3] });
            if (parsed.hurricaneWind && !parsed.wind) parsed.wind = parsed.hurricaneWind;
            else if (parsed.hurricaneWind && parsed.wind) parsed.wind = Math.max(parsed.wind, parsed.hurricaneWind);
            data.athenium = parsed;
            if (parsed.history && Object.keys(parsed.history).some(k => parsed.history[k])) data.history = parsed.history;
            if (parsed.hurricanes && parsed.hurricanes.length > 0) { data.history = data.history || {}; data.history.hurricanes = parsed.hurricanes; }
            if (parsed.floodDetails && Object.keys(parsed.floodDetails).some(k => parsed.floodDetails[k])) { data.floodRisk = parsed.floodDetails; if (data.elevation) data.floodRisk.elevation = data.elevation; }
            document.getElementById('atheniumDisplay').style.display = 'block';
            let html = '';
            const displayKeys = ['river', 'flash', 'wind', 'hail', 'wildfire', 'tornado', 'fema'];
            for (const k of displayKeys) {
                if (parsed[k] !== undefined && parsed[k] !== null) {
                    const v = parsed[k], color = typeof v === 'number' && v >= 7 ? 'var(--status-critical)' : typeof v === 'number' && v >= 5 ? 'var(--status-moderate)' : 'var(--status-low)';
                    html += `<div class="athenium-row"><span class="label">${k.toUpperCase()}</span><span class="value" style="color:${color}">${typeof v === 'number' ? v + '/10' : v}</span></div>`;
                }
            }
            document.getElementById('atheniumParsed').innerHTML = html;
            updateFloodRiskCard(parsed); updateHistoryCard(parsed); calculateScores(); generateFlags(); updateHeader(); updateScoreCard(); renderResults();
        }

        // ============================================
        // MAP FEATURES
        // ============================================
        function flyToSite(lat, lon) {
            if (siteMarker) { siteMarker.remove(); siteMarker = null; }
            const el = document.createElement('div');
            el.style.cssText = 'width:18px;height:18px;background:#f85149;border:3px solid white;border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,0.5);animation:glow 2s ease-in-out infinite';
            siteMarker = new mapboxgl.Marker(el).setLngLat([lon, lat]).addTo(map);
            map.flyTo({ center: [lon, lat], zoom: 13, pitch: 45, duration: 2000 });
        }

        function renderMapFeatures(sinks, springs, flowlines) {
            featureMarkers.forEach(m => m.remove()); featureMarkers = [];
            if (map.getLayer('flowlines-layer')) map.removeLayer('flowlines-layer');
            if (map.getSource('flowlines')) map.removeSource('flowlines');
            sinks.forEach(f => {
                const el = document.createElement('div');
                el.style.cssText = 'width:10px;height:10px;background:#a371f7;border:2px solid white;border-radius:50%;cursor:pointer';
                const marker = new mapboxgl.Marker(el).setLngLat([f.geometry.x, f.geometry.y]).setPopup(new mapboxgl.Popup().setHTML(`<div class="popup-title">üï≥Ô∏è Sink</div><div class="popup-detail">${escapeHtml(f.attributes?.gnisidlabel) || 'Unnamed'}</div>`)).addTo(map);
                marker._type = 'sink'; featureMarkers.push(marker);
            });
            springs.forEach(f => {
                const el = document.createElement('div');
                el.style.cssText = 'width:10px;height:10px;background:#58a6ff;border:2px solid white;border-radius:50%;cursor:pointer';
                const marker = new mapboxgl.Marker(el).setLngLat([f.geometry.x, f.geometry.y]).setPopup(new mapboxgl.Popup().setHTML(`<div class="popup-title">üíß Spring</div><div class="popup-detail">${escapeHtml(f.attributes?.gnisidlabel) || 'Unnamed'}</div>`)).addTo(map);
                marker._type = 'spring'; featureMarkers.push(marker);
            });
            if (flowlines.length) {
                const geojson = { type: 'FeatureCollection', features: flowlines.filter(f => f.geometry?.paths).map(f => ({ type: 'Feature', geometry: { type: 'LineString', coordinates: f.geometry.paths[0] } })) };
                map.addSource('flowlines', { type: 'geojson', data: geojson });
                map.addLayer({ id: 'flowlines-layer', type: 'line', source: 'flowlines', paint: { 'line-color': '#58a6ff', 'line-width': 2, 'line-opacity': 0.7 } });
            }
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        function copyJSON() { navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => alert('JSON copied to clipboard')); }

        async function captureMapImage() {
            return new Promise((resolve) => {
                if (map.loaded() && !map.isMoving()) {
                    try { resolve(map.getCanvas().toDataURL('image/png')); } catch (e) { resolve(null); }
                } else {
                    map.once('idle', () => { setTimeout(() => { try { resolve(map.getCanvas().toDataURL('image/png')); } catch (e) { resolve(null); } }, 500); });
                }
            });
        }

        async function generateReport() {
            const c = data.coordinates;
            if (!c) { alert('Please run an analysis first'); return; }
            const k = data.karst, s = data.soil, eq = data.seismic, w = data.wui, a = data.athenium, flags = data.flags, scores = data.scores;
            const rec = document.getElementById('recommendation').textContent;
            const h = data.history || {}, f = data.floodRisk || {};
            const mapImage = await captureMapImage();
            const activeLayers = [];
            ['Sinks', 'Springs', 'Flowlines', 'KarstTerrain', 'FemaFlood', 'WUI', 'FHSZ', 'CASubsidence'].forEach(layer => {
                const el = document.getElementById('toggle' + layer);
                if (el && el.checked) activeLayers.push(layer.replace(/([A-Z])/g, ' $1').trim());
            });
            
            let hurricaneHtml = '';
            if (h.hurricanes && h.hurricanes.length > 0) {
                hurricaneHtml = '<div style="margin-top:12px;padding:12px;background:#fff7ed;border-radius:8px;border:1px solid #f0883e"><div style="font-size:11px;font-weight:700;color:#c2410c;margin-bottom:8px">üåÄ Hurricane History</div>';
                h.hurricanes.forEach(hur => {
                    const windColor = hur.wind >= 74 ? '#f85149' : hur.wind >= 58 ? '#f0883e' : '#d29922';
                    hurricaneHtml += `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:11px;border-bottom:1px solid #fed7aa"><span style="font-weight:600">${escapeHtml(hur.name)}</span><span style="color:#78716c">${escapeHtml(hur.date)}</span><span style="font-weight:700;color:${windColor}">${hur.wind.toFixed(1)} mph</span></div>`;
                });
                hurricaneHtml += '</div>';
            }
            
            let floodDetailHtml = '';
            if (f.bfe || f.freeboard !== undefined) {
                const fbColor = f.freeboard < 0 ? '#f85149' : f.freeboard < 2 ? '#d29922' : '#2ea043';
                const fbLabel = f.freeboard < 0 ? '‚ö†Ô∏è BELOW BFE' : f.freeboard < 2 ? '‚ö†Ô∏è LOW FREEBOARD' : '‚úì OK';
                floodDetailHtml = `<div style="margin-top:12px;padding:12px;background:${f.freeboard < 0 ? '#fef2f2' : f.freeboard < 2 ? '#fefce8' : '#f0fdf4'};border-radius:8px;border:1px solid ${fbColor}"><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center"><div><div class="label">BFE</div><div style="font-weight:700">${f.bfe ? f.bfe.toFixed(1) + ' ft' : '‚Äî'}</div></div><div><div class="label">Site Elev</div><div style="font-weight:700">${f.elevation ? f.elevation.toFixed(1) + ' ft' : '‚Äî'}</div></div><div><div class="label">Freeboard</div><div style="font-weight:700;color:${fbColor}">${f.freeboard !== undefined ? f.freeboard.toFixed(1) + ' ft' : '‚Äî'}</div></div><div><div class="label">Status</div><div style="font-weight:700;color:${fbColor}">${fbLabel}</div></div></div></div>`;
            }
            
            let flagsHtml = '';
            if (flags.length) {
                flagsHtml = `<div class="section"><h2>‚ö†Ô∏è Risk Flags (${flags.length})</h2>`;
                flags.forEach(fl => {
                    const icon = fl.severity === 'critical' ? 'üö®' : fl.severity === 'high' ? '‚ö†Ô∏è' : '‚ö°';
                    flagsHtml += `<div class="flag ${fl.severity}"><div class="flag-title">${icon} ${escapeHtml(fl.title)}</div><div class="flag-detail">${escapeHtml(fl.detail)}</div></div>`;
                });
                flagsHtml += '</div>';
            }

            const html = `<!DOCTYPE html><html><head><title>SiteScore Report - ${escapeHtml(data.project)}</title>
<style>*{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;max-width:850px;margin:0 auto;padding:20px;color:#1a1a2e;background:white;font-size:12px}@media print{body{padding:0;max-width:100%}.no-print{display:none!important}.page-break{page-break-before:always}.section{box-shadow:none;border:1px solid #e2e8f0}}@page{margin:0.5in;size:letter}.header-compact{background:linear-gradient(135deg,#238636,#1f6feb);padding:16px 20px;border-radius:10px;color:white;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.header-compact::before{content:none}.header-left h1{margin:0;font-size:18px}.header-left .subtitle{font-size:13px;opacity:0.9;margin-top:2px}.header-left .coords{font-size:10px;opacity:0.8;margin-top:4px}.score-compact{text-align:center;padding:8px 20px;background:rgba(0,0,0,0.2);border-radius:8px}.score-compact .label{font-size:9px;text-transform:uppercase;opacity:0.8}.score-compact .value{font-size:36px;font-weight:900;font-family:monospace;line-height:1}.score-compact .scale{font-size:8px;opacity:0.7}.map-compact{margin-bottom:12px}.map-compact img{width:100%;border-radius:8px;border:1px solid #e2e8f0;max-height:300px;object-fit:cover}.map-compact .layers{font-size:9px;color:#94a3b8;margin-top:4px}.section{background:white;padding:14px;border-radius:8px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}.section h2{margin:0 0 10px;font-size:12px;color:#1a365d;border-bottom:1px solid #e2e8f0;padding-bottom:6px;display:flex;align-items:center;gap:6px}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.grid6{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}.grid7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}.item{background:#f8fafc;padding:8px;border-radius:6px;text-align:center}.item.full{grid-column:span 3}.label{font-size:8px;color:#64748b;text-transform:uppercase;letter-spacing:0.3px}.value{font-size:13px;font-weight:700}.value.sm{font-size:10px}.flag{padding:8px 10px;margin-bottom:6px;border-left:3px solid;border-radius:0 6px 6px 0;font-size:11px}.flag.critical{border-color:#f85149;background:#fef2f2}.flag.high{border-color:#f0883e;background:#fff7ed}.flag.moderate{border-color:#d29922;background:#fefce8}.flag-title{font-weight:700;margin-bottom:2px}.flag-detail{font-size:10px;color:#475569}.rec-box{text-align:center;padding:12px;background:#f8fafc;border-radius:8px;font-size:18px;font-weight:800}.footer{margin-top:16px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:9px;color:#94a3b8;text-align:center}.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}</style></head><body>
<div class="header-compact"><div class="header-left"><h1>üìç SiteScore‚Ñ¢ v1.3.6</h1><div class="subtitle">${escapeHtml(data.project)}</div><div class="coords">${c.lat.toFixed(6)}, ${c.lon.toFixed(6)}${data.elevation ? ' ‚Ä¢ Elev: ' + data.elevation.toFixed(0) + ' ft' : ''} ‚Ä¢ ${new Date().toLocaleDateString()}</div></div><div class="score-compact"><div class="label">Site Risk</div><div class="value">${scores.overall !== null ? scores.overall.toFixed(1) : '‚Äî'}</div><div class="scale">0=Best 10=Worst</div></div></div>
${mapImage ? `<div class="map-compact"><img src="${mapImage}" alt="Site Map"><div class="layers">Layers: ${activeLayers.length ? activeLayers.join(', ') : 'Base map only'}</div></div>` : ''}
<div class="section"><h2>üìä Score Breakdown</h2><div class="grid7"><div class="item"><div class="label">Karst</div><div class="value" style="color:${scores.karst >= 6 ? '#f85149' : '#2ea043'}">${scores.karst !== null ? scores.karst : '‚Äî'}</div></div><div class="item"><div class="label">Seismic</div><div class="value" style="color:${scores.seismic >= 6 ? '#f85149' : '#2ea043'}">${scores.seismic !== null ? scores.seismic : '‚Äî'}</div></div><div class="item"><div class="label">Flood</div><div class="value" style="color:${scores.flood >= 6 ? '#f85149' : '#2ea043'}">${scores.flood !== null ? scores.flood : '‚Äî'}</div></div><div class="item"><div class="label">Fire</div><div class="value" style="color:${scores.wildfire >= 6 ? '#f85149' : '#2ea043'}">${scores.wildfire !== null ? scores.wildfire : '‚Äî'}</div></div><div class="item"><div class="label">Wind</div><div class="value" style="color:${scores.wind >= 6 ? '#f85149' : '#2ea043'}">${scores.wind !== null ? scores.wind : '‚Äî'}</div></div><div class="item"><div class="label">Soil</div><div class="value" style="color:${scores.soil >= 6 ? '#f85149' : '#2ea043'}">${scores.soil !== null ? scores.soil : '‚Äî'}</div></div><div class="item"><div class="label">Subsid</div><div class="value" style="color:${scores.subsidence >= 6 ? '#f85149' : '#2ea043'}">${scores.subsidence !== null ? scores.subsidence : '‚Äî'}</div></div></div></div>
<div class="section"><h2>üéØ Recommendation</h2><div class="rec-box" style="color:${rec.includes('DECLINE') ? '#f85149' : rec.includes('GEOTECH') ? '#f0883e' : rec.includes('ENHANCED') || rec.includes('CONDITIONS') ? '#d29922' : '#2ea043'}">${escapeHtml(rec)}</div></div>
${flagsHtml}
<div class="page-break"></div>
<div class="two-col"><div class="section"><h2>üï≥Ô∏è Karst (USGS 3DHP)</h2><div class="grid"><div class="item"><div class="label">Score</div><div class="value" style="color:${k && k.score >= 6 ? '#f85149' : '#2ea043'}">${k ? k.score : 0}/10</div></div><div class="item"><div class="label">Nearest</div><div class="value sm">${k && k.nearest ? k.nearest.dist.toFixed(2) + ' mi' : 'None'}</div></div><div class="item"><div class="label">Features</div><div class="value">${k ? k.sinks.length + k.springs.length : 0}</div></div></div></div>
<div class="section"><h2>üåã Seismic (USGS)</h2><div class="grid"><div class="item"><div class="label">PGA</div><div class="value" style="color:${eq && eq.pga >= 0.15 ? '#f85149' : '#2ea043'}">${eq ? (eq.pga * 100).toFixed(1) + '%' : '‚Äî'}</div></div><div class="item"><div class="label">SDC</div><div class="value">${eq ? eq.sdc || '‚Äî' : '‚Äî'}</div></div><div class="item"><div class="label">Score</div><div class="value">${scores.seismic !== null ? scores.seismic : '‚Äî'}/10</div></div></div></div></div>
${a ? `<div class="section"><h2>üåä Climate Intelligence (Athenium)</h2><div class="grid6"><div class="item"><div class="label">Flash Flood</div><div class="value" style="color:${a.flash >= 7 ? '#f85149' : a.flash >= 5 ? '#d29922' : '#2ea043'}">${a.flash || '‚Äî'}</div></div><div class="item"><div class="label">River Flood</div><div class="value" style="color:${a.river >= 7 ? '#f85149' : '#2ea043'}">${a.river || '‚Äî'}</div></div><div class="item"><div class="label">Wind</div><div class="value" style="color:${a.wind >= 8 ? '#f85149' : '#2ea043'}">${a.wind || '‚Äî'}</div></div><div class="item"><div class="label">Hail</div><div class="value">${a.hail || '‚Äî'}</div></div><div class="item"><div class="label">Wildfire</div><div class="value">${a.wildfire || '‚Äî'}</div></div><div class="item"><div class="label">FEMA Zone</div><div class="value" style="color:${['A','AE','AH','AO','V','VE'].includes(a.fema) ? '#f85149' : '#2ea043'}">${a.fema || '‚Äî'}</div></div></div>${floodDetailHtml}</div>` : ''}
${(h.hailEvents || h.windEvents || (h.hurricanes && h.hurricanes.length)) ? `<div class="section"><h2>üìú Historical Weather</h2><div class="grid4"><div class="item"><div class="label">Hail Events</div><div class="value">${h.hailEvents || '‚Äî'}</div></div><div class="item"><div class="label">Max Hail</div><div class="value" style="color:${h.maxHail >= 1.5 ? '#f85149' : '#2ea043'}">${h.maxHail ? h.maxHail.toFixed(2) + '"' : '‚Äî'}</div></div><div class="item"><div class="label">Wind Events</div><div class="value">${h.windEvents || '‚Äî'}</div></div><div class="item"><div class="label">Max Wind</div><div class="value" style="color:${h.maxWind >= 74 ? '#f85149' : h.maxWind >= 58 ? '#f0883e' : '#2ea043'}">${h.maxWind ? h.maxWind.toFixed(1) + ' mph' : '‚Äî'}</div></div></div>${hurricaneHtml}</div>` : ''}
<div class="two-col"><div class="section"><h2>üî• Wildfire/WUI</h2><div class="grid"><div class="item"><div class="label">WUI Class</div><div class="value sm">${w && w.wuiClass ? escapeHtml(w.wuiClass.replace(/_/g, ' ').substring(0, 15)) : '‚Äî'}</div></div><div class="item"><div class="label">CA FHSZ</div><div class="value sm" style="color:${w && w.caFireSeverity === 'Very High' ? '#f85149' : '#2ea043'}">${w ? w.caFireSeverity || 'N/A' : 'N/A'}</div></div><div class="item"><div class="label">Score</div><div class="value">${scores.wildfire !== null ? scores.wildfire : '‚Äî'}/10</div></div></div></div>
<div class="section"><h2>ü™® Soil (SSURGO)</h2>${s && s.mapunit ? `<div style="font-size:10px;color:#64748b;margin-bottom:8px;text-align:center">${escapeHtml(s.mapunit)}</div>` : ''}<div class="grid4"><div class="item"><div class="label">Drainage</div><div class="value sm">${s && s.drainage ? escapeHtml(s.drainage.substring(0, 12)) : '‚Äî'}</div></div><div class="item"><div class="label">Hydro</div><div class="value">${s ? s.hydro || '‚Äî' : '‚Äî'}</div></div><div class="item"><div class="label">Steel Corr</div><div class="value" style="color:${s && s.corSteel === 'High' ? '#f85149' : '#2ea043'}">${s ? s.corSteel || '‚Äî' : '‚Äî'}</div></div><div class="item"><div class="label">Concrete</div><div class="value" style="color:${s && s.corConcrete === 'High' ? '#f85149' : '#2ea043'}">${s ? s.corConcrete || '‚Äî' : '‚Äî'}</div></div></div></div></div>
${data.subsidence && data.subsidence.hasData ? `<div class="section"><h2>üìâ CA Subsidence (DWR InSAR)</h2><div class="grid4"><div class="item"><div class="label">Annual Rate</div><div class="value" style="color:${data.subsidence.score >= 6 ? '#f85149' : '#2ea043'}">${data.subsidence.estimatedAnnualIn.toFixed(1)} in/yr</div></div><div class="item"><div class="label">Total</div><div class="value">${data.subsidence.totalDisplacementIn.toFixed(1)} in</div></div><div class="item"><div class="label">Score</div><div class="value">${data.subsidence.score}/10</div></div><div class="item"><div class="label">Risk</div><div class="value sm">${data.subsidence.risk}</div></div></div></div>` : ''}
${data.liquefaction && data.liquefaction.inZone ? `<div class="section" style="background:#fff7ed;border:2px solid #f0883e"><h2>‚ö†Ô∏è CA Liquefaction Zone</h2><div style="font-size:11px;color:#475569;line-height:1.4"><strong style="color:#c2410c">SITE IN SEISMIC HAZARD ZONE OF REQUIRED INVESTIGATION</strong><br>Per Seismic Hazards Mapping Act (PRC ¬ß2690), site-specific geotech investigation required. Request report per CGS SP-117A with liquefaction analysis.</div></div>` : ''}
<div class="footer"><div>SiteScore‚Ñ¢ v1.3.6 | Know Before You Bind | ${new Date().toLocaleString()}</div><div style="margin-top:4px">Data: USGS 3DHP, SSURGO, Design Maps ‚Ä¢ USFS WUI 2020 ‚Ä¢ CAL FIRE FHSZ ‚Ä¢ CA DWR InSAR ‚Ä¢ CA CGS ‚Ä¢ Athenium Analytics</div><div style="margin-top:4px;font-style:italic">Pre-underwriting triage only. Does not replace site-specific geotechnical investigation.</div></div>
<div class="no-print" style="text-align:center;margin-top:20px"><button onclick="window.print()" style="padding:12px 28px;background:linear-gradient(135deg,#238636,#1f6feb);color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer">üñ®Ô∏è Print / Save PDF</button></div>
</body></html>`;
            const win = window.open('', '_blank');
            if (win) { win.document.write(html); win.document.close(); } else { alert('Popup blocked - please allow popups'); }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
